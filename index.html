<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="NexLog - A maior plataforma de E-COMMERCE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>NexLog | Sistema E-COMMERCE PROFISSIONAL</title>
    
    <link rel="manifest" id="dynamic-manifest">
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/PazChurchParaipaba/projetoentrega/refs/heads/main/logo.png"> 
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/PazChurchParaipaba/projetoentrega/refs/heads/main/logo.png">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           1. CSS GERAL E VARIÁVEIS
           ==========================================================================
        */
        svg {
            max-width: 100%;
            height: auto;
            min-width: 1em;
            min-height: 1em;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #eff6ff;
            --primary-fade: rgba(37, 99, 235, 0.1);
            --surface: #ffffff;
            --background: #f8fafc;
            --border: #e2e8f0;
            --divider: #cbd5e1;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --success: #10b981;
            --success-bg: #dcfce7;
            --success-dark: #047857;
            --warning: #f59e0b;
            --warning-bg: #fef3c7;
            --warning-dark: #b45309;
            --danger: #ef4444;
            --danger-bg: #fee2e2;
            --danger-dark: #b91c1c;
            --info: #0ea5e9;
            --info-bg: #e0f2fe;
            --info-dark: #0369a1;
            --comanda-livre: #22c55e;
            --comanda-aberta: #ef4444;
            --comanda-bloqueada: #6b7280;
            --comanda-em-uso: #3b82f6; 
            --comanda-avulso: #f97316;
            --comanda-fechada: #a855f7;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-float: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --nav-height: 70px;
            --mobile-nav-height: 65px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--background); color: var(--text-main); min-height: 100vh; padding-bottom: calc(var(--mobile-nav-height) + 20px); overflow-x: hidden; line-height: 1.5; -webkit-font-smoothing: antialiased; }

        h1, h2, h3, h4, h5, h6 { font-weight: 800; letter-spacing: -0.03em; line-height: 1.2; margin-bottom: 0.75rem; color: var(--text-main); }
        h1 { font-size: 2.25rem; } h2 { font-size: 1.875rem; } h3 { font-size: 1.5rem; } h4 { font-size: 1.25rem; } h5 { font-size: 1rem; }
        p { color: var(--text-muted); line-height: 1.6; margin-bottom: 1rem; font-size: 1rem; }
        .text-sm { font-size: 0.875rem; } .text-xs { font-size: 0.75rem; } .text-center { text-align: center; } .font-bold { font-weight: 700; } .text-primary { color: var(--primary); } .text-white { color: white; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.875rem 1.5rem; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: var(--transition); border: 1px solid transparent; outline: none; position: relative; overflow: hidden; text-decoration: none; user-select: none; width: 100%; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; filter: grayscale(1); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: var(--danger-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: var(--success-dark); }
        .btn-info { background: var(--info); color: white; }
        .btn-warning { background: var(--warning); color: #78350f; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; width: auto; }

        .input-wrapper { margin-bottom: 1.25rem; text-align: left; position: relative; }
        .input-wrapper label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        .input-field { width: 100%; padding: 0.875rem 1rem; border: 2px solid var(--border); border-radius: var(--radius-sm); background: white; font-size: 1rem; transition: var(--transition); font-family: inherit; color: var(--text-main); appearance: none; }
        .input-field::placeholder { color: #cbd5e1; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); outline: none; }
        select.input-field { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; background: #fff8f8; padding: 10px; border-radius: var(--radius-sm); border: 1px dashed var(--danger); }
        .checkbox-wrapper input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--danger); }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
        .card { background: var(--surface); border-radius: var(--radius-md); padding: 1.5rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm); transition: var(--transition); position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: #cbd5e1; }
        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 1.5rem; }
        @media (max-width: 600px) { .metrics-grid { grid-template-columns: 1fr; } }
        .metric-card { background: linear-gradient(135deg, var(--surface), var(--primary-light)); padding: 1.25rem; border-radius: var(--radius-md); border: 1px solid var(--border); text-align: center; }
        .metric-card h5 { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; margin-bottom: 5px; }
        .metric-card .value { color: var(--primary-dark); font-size: 1.5rem; font-weight: 800; }

        .badge { display: inline-flex; align-items: center; padding: 0.35rem 0.85rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .status-pendente { background: var(--warning-bg); color: var(--warning-dark); }
        .status-aceito { background: var(--info-bg); color: var(--info-dark); }
        .status-em_rota { background: #dbeafe; color: #1e40af; animation: pulse 2s infinite; }
        .status-concluido { background: var(--success-bg); color: var(--success-dark); }
        .badge-promo { background: var(--danger); color: white; position: absolute; top: 10px; left: 10px; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }

        header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding: 0 5%; height: var(--nav-height); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-sm); }
        .brand { display: flex; align-items: center; gap: 1rem; }
        .logo-img { height: 60px; width: auto; object-fit: contain; }
        .brand-text { font-size: 1.5rem; font-weight: 800; color: var(--primary); letter-spacing: -0.05em; }
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid var(--border); padding: 0.5rem 0; z-index: 90; justify-content: space-around; align-items: center; height: var(--mobile-nav-height); box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; font-size: 0.7rem; color: var(--text-muted); padding: 0.5rem; cursor: pointer; transition: var(--transition); background: none; border: none; }
        .nav-item.active { color: var(--primary); font-weight: 700; transform: translateY(-2px); }
        @media (max-width: 768px) { .bottom-nav { display: flex; } .desktop-only { display: none !important; } }

        .view-section { display: none; animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; -ms-overflow-style: none; white-space: nowrap; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-pill { padding: 8px 16px; background: white; border: 1px solid var(--border); border-radius: 99px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-sm); }
        .cat-pill:hover, .cat-pill.active { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-1px); box-shadow: var(--shadow-md); }

        .auth-card { max-width: 420px; margin: 3rem auto; text-align: center; padding: 2.5rem; }
        .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem; }
        .role-card { border: 2px solid var(--border); border-radius: var(--radius-md); padding: 1.5rem; cursor: pointer; transition: var(--transition); display: flex; flex-direction: column; align-items: center; gap: 0.5rem; background-color: white; }
        .role-card:hover { border-color: var(--primary); background: var(--primary-light); }
        .role-card.selected { border-color: var(--primary); background: #dbeafe; box-shadow: 0 0 0 2px var(--primary); }
        .role-card i { font-size: 2.5rem; color: var(--primary); margin-bottom: 0.5rem; }
        .camera-container { background: #000; border-radius: var(--radius-md); overflow: hidden; position: relative; aspect-ratio: 4/3; margin-bottom: 1rem; display: none; border: 2px solid var(--border); }
        .camera-container video { width: 100%; height: 100%; object-fit: cover; }
        .camera-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 1rem; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; text-align: center; font-weight: 600; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out; }
        .modal-content { background: white; width: 90%; max-width: 500px; border-radius: var(--radius-lg); overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; box-shadow: var(--shadow-float); animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background-color: #fcfcfc; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); background: white; }
        #map-modal .modal-content { height: 90%; }
        #map { flex: 1; width: 100%; background: #e2e8f0; min-height: 300px; z-index: 1; }

        .chat-messages { height: 300px; overflow-y: auto; border: 1px solid var(--border); background: #f9f9f9; padding: 15px; border-radius: var(--radius-sm); margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
        .chat-bubble { padding: 10px 14px; border-radius: 12px; max-width: 80%; font-size: 0.9rem; word-wrap: break-word; position: relative; }
        .chat-bubble.mine { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .chat-bubble.theirs { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: var(--text-main); border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-status { font-size: 0.7rem; text-align: right; margin-top: 5px; opacity: 0.7; display: flex; justify-content: flex-end; gap: 3px; }
        .chat-deleted { font-style: italic; color: #cbd5e1; font-size: 0.85rem; }
        .chat-edited-label { font-size: 0.7rem; margin-left: 5px; opacity: 0.6; }
        .chat-options-btn { background: transparent; border: none; color: inherit; cursor: pointer; opacity: 0.6; margin-left: 5px; }
        .chat-options-btn:hover { opacity: 1; }

        .comanda-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .comanda-card { border-radius: 12px; aspect-ratio: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-weight: bold; position: relative; cursor: pointer; transition: transform 0.2s; box-shadow: var(--shadow-sm); }
        .comanda-card:active { transform: scale(0.95); }
        .comanda-dot { width: 8px; height: 8px; background: white; border-radius: 50%; position: absolute; top: 8px; left: 8px; }
        .comanda-corner { width: 0; height: 0; border-style: solid; border-width: 25px 25px 0 0; border-color: rgba(255,255,255,0.3) transparent transparent transparent; position: absolute; top: 0; left: 0; border-top-left-radius: 12px; }
        .bg-livre { background-color: var(--comanda-livre); }
        .bg-aberta { background-color: var(--comanda-aberta); }
        .bg-bloqueada { background-color: var(--comanda-bloqueada); }
        .bg-comanda_aberta { background-color: var(--comanda-em-uso); }
        .bg-avulso { background-color: var(--comanda-avulso); }
        .bg-fechada { background-color: var(--comanda-fechada); }

        .cart-floater { position: fixed; bottom: 80px; left: 20px; background: var(--primary); color: white; padding: 12px 20px; border-radius: 50px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 990; display: none; align-items: center; gap: 10px; cursor: pointer; animation: slideInUp 0.3s; }
        @keyframes slideInUp { from { transform: translateY(100px); } to { transform: translateY(0); } }

        #store-notifications { position: fixed; bottom: 80px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1999; pointer-events: none; }
        .chat-alert-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); border-left: 5px solid var(--primary); width: 300px; pointer-events: auto; animation: slideInRight 0.3s forwards; display: flex; flex-direction: column; gap: 10px; }
        
        .chat-history-item { background: white; padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: var(--transition); }
        .chat-history-item:hover { background: var(--background); }
        .chat-user-info div:first-child { font-weight: bold; color: var(--text-main); }
        .chat-user-info div:last-child { font-size: 0.8rem; color: var(--text-muted); }

        .toast-container { position: fixed; bottom: 90px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: white; padding: 1rem 1.5rem; border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px; animation: slideInRight 0.3s forwards; pointer-events: auto; min-width: 300px; border-left: 5px solid var(--primary); font-weight: 500; }
        .toast.error { border-left-color: var(--danger); color: var(--danger-dark); }
        .toast.success { border-left-color: var(--success); color: var(--success-dark); }
        .toast.info { border-left-color: var(--info); color: var(--info-dark); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .pwa-banner { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: var(--text-main); color: white; padding: 1rem; border-radius: var(--radius-md); z-index: 999; display: none; align-items: center; justify-content: space-between; box-shadow: var(--shadow-lg); }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .secure-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 20px; border-radius: 8px; text-align: center; color: #166534; animation: fadeIn 0.5s; }
        #payment-brick_container { min-height: 300px; }
        
        /* ESTILO PARA GALERIA DE PRODUTOS */
        .product-gallery-wrapper {
            position: relative;
            width: 100%;
            height: 450px;
            background: #f1f5f9;
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            overflow: hidden;
        }

        .product-gallery {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            height: 100%;
            width: 100%;
            scrollbar-width: none;
        }

        .product-gallery::-webkit-scrollbar { display: none; }

        .gallery-img {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: top center;
            scroll-snap-align: start;
        }

        .gallery-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            pointer-events: none;
        }

        /* CORREÇÃO DE IMPRESSÃO - FORÇA O CONTEÚDO A APARECER */
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-area, #printable-area * {
                visibility: visible !important;
                display: block !important;
            }
            #printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 15px;
                background: white;
                color: black !important;
                font-family: 'Courier New', Courier, monospace; 
                z-index: 99999;
            }
            /* Esconde todo o resto */
            .modal-overlay, .cart-floater, #store-notifications, .pwa-banner, header, nav, .btn, .toast-container {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>
    
    <div id="store-notifications"></div>
    <div id="cart-floater" class="cart-floater" onclick="App.cart.open()">
        <i class="ri-shopping-cart-2-line"></i>
        <span id="cart-count">0 itens</span> | <span id="cart-total">R$ 0,00</span>
    </div>

    <div id="pwa-banner" class="pwa-banner">
        <div style="display:flex; align-items:center; gap:12px;">
            <i class="ri-download-cloud-2-line" style="font-size:1.5rem"></i>
            <div>
                <div style="font-weight:bold">Instalar NexLog</div>
                <div style="font-size:0.8rem; opacity:0.8">Acesso rápido na tela inicial</div>
            </div>
        </div>
        <button class="btn btn-sm btn-primary" onclick="App.pwa.install()">Instalar</button>
    </div>

    <header>
        <div class="brand">
            <img src="https://raw.githubusercontent.com/PazChurchParaipaba/projetoentrega/refs/heads/main/logo.png" alt="NexLog Logo" class="logo-img" onerror="this.style.display='none'; document.getElementById('txt-logo').style.display='block'">
            <span id="txt-logo" class="brand-text" style="display:none;">NexLog</span>
        </div>
        <div id="header-actions" class="text-sm font-bold text-primary desktop-only"></div>
    </header>

    <main>
        
        <section id="view-home" class="view-section active">
            <div style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 5px 0; position:sticky; top:70px; z-index:90; border-bottom:1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                <div class="container" style="padding-top: 10px; padding-bottom: 0;">
                    <div class="category-scroll" id="category-list">
                        <button class="cat-pill active" onclick="App.catalog.filter('Todos', this)">Todos</button>
                    </div>
                </div>
            </div>

            <div class="container">
                <div style="margin-bottom: 2rem; text-align: center;">
                    <h1 style="font-size: 2rem;">Encontre o que você precisa na palma da sua mão</h1>
                    <p>Programado para o que você precisar.</p>
                </div>
                
                <div id="public-catalog" class="grid grid-3">
                    <div class="card" style="text-align:center; padding:4rem;">
                        <i class="ri-loader-4-line spin" style="font-size:2.5rem; color:var(--primary)"></i>
                        <p style="margin-top:1rem;">Carregando ofertas...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-auth" class="view-section container">
            <div class="card auth-card">
                
                <div id="auth-state-login">
                    <div style="margin-bottom: 2rem;">
                        <h2 style="color:var(--primary); margin-bottom:0.5rem;">Bem-vindo</h2>
                        <p>Entre para gerenciar seus pedidos e serviços</p>
                    </div>
                    
                    <div class="input-wrapper">
                        <label>Endereço de Email</label>
                        <input type="email" id="login-email" class="input-field" placeholder="seu@email.com">
                    </div>
                    <div class="input-wrapper">
                        <label>Sua Senha</label>
                        <input type="password" id="login-pass" class="input-field" placeholder="••••••">
                    </div>
                    
                    <button class="btn btn-primary btn-full" onclick="App.auth.login()">Entrar no Sistema</button>
                    
                    <div style="margin-top:1rem;">
                        <button class="btn btn-sm btn-secondary" onclick="App.auth.switchView('recover')">Esqueci minha senha</button>
                    </div>

                    <div style="margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border);">
                        <p class="text-xs">Não possui conta?</p>
                        <button class="btn btn-secondary btn-full" onclick="App.auth.switchView('roles')">Criar Nova Conta</button>
                    </div>
                </div>

                <div id="auth-state-recover" style="display:none;">
                    <h3>Recuperação de Senha</h3>
                    <p>Informe seus dados para validar sua identidade.</p>
                    
                    <div class="input-wrapper">
                        <label>Email Cadastrado</label>
                        <input type="email" id="rec-email" class="input-field" placeholder="seu@email.com">
                    </div>
                    <div class="input-wrapper">
                        <label>CPF (Validação de Segurança)</label>
                        <input type="text" id="rec-cpf" class="input-field" placeholder="000.000.000-00">
                    </div>
                    
                    <button class="btn btn-primary btn-full" onclick="App.auth.recoverPassword()">Enviar Email de Recuperação</button>
                    <button class="btn btn-secondary btn-full" style="margin-top:0.5rem" onclick="App.auth.switchView('login')">Voltar</button>
                </div>
                
                <div id="auth-state-roles" style="display:none;">
                    <h3>Qual o seu perfil?</h3>
                    <p>Selecione como deseja usar a plataforma NexLog</p>
                    <div class="role-grid">
                        <div class="role-card" onclick="App.auth.startReg('cliente')">
                            <i class="ri-user-smile-line"></i>
                            <span class="font-bold">Sou Cliente</span>
                        </div>
                        <div class="role-card" onclick="App.auth.startReg('loja_admin')">
                            <i class="ri-store-2-line"></i>
                            <span class="font-bold">Sou Lojista</span>
                        </div>
                        <div class="role-card" onclick="App.auth.startReg('motorista')">
                            <i class="ri-truck-line"></i>
                            <span class="font-bold">Sou Motorista</span>
                        </div>
                        <div class="role-card" onclick="App.auth.startReg('montador')">
                            <i class="ri-tools-line"></i>
                            <span class="font-bold">Sou Prestador</span>
                        </div>
                        <div class="role-card" onclick="App.auth.startReg('garcom')">
                            <i class="ri-restaurant-line"></i>
                            <span class="font-bold">Sou Garçom</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-full" style="margin-top:2rem" onclick="App.auth.switchView('login')">Voltar ao Login</button>
                </div>

                <div id="auth-state-register" style="display:none;">
                    <h3 id="reg-title">Cadastro</h3>
                    <p>Preencha seus dados para continuar</p>
                    
                    <div class="input-wrapper">
                        <label>Nome Completo</label>
                        <input type="text" id="reg-name" class="input-field" placeholder="Seu nome">
                    </div>
                    <div class="input-wrapper">
                        <label>Email</label>
                        <input type="email" id="reg-email" class="input-field" placeholder="seu@email.com">
                    </div>
                    <div class="input-wrapper">
                        <label>Senha</label>
                        <input type="password" id="reg-pass" class="input-field" placeholder="••••••">
                    </div>
                    
                    <div id="reg-dynamic-fields"></div>
                    
                    <button class="btn btn-primary btn-full" onclick="App.auth.register()" id="btn-final-reg" style="margin-top:1rem;">Finalizar Cadastro</button>
                    <button class="btn btn-secondary btn-full" style="margin-top:0.5rem" onclick="App.auth.switchView('roles')">Voltar</button>
                </div>
            </div>
        </section>

        <section id="view-loja" class="view-section container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <div>
                    <h2>Painel da Loja</h2>
                    <p>Gestão completa do seu negócio</p>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-secondary btn-sm" onclick="App.store.setupPrinter()">
                        <i class="ri-printer-line"></i> Impressora
                    </button>
                    <button class="btn btn-primary" onclick="App.store.openProductModal()">
                        <i class="ri-add-line"></i> Novo Serviço
                    </button>
                </div>
            </div>

           <div id="admin-restaurant-panel" style="display:none; margin-bottom: 2rem; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
                <h4>Gestão de Salão (Restaurante)</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div class="input-wrapper" style="margin-bottom:0; flex:1;">
                        <input type="number" id="comanda-start" class="input-field" placeholder="Início">
                    </div>
                    <div class="input-wrapper" style="margin-bottom:0; flex:1;">
                        <input type="number" id="comanda-end" class="input-field" placeholder="Fim">
                    </div>
                    <button class="btn btn-primary btn-sm" style="width: auto;" onclick="App.admin.createComandas()">Gerar Comandas</button>
                </div>
                <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                    <h5>Cadastrar Equipe</h5>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                        <div class="input-wrapper" style="margin-bottom:0; flex:1; min-width: 200px;">
                            <label class="text-xs">Nome</label>
                            <input id="staff-name" class="input-field">
                        </div>
                        <div class="input-wrapper" style="margin-bottom:0; flex:1; min-width: 200px;">
                            <label class="text-xs">Email Login</label>
                            <input id="staff-email" type="email" class="input-field">
                        </div>
                        <div class="input-wrapper" style="margin-bottom:0; flex:1; min-width: 150px;">
                            <label class="text-xs">Senha</label>
                            <input id="staff-pass" type="password" class="input-field">
                        </div>
                        <div class="input-wrapper" style="margin-bottom:0; flex:1; min-width: 120px;">
                            <label class="text-xs">Cargo</label>
                            <select id="staff-role" class="input-field">
                                <option value="garcom">Garçom</option>
                                <option value="cumim">Cumim</option>
                            </select>
                        </div>
                        <div class="input-wrapper" style="margin-bottom:0; flex:1; min-width: 100px;">
                            <label class="text-xs">Taxa %</label>
                            <input id="staff-rate" type="number" class="input-field" value="10">
                        </div>
                        <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                       <h5>Histórico de Mesas Fechadas</h5>
                          <div style="display: flex; gap: 10px; align-items: center;">
                              <input type="date" id="history-date" class="input-field" style="max-width: 200px;">
                                <button class="btn btn-secondary btn-sm" style="width: auto;" onclick="App.store.filterHistory()">Filtrar</button>
                                        </div>
                                              <div id="history-results" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
                                       </div>
                        <button class="btn btn-success btn-sm" style="width: auto; height: 46px;" onclick="App.admin.registerStaff()">Cadastrar</button>
                    </div>
                </div>
            </div>

            <h4>Visão Geral do Salão</h4>
            <div id="admin-comanda-grid" class="comanda-grid" style="margin-bottom: 2rem;">
                </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h5>Vendas Hoje</h5>
                    <div id="metric-day" class="value">R$ 0,00</div>
                </div>
                <div class="metric-card">
                    <h5>Vendas na Semana</h5>
                    <div id="metric-week" class="value">R$ 0,00</div>
                </div>
                <div class="metric-card">
                    <h5>Vendas no Mês</h5>
                    <div id="metric-month" class="value">R$ 0,00</div>
                </div>
            </div>

            <div class="grid grid-2">
                <div>
                    <div class="card" style="border-left: 5px solid var(--success);">
                        <h4><i class="ri-bank-card-line"></i> Recebimento Automático</h4>
                        
                        <div id="store-keys-area">
                            <p class="text-sm">
                                Para o dinheiro cair direto na sua conta, cole suas chaves de <strong>Produção</strong> do Mercado Pago.
                                <a href="https://www.mercadopago.com.br/developers/panel" target="_blank" style="color:var(--primary)">Pegar minhas chaves</a>.
                            </p>
                            <div class="input-wrapper">
                                <label>Public Key</label>
                                <input type="text" id="store-public-key" class="input-field" placeholder="APP_USR-...">
                            </div>
                            <div class="input-wrapper">
                                <label>Access Token</label>
                                <input type="password" id="store-access-token" class="input-field" placeholder="APP_USR-...">
                            </div>
                            <button class="btn btn-success btn-sm" onclick="App.store.saveCredentials()">Salvar e Ativar</button>
                        </div>
                        <div class="card" style="border-left: 5px solid #8b5cf6; margin-top: 1.5rem;">
    <h4><i class="ri-truck-line"></i> Configuração de Entrega/Retirada</h4>
    <p class="text-sm">Defina seu endereço para retirada e o valor padrão da entrega.</p>
    
    <div class="input-wrapper">
        <label>Endereço para Retirada (Sua Loja/Casa)</label>
        <input type="text" id="store-pickup-address" class="input-field" placeholder="Ex: Rua das Flores, 123 - Centro">
    </div>

    <div class="input-wrapper">
        <label>Taxa de Entrega Padrão (R$)</label>
        <input type="number" id="store-delivery-fee" class="input-field" placeholder="0.00">
    </div>

    <button class="btn btn-sm" style="background:#8b5cf6; color:white;" onclick="App.store.saveLogistics()">Salvar Configurações</button>
</div>
                        <div class="card" style="border-left: 5px solid #be185d; margin-top: 1.5rem;">
                           <h4><i class="ri-ticket-line"></i> Criar Cupom (Roupas)</h4>
                           <p class="text-sm">Gere descontos exclusivos para produtos da categoria Roupas.</p>
                             <div style="display:flex; gap:10px; align-items:flex-end;">
                                <div class="input-wrapper" style="margin-bottom:0; flex:2;">
                                    <label class="text-xs">Código do Cupom</label>
                                 <input id="new-coupon-code" class="input-field" placeholder="Ex: VERAO10" style="text-transform:uppercase;">
                                 </div>
                                    <div class="input-wrapper" style="margin-bottom:0; flex:1;">
                                           <label class="text-xs">% Desconto</label>
                                            <input type="number" id="new-coupon-percent" class="input-field" placeholder="10">
                                           </div>
                                 <button class="btn btn-sm" style="background:#be185d; color:white; height:46px;" onclick="App.store.createCoupon()">Criar</button>
                                       </div>
                               <div id="coupon-list-display" style="margin-top:15px; max-height:100px; overflow-y:auto;"></div>
                                </div>
                        
                        <div id="store-keys-locked" style="display:none;" class="secure-box">
                            <i class="ri-shield-check-line" style="font-size:2.5rem; margin-bottom:10px;"></i><br>
                            <strong>Pagamentos Ativos</strong><br>
                            <span class="text-sm">Suas chaves estão configuradas e ocultas por segurança. O split de pagamento está funcionando.</span><br>
                            <button class="btn btn-secondary btn-sm" style="margin-top:15px; width:auto;" onclick="App.store.resetKeys()">Redefinir Chaves</button>
                        </div>
                    </div>

                    <div class="card" style="border-left: 5px solid var(--info); margin-top: 1.5rem;">
                        <h4><i class="ri-team-line"></i> Parceiro Exclusivo</h4>
                        <p class="text-sm">Vincule um motorista ou montador pelo email. Seus serviços aparecerão <strong>apenas</strong> para ele.</p>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input id="partner-email-input" class="input-field" placeholder="Email do parceiro cadastrado">
                            <button class="btn btn-info btn-sm" style="width:auto;" onclick="App.store.linkPartner()">Vincular</button>
                        </div>
                        <div id="active-partner-display" style="font-weight:bold; color:var(--info-dark); font-size:0.9rem; margin-top:5px;"></div>
                    </div>
                </div>

                <div>
                    <div class="card" style="margin-bottom:1.5rem; border-color:var(--info);">
                        <h4 style="color:var(--info-dark)"><i class="ri-chat-history-line"></i> Minhas Conversas</h4>
                        <div id="store-chat-list" style="max-height: 250px; overflow-y: auto;">
                            <p class="text-sm text-muted">Carregando conversas...</p>
                        </div>
                    </div>

                    <div class="card">
                        <h4 style="margin-bottom:1rem; color:var(--primary)">Pedidos em Aberto</h4>
                        <div id="store-orders-list">
                            <p class="text-sm">Carregando...</p>
                        </div>
                    </div>
                    <div class="card" style="margin-top:1.5rem;">
                        <h4 style="color:var(--text-muted)">Meus Produtos / Serviços</h4>
                        <div id="store-products-list" style="max-height: 300px; overflow-y: auto;">
                            </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-cliente" class="view-section container">
            <div style="margin-bottom:2rem;">
                <h2>Meus Pedidos</h2>
                <p>Acompanhe suas compras e serviços contratados</p>
                <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <strong>Estou na Mesa?</strong>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <input type="number" id="client-table-check" class="input-field" placeholder="Nº da Mesa">
                        <button class="btn btn-primary btn-sm" style="width:auto;" onclick="App.client.checkTableBill()">Ver Conta</button>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-bottom:2rem; border-color:var(--info);">
                <h4 style="color:var(--info-dark)"><i class="ri-chat-history-line"></i> Minhas Conversas</h4>
                <div id="client-chat-list" class="grid grid-2">
                    <p class="text-sm text-muted">Carregando conversas...</p>
                </div>
            </div>

            <div id="client-orders-list" class="grid grid-2"></div>
            <div style="margin-top:3rem; text-align:center;">
                <button class="btn btn-secondary" onclick="App.router.go('home')">
                    <i class="ri-search-line"></i> Voltar ao Catálogo
                </button>
            </div>
        </section>

        <section id="view-provider" class="view-section container">
            <div class="card" style="background:var(--text-main); color:white; margin-bottom:2rem; border:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="color:white; margin-bottom:0.2rem;">Painel de Serviços</h3>
                        <p style="color:rgba(255,255,255,0.7); margin:0;" id="provider-role-label">Parceiro</p>
                    </div>
                    <div class="badge status-aceito"><i class="ri-wifi-line"></i> Online</div>
                </div>
                
                <hr style="border-color:rgba(255,255,255,0.1); margin:15px 0;">
                
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <span class="text-xs" style="opacity:0.7">Sua Chave Pix (Para Receber Comissão):</span><br>
                        <strong id="provider-pix-display" style="font-family:monospace; font-size:1.1rem;">Não cadastrada</strong>
                    </div>
                    <button class="btn btn-sm btn-secondary" style="width:auto; padding:5px 10px;" onclick="App.provider.updatePix()">Alterar</button>
                </div>
            </div>

            <h3>Oportunidades Disponíveis</h3>
            <p class="text-sm text-muted">Serviços próximos ou exclusivos para você.</p>
            <div id="provider-jobs-list" class="grid grid-2"></div>
        </section>

        <section id="view-waiter" class="view-section container">
             <div style="margin-bottom:2rem; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2>Painel do Garçom</h2>
                    <p>Gerencie pedidos e comandas</p>
                </div>
                 <button class="btn btn-danger btn-sm" style="width:auto;" onclick="App.auth.logout()">Sair</button>
            </div>

            <div id="comanda-list-container" class="comanda-grid"></div>
        </section>
    </main>
    
    <div id="printable-area" style="display:none;"></div>
    <nav class="bottom-nav" id="mobile-nav"></nav>

    <div id="map-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3>Navegação GPS</h3>
                    <p id="map-dest-address" class="text-xs text-muted" style="margin:0;"></p>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="App.map.close()">Fechar</button>
            </div>
            <div id="map"></div>
            <div class="modal-footer" id="map-footer">
                <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
                    <div class="badge status-aceito" id="map-status-badge">Conectado</div>
                    <p style="margin:0; font-size:0.9rem;" id="map-status-text">Aguardando dados...</p>
                </div>
                <button id="btn-start-gps" class="btn btn-success btn-full" style="margin-top:1rem; display:none;" onclick="App.map.startGPS()">
                    <i class="ri-navigation-line"></i> Iniciar Rota
                </button>
                 <button id="btn-end-gps" class="btn btn-danger btn-full" style="margin-top:1rem; display:none;" onclick="App.map.finishDelivery()">
                    <i class="ri-flag-line"></i> Finalizar Entrega
                </button>
            </div>
        </div>
    </div>

    <div id="budget-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Calculadora de Orçamento</h3>
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('budget-modal').style.display='none'">Fechar</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="budget-prod-id">
                <input type="hidden" id="budget-store-id">
                <input type="hidden" id="budget-base-price"> 
                <input type="hidden" id="budget-labor-val"> 
                <input type="hidden" id="budget-labor-type"> 
                <div class="input-wrapper">
                    <label>Metragem da Área (m²)</label>
                    <input type="number" id="budget-area" class="input-field" placeholder="Ex: 25" oninput="App.client.calculateBudget()">
                </div>
                
                <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-top:10px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Custo Material:</span>
                        <span id="display-material">R$ 0,00</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:var(--info-dark);">
                        <span>Custo Mão de Obra:</span>
                        <span id="display-labor">R$ 0,00</span>
                    </div>
                    <hr style="margin:10px 0; border-color:#e2e8f0;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem; color:var(--primary);">
                        <span>Total Orçado:</span>
                        <span id="display-total">R$ 0,00</span>
                    </div>
                    <p class="text-xs text-muted" style="margin-top:10px; text-align:center;">
                        *Pagamento: 50% de entrada e 50% na finalização.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success btn-full" onclick="App.client.finishBudgetOrder()">Pagar Sinal (50%)</button>
            </div>
        </div>
    </div>

    <div id="product-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="prod-modal-title">Adicionar Serviço/Produto</h3>
                <button class="btn btn-secondary btn-sm" onclick="App.store.closeProductModal()">Fechar</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-prod-id">
                <div class="input-wrapper">
                    <label>Categoria/Setor</label>
                    <select id="new-prod-cat" class="input-field" onchange="App.store.checkCategory(this.value)">
                        </select>
                </div>
                
                <div id="hotel-dates-area" style="display:none; background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:1rem;">
                    <h5 style="color:var(--info-dark)">Disponibilidade de Reserva</h5>
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1">
                            <label class="text-xs">Início</label>
                            <input type="date" id="hotel-start-date" class="input-field">
                        </div>
                        <div style="flex:1">
                            <label class="text-xs">Fim</label>
                            <input type="date" id="hotel-end-date" class="input-field">
                        </div>
                    </div>
                </div>

                <div id="gesso-options-area" style="display:none; background:#fefce8; padding:15px; border-radius:8px; border:1px solid #fde047; margin-bottom:1rem;">
                    <h5 style="color:var(--warning-dark)">Configuração de Orçamento (Gesso)</h5>
                    <div class="input-wrapper">
                        <label>Preço do Metro Quadrado (Material)</label>
                        <input type="number" id="gesso-price-m2" class="input-field" placeholder="0.00">
                    </div>
                    <div class="input-wrapper">
                        <label>Valor da Mão de Obra</label>
                        <input type="number" id="gesso-labor-val" class="input-field" placeholder="0.00">
                    </div>
                    <div class="input-wrapper">
                        <label>Tipo de Cobrança da Mão de Obra</label>
                        <select id="gesso-labor-type" class="input-field">
                            <option value="fixed">Valor Fixo (R$ por m²)</option>
                            <option value="percent">Porcentagem (%) sobre o Material</option>
                        </select>
                    </div>
                </div>

                <div id="delivery-options-area" style="display:none; background:#f0fdf4; padding:15px; border-radius:8px; border:1px solid #bbf7d0; margin-bottom:1rem;">
                    <h5 style="color:var(--success-dark)">Configuração de Entrega</h5>
                    <div class="input-wrapper">
                        <label>Taxa de Entrega (Opcional)</label>
                        <input type="number" id="delivery-fee-val" class="input-field" placeholder="0.00">
                    </div>
                    <div class="input-wrapper">
                        <label>Tipo da Taxa</label>
                        <select id="delivery-fee-type" class="input-field">
                            <option value="fixed">Valor Fixo (R$)</option>
                            <option value="percent">Porcentagem (%)</option>
                        </select>
                    </div>
                </div>
                <div id="clothing-options-area" style="display:none; background:#fdf2f8; padding:15px; border-radius:8px; border:1px solid #fbcfe8; margin-bottom:1rem;">
                        <h5 style="color:#be185d">Detalhes da Peça (Roupas)</h5>
                          <div class="input-wrapper">
                            <label>Tamanhos Disponíveis (Separe por vírgula)</label>
        <input type="text" id="clothing-sizes" class="input-field" placeholder="Ex: P, M, G, GG, 38, 40">
    </div>
</div>

<div class="input-wrapper">
    <label>Descrição do Produto</label>
    <textarea id="new-prod-desc" class="input-field" rows="3" placeholder="Detalhes do tecido, medidas, estado de conservação..."></textarea>
</div>

                <div class="input-wrapper">
                    <label>Nome do Item</label>
                    <input type="text" id="new-prod-name" class="input-field" placeholder="Ex: Camiseta">
                </div>
                <div class="input-wrapper">
                    <label>Preço Base</label>
                    <input type="number" id="new-prod-price" class="input-field" placeholder="0.00">
                </div>
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="new-prod-promo">
                    <label for="new-prod-promo" style="margin:0; cursor:pointer; color:var(--danger-dark); font-weight:bold;">Colocar em Promoção?</label>
                </div>

                <div class="input-wrapper">
                    <label>Fotos (Pode selecionar várias)</label>
                    <input type="file" id="new-prod-file" class="input-field" accept="image/*" multiple>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-full" onclick="App.store.submitProduct()" id="btn-save-prod">Publicar Serviço</button>
            </div>
        </div>
    </div>
    
    <div id="chat-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chat</h3>
                <button class="btn btn-secondary btn-sm" onclick="App.chat.close()">Fechar</button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-muted">Converse diretamente com o estabelecimento/cliente.</p>
                <div id="chat-msgs" class="chat-messages">
                    <div style="text-align:center; padding:20px; color:#aaa;">Carregando mensagens...</div>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="chat-input" class="input-field" placeholder="Digite sua mensagem..." autocomplete="off">
                    <button class="btn btn-secondary btn-sm" style="width:auto" onclick="App.chat.recordAudio()" title="Gravar Áudio"><i class="ri-mic-line"></i></button>
                    <button class="btn btn-primary btn-sm" style="width:auto" onclick="App.chat.send()">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="split-pay-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Fechamento de Conta</h3>
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('split-pay-modal').style.display='none'">Fechar</button>
            </div>
            <div class="modal-body">
                <h2 id="split-total-due" style="text-align:center; color:var(--primary); margin-bottom:20px;">R$ 0,00</h2>
                
                <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:15px;">
                    <div class="input-wrapper" style="margin-bottom:5px;">
                        <label>Valor a Pagar Agora</label>
                        <input type="number" id="split-amount" class="input-field">
                    </div>
                    <div class="input-wrapper">
                        <label>Forma de Pagamento</label>
                        <select id="split-method" class="input-field" onchange="App.payment.toggleCardFields()">
                            <option value="dinheiro">Dinheiro</option>
                            <option value="cartao">Cartão (Crédito/Débito)</option>
                            <option value="pix">Pix</option>
                        </select>
                    </div>
                    <div id="card-fields" style="display:none; gap:10px;">
                         <input type="text" id="card-nsu" class="input-field" placeholder="NSU" style="flex:1">
                         <input type="text" id="card-aut" class="input-field" placeholder="AUT" style="flex:1">
                    </div>
                    <button class="btn btn-primary btn-sm btn-full" style="margin-top:10px;" onclick="App.payment.addSplit()">Lançar Pagamento</button>
                </div>

                <h5>Histórico</h5>
                <div id="split-history" style="font-size:0.85rem; color:var(--text-muted);"></div>
                <div style="text-align:right; margin-top:10px; font-weight:bold; color:var(--danger);">Restante: <span id="split-remaining">R$ 0,00</span></div>
            </div>
            <div class="modal-footer">
                <button id="btn-finish-split" class="btn btn-success btn-full" disabled onclick="App.payment.finalizeSplit()">Fechar Conta</button>
            </div>
        </div>
    </div>

    <div id="comanda-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h3 id="comanda-title">Mesa 1</h3>
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('comanda-modal').style.display='none'">Fechar</button>
            </div>
            <div class="modal-body">
                <div class="input-wrapper">
                    <label>Adicionar Produto</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="waiter-prod-search" class="input-field" placeholder="Busque o produto...">
                        <button class="btn btn-primary btn-sm" style="width:auto;" onclick="App.waiter.addItem()">Add</button>
                    </div>
                    <div id="waiter-search-results" style="border:1px solid #eee; max-height:150px; overflow-y:auto; display:none;"></div>
                </div>

                <h5>Itens do Pedido</h5>
                <div id="comanda-items-list" style="border:1px solid #eee; padding:10px; min-height:100px; margin-bottom:1rem;">
                    <p class="text-sm text-muted">Nenhum item adicionado.</p>
                </div>
            </div>
            <div class="modal-footer">
                <div style="display:flex; gap:10px;">
                     <button class="btn btn-secondary" onclick="App.waiter.printBill()">Imprimir Conta</button>
                     <button class="btn btn-success" onclick="App.waiter.sendToKitchen()">Enviar para Cozinha</button>
                </div>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pagamento Seguro</h3>
                <button class="btn btn-secondary btn-sm" onclick="App.payment.close()">Cancelar</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:1.5rem; background: var(--info-bg); padding: 1rem; border-radius: var(--radius-sm);">
                    <p style="color:var(--info-dark); margin-bottom:0.5rem;">Total a pagar:</p>
                    <h2 id="pay-total-display" style="color:var(--primary); font-size:2.5rem; margin-bottom:0;">R$ 0,00</h2>
                    <p class="text-xs text-muted" id="pay-detail-display" style="margin-top:0.5rem;">Segurança Mercado Pago</p>
                </div>
                
                <div id="payment-brick_container"></div>
            </div>
        </div>
    </div>
    
    <div id="cart-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Carrinho de Compras</h3>
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('cart-modal').style.display='none'">Fechar</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom:15px; padding:10px; border:1px dashed #cbd5e1; border-radius:8px;">
                    <label style="font-weight:bold; font-size:0.9rem; display:block; margin-bottom:5px;">Forma de Entrega:</label>
                    
                    <div style="display:flex; gap:15px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <input type="radio" name="delivery-method" id="method-delivery" value="entrega" checked onchange="App.cart.toggleAddressField()">
                            <label for="method-delivery" class="text-sm">Entrega (+<span id="label-delivery-fee">R$ 0,00</span>)</label>
                        </div>
                        
                        <div style="display:flex; align-items:center; gap:5px;">
                            <input type="radio" name="delivery-method" id="method-pickup" value="retirada" onchange="App.cart.toggleAddressField()">
                            <label for="method-pickup" class="text-sm">Retirada (Grátis)</label>
                        </div>
                    </div>
                    
                    <div id="pickup-info-display" style="display:none; margin-top:8px; font-size:0.8rem; color:#8b5cf6; background:#f3e8ff; padding:5px; border-radius:4px;">
                        <strong>Retirar em:</strong> <span id="txt-pickup-addr">...</span>
                    </div>
                </div>

                <div id="delivery-address-container" style="margin-bottom:15px;">
                    <label class="text-sm font-bold">Endereço de Entrega:</label>
                    <textarea id="cart-delivery-address" class="input-field" rows="2" placeholder="Rua, Número, Bairro, Ponto de Referência..."></textarea>
                </div>

                <div id="cart-items-list" style="margin-bottom: 1rem;"></div>

                <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-top:10px; text-align:right;">
                    <div style="margin-top:10px; display:flex; gap:5px;">
                       <input type="text" id="cart-coupon-input" class="input-field" placeholder="Cupom de desconto" style="text-transform:uppercase;">
                          <button class="btn btn-secondary btn-sm" style="width:auto;" onclick="App.cart.applyCoupon()">Aplicar</button>
                    </div>
                      <div id="coupon-msg" class="text-xs" style="margin-bottom:10px;"></div>
                    <strong>Total: <span id="cart-total-modal">R$ 0,00</span></strong>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-success btn-full" onclick="App.cart.checkout()">Finalizar Compra</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            sbUrl: 'https://groezaseypdbpgymgpvo.supabase.co',
            sbKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdyb2V6YXNleXBkYnBneW1ncHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNjkxNjYsImV4cCI6MjA4MTY0NTE2Nn0.5U5QeoGmZn_i9Y8POoUCkatBUAdSW-cjHRyfxpm_pyM',
            adminPublicKey: 'APP_USR-834374cc-7e6d-494f-9842-49a7e3e57357',
            mapboxToken: 'pk.eyJ1IjoiZXhhbXBsZXVzZXIiLCJhIjoiY2p5Y3Z6eG9jMDFlazNnbzQ4a3R4bWk4ZyJ9.ExampleTokenPlaceholder',
            categories: ['Comidas', 'Bebidas', 'Roupas', 'Serviços de Gesso', 'Hoteis/Pousadas', 'Manutenção Eletrodomésticos', 'Serviços de Manutenção', 'Serviços de Pedreiros', 'Serviços de Pintores', 'Materiais de Construção', 'Eletrodomésticos', 'Fretes e Mudanças', 'Jardinagem', 'Outros']
        };
        const _sb = supabase.createClient(CONFIG.sbUrl, CONFIG.sbKey);
        let mpInstance = null;

        const App = {
            state: { 
                user: null, 
                profile: null, 
                tempRole: null, 
                deferredPrompt: null, 
                mapInstance: null, 
                marker: null, 
                watchId: null, 
                activeOrder: null, 
                storeId: null, 
                pendingPayment: null, 
                brickController: null, 
                pixInterval: null, 
                activeChatStore: null, 
                activeChatClient: null,
                chatSub: null,
                currentBudgetTotal: 0,
                mediaRecorder: null,
                audioChunks: [],
                cart: [], 
                currentComanda: null, 
                paymentSplits: [], 
                comandaTotal: 0,
                currentComandaItems: [],
                currentMesaNum: null
            },
            
            init: async () => {
                App.utils.setupPWA();
                App.utils.setupCategories();
                const savedUser = localStorage.getItem('logimoveis_session');
                if(savedUser) {
                    const profile = JSON.parse(savedUser);
                    App.state.user = { id: profile.id };
                    App.state.profile = profile;
                    App.router.renderNav();
                    App.router.goDashboard();
                } else {
                    App.router.renderNav();
                    App.catalog.fetchPublic();
                }
            },
            pwa: {
                install: () => {
                    if (App.state.deferredPrompt) {
                        App.state.deferredPrompt.prompt();
                        App.state.deferredPrompt.userChoice.then(() => {
                            App.state.deferredPrompt = null;
                            document.getElementById('pwa-banner').style.display = 'none';
                        });
                    }
                }
            },
            router: {
                go: (viewId) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                    document.getElementById(`view-${viewId}`).classList.add('active');
                    window.scrollTo(0,0);
                    App.router.renderNav();
                    if(viewId === 'home') App.catalog.fetchPublic();
                },
                renderNav: () => {
                    const header = document.getElementById('header-actions');
                    const mobile = document.getElementById('mobile-nav');
                    if(App.state.user && App.state.profile) {
                        header.innerHTML = `<div style="display:flex; align-items:center; gap:1rem;"><div class="text-xs text-muted desktop-only">${App.state.profile.nome_completo.split(' ')[0]}</div><button class="btn btn-secondary btn-sm" onclick="App.router.goDashboard()">Painel</button><button class="btn btn-danger btn-sm" onclick="App.auth.logout()">Sair</button></div>`;
                        mobile.innerHTML = `<div class="nav-item" onclick="App.router.go('home')"><i class="ri-store-line"></i><span>Loja</span></div><div class="nav-item active" onclick="App.router.goDashboard()"><i class="ri-dashboard-line"></i><span>Painel</span></div><div class="nav-item" onclick="App.auth.logout()"><i class="ri-logout-box-line"></i><span>Sair</span></div>`;
                    } else {
                        header.innerHTML = `<button class="btn btn-primary btn-sm" onclick="App.router.go('auth')">Entrar / Cadastrar</button>`;
                        mobile.innerHTML = `<div class="nav-item active" onclick="App.router.go('home')"><i class="ri-store-line"></i><span>Início</span></div><div class="nav-item" onclick="App.router.go('auth')"><i class="ri-user-line"></i><span>Conta</span></div>`;
                    }
                },
                goDashboard: () => {
                    const role = App.state.profile?.role;
                    if(role === 'loja_admin') { App.store.init(); App.router.go('loja'); }
                    else if(role === 'cliente') { App.client.init(); App.router.go('cliente'); }
                    else if(role === 'garcom') { App.waiter.init(); App.router.go('waiter'); }
                    else { App.provider.init(); App.router.go('provider'); }
                }
            },
            auth: {
                switchView: (view) => {
                    ['login', 'roles', 'register', 'recover'].forEach(v => document.getElementById(`auth-state-${v}`).style.display = 'none');
                    document.getElementById(`auth-state-${view}`).style.display = 'block';
                },
                startReg: (role) => {
                    App.state.tempRole = role;
                    document.getElementById('reg-title').innerText = `Cadastro - ${role === 'loja_admin' ? 'Lojista' : role.toUpperCase()}`;
                    App.auth.switchView('register');
                    const container = document.getElementById('reg-dynamic-fields');
                    let html = '';
                    if(role === 'loja_admin') {
                        html = `<div class="input-wrapper"><label>Nome da Loja</label><input id="reg-store-name" class="input-field" placeholder="Ex: NexLog Center"></div><div class="input-wrapper"><label>WhatsApp da Loja</label><input id="reg-whatsapp" class="input-field" placeholder="(00) 00000-0000"></div><div class="input-wrapper"><label>CNPJ</label><input id="reg-cnpj" class="input-field" placeholder="00.000.000/0000-00"></div><div class="input-wrapper" style="border: 2px dashed var(--primary); padding: 10px; border-radius: 8px; background: var(--info-bg);"><label style="color:var(--primary)">🔑 Token de Autorização</label><input id="reg-token" class="input-field" placeholder="Código fornecido pelo Admin"><p class="text-xs text-muted">Cadastro restrito. Insira sua matrícula/token.</p></div>`;
                    } else if (role === 'motorista' || role === 'montador') {
                        html = `<div class="input-wrapper"><label>CPF</label><input id="reg-cpf" class="input-field" placeholder="000.000.000-00"></div><div class="input-wrapper"><label>Sua Chave Pix (Para Receber)</label><input id="reg-pix" class="input-field" placeholder="Email, CPF ou Aleatória"></div><div class="camera-container" id="cam-box"><video id="cam-video" autoplay playsinline></video><div class="camera-overlay">Selfie com capacete (validação facial)</div></div><div id="verified-msg" style="display:none; color:var(--success); font-weight:bold; margin-bottom:1rem;">✅ Identidade Confirmada</div><button class="btn btn-secondary btn-full" id="btn-cam" onclick="App.auth.runCamera()">Validar Identidade (Obrigatório)</button>`;
                    } else {
                         html = `<div class="input-wrapper"><label>CPF</label><input id="reg-cpf" class="input-field" placeholder="000.000.000-00"></div>`;
                    }
                    container.innerHTML = html;
                },
                runCamera: async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                        const video = document.getElementById('cam-video');
                        document.getElementById('cam-box').style.display = 'block';
                        video.srcObject = stream;
                        const btn = document.getElementById('btn-cam');
                        btn.innerText = "Analisando rosto...";
                        btn.disabled = true;
                        setTimeout(() => {
                            stream.getTracks().forEach(t => t.stop());
                            document.getElementById('cam-box').style.display = 'none';
                            document.getElementById('verified-msg').style.display = 'block';
                            btn.style.display = 'none';
                            App.utils.toast('Verificação facial concluída!', 'success');
                        }, 4000);
                    } catch(e) { App.utils.toast('Erro: Permita acesso à câmera', 'error'); }
                },
                register: async () => {
                    const email = document.getElementById('reg-email').value.trim();
                    const pass = document.getElementById('reg-pass').value;
                    const name = document.getElementById('reg-name').value.trim();
                    const role = App.state.tempRole;
                    const btn = document.getElementById('btn-final-reg');

                    if(!email || !pass || !name) return App.utils.toast('Preencha os campos corretamente', 'error');
                    
                    try {
                        if (role === 'loja_admin') {
                            const token = document.getElementById('reg-token').value.trim();
                            if (!token) throw new Error("Token de autorização é obrigatório");
                            const { error: tokenError } = await _sb.rpc('validate_store_token', { token_input: token });
                            if (tokenError) throw new Error(tokenError.message);
                        }
                        const { data: newUser, error } = await _sb.from('profiles').insert({
                            nome_completo: name, email: email, password: pass, role: role,
                            cpf: document.getElementById('reg-cpf')?.value || null,
                            cnpj: document.getElementById('reg-cnpj')?.value || null,
                            chave_pix: document.getElementById('reg-pix')?.value || null, 
                            is_verified: document.getElementById('verified-msg')?.style.display === 'block'
                        }).select().single();
                        if(error) throw error;
                        if(role === 'loja_admin') {
                            const storeName = document.getElementById('reg-store-name').value.trim();
                            const whatsApp = document.getElementById('reg-whatsapp').value.trim();
                            const cnpj = document.getElementById('reg-cnpj').value.trim();
                            const { error: storeError } = await _sb.from('stores').insert({ admin_id: newUser.id, nome_loja: storeName || "Minha Loja Nova", cnpj: cnpj, whatsapp: whatsApp });
                            if(storeError) {
                                console.error("Erro ao criar loja:", storeError);
                                alert("Usuário criado, mas erro ao criar loja: " + storeError.message);
                                return; 
                            }
                        }
                        if (document.getElementById('reg-token')) document.getElementById('reg-token').value = "";
                        App.utils.toast('Cadastro realizado com sucesso!', 'success');
                        App.auth.switchView('login');
                    } catch(e) { App.utils.toast('Erro: ' + e.message, 'error'); }
                },
                login: async () => {
                    const email = document.getElementById('login-email').value.trim();
                    const pass = document.getElementById('login-pass').value;
                    const { data, error } = await _sb.from('profiles').select('*').eq('email', email).eq('password', pass).maybeSingle();
                    if(error || !data) { App.utils.toast('Dados incorretos', 'error'); } 
                    else { App.state.user = { id: data.id }; App.state.profile = data; localStorage.setItem('logimoveis_session', JSON.stringify(data)); App.utils.toast('Bem-vindo!', 'success'); App.router.renderNav(); App.router.goDashboard(); }
                },
                recoverPassword: async () => {
                    const email = document.getElementById('rec-email').value.trim();
                    const cpf = document.getElementById('rec-cpf').value.trim();
                    if(!email || !cpf) return App.utils.toast('Preencha Email e CPF', 'error');
                    const { data, error } = await _sb.from('profiles').select('id').eq('email', email).eq('cpf', cpf).maybeSingle();
                    if(data) { App.utils.toast('Link de redefinição enviado para seu email!', 'success'); App.auth.switchView('login'); } else { App.utils.toast('Dados não conferem.', 'error'); }
                },
                logout: () => { localStorage.removeItem('logimoveis_session'); location.reload(); }
            },
            store: {
            init: async () => {
                if (!App.state.user) return;
                let { data: store } = await _sb.from('stores').select('*').eq('admin_id', App.state.user.id).maybeSingle();
                
                if (!store) {
                    const { data: newStore } = await _sb.from('stores').insert({ admin_id: App.state.user.id, nome_loja: 'Loja (Complete o Cadastro)' }).select().single();
                    store = newStore;
                }
                
                App.state.storeId = store.id;
                App.state.currentStore = store;

                // Carrega configurações de Logística
                document.getElementById('store-pickup-address').value = store.endereco_retirada || '';
                document.getElementById('store-delivery-fee').value = store.taxa_entrega_padrao || '';

                if (store.tipo_loja === 'Restaurante') {
                    document.getElementById('admin-restaurant-panel').style.display = 'block';
                } else {
                    document.getElementById('admin-restaurant-panel').style.display = 'none';
                }

                if(store.mp_access_token) {
                    document.getElementById('store-keys-area').style.display = 'none';
                    document.getElementById('store-keys-locked').style.display = 'block';
                } else {
                    document.getElementById('store-keys-area').style.display = 'block';
                    document.getElementById('store-keys-locked').style.display = 'none';
                }

                if(store.parceiro_exclusivo_id) {
                    const {data: p} = await _sb.from('profiles').select('nome_completo, email').eq('id', store.parceiro_exclusivo_id).single();
                    if(p) document.getElementById('active-partner-display').innerText = `Parceiro Vinculado: ${p.nome_completo} (${p.email})`;
                }

                App.store.loadComandas();
                // Carrega Cupons
                App.store.loadCoupons();

                const { data: orders } = await _sb.from('orders').select('*, products(nome, categoria, delivery_info), profiles!orders_cliente_id_fkey(nome_completo, email, cpf), prestador:profiles!orders_prestador_id_fkey(nome_completo, chave_pix)').eq('store_id', store.id).order('created_at', { ascending: false });
                App.store.calcMetrics(orders || []);
                App.store.renderOrders(orders);
                
                App.store.loadMyProducts();
                App.store.listenMessages();
                App.chat.loadHistory('loja');
            },
            saveLogistics: async () => {
                const addr = document.getElementById('store-pickup-address').value;
                const fee = document.getElementById('store-delivery-fee').value;
                
                await _sb.from('stores').update({ 
                    endereco_retirada: addr, 
                    taxa_entrega_padrao: fee 
                }).eq('id', App.state.storeId);
                
                App.utils.toast("Configurações de entrega salvas!", "success");
            },
            loadComandas: async () => {
                const { data } = await _sb.from('comandas').select('*').eq('store_id', App.state.storeId).order('numero', {ascending: true});
                const container = document.getElementById('admin-comanda-grid');
                if (data) {
                    container.innerHTML = data.map(c => `
                        <div class="comanda-card bg-${c.status}" onclick="App.store.manageComanda('${c.id}', ${JSON.stringify(c.items || []).replace(/"/g, '&quot;')}, ${c.numero}, '${c.status}')">
                            <div class="comanda-corner"></div>
                            <div class="comanda-dot"></div>
                            <div style="position:absolute; top:5px; right:5px; font-size:0.8rem; background:rgba(0,0,0,0.2); padding:2px 6px; border-radius:4px; z-index:10;" onclick="event.stopPropagation(); App.store.deleteComanda('${c.id}')">✕</div>
                            <div style="font-size:1.5rem;">${c.numero}</div>
                            <div class="text-xs" style="text-transform:uppercase;">${c.status}</div>
                        </div>
                    `).join('');
                    if(document.getElementById('comanda-list-container')) document.getElementById('comanda-list-container').innerHTML = container.innerHTML;
                }
            },
            deleteComanda: async (id) => {
                if(confirm("Excluir esta comanda permanentemente?")) {
                    await _sb.from('comandas').delete().eq('id', id);
                    App.store.loadComandas();
                }
            },
            manageComanda: (id, items, num, status) => {
                if (status === 'livre') return alert("Comanda livre. Garçom deve abrir lançando pedidos.");
                
                App.state.currentComanda = id;
                App.state.currentComandaItems = items;
                App.state.currentMesaNum = num;
                App.state.comandaTotal = items.reduce((acc, i) => acc + (i.price * i.qtd), 0);

                const itemsHtml = items.map((item, idx) => `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:8px;">
                        <div>
                            <span style="font-weight:bold;">${item.qtd}x ${item.nome}</span>
                            <span class="text-xs text-muted">Garçom: ${item.garcom || 'N/A'}</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span>R$ ${(item.price * item.qtd).toFixed(2)}</span>
                            <button class="btn btn-danger btn-sm" style="padding:2px 8px;" onclick="App.store.removeItemFromComanda(${idx})"><i class="ri-delete-bin-line"></i></button>
                        </div>
                    </div>
                `).join('');

                App.payment.openSplitModal(id, items, num);
                
                const modalBody = document.querySelector('#split-pay-modal .modal-body');
                const editDiv = document.createElement('div');
                editDiv.id = 'admin-comanda-edit-list';
                editDiv.innerHTML = `<h5>Itens da Mesa ${num}</h5><div style="max-height:150px; overflow-y:auto; margin-bottom:15px; border:1px solid #eee;">${itemsHtml}</div>`;
                
                const old = document.getElementById('admin-comanda-edit-list');
                if(old) old.remove();
                
                modalBody.insertBefore(editDiv, modalBody.firstChild);
            },
            removeItemFromComanda: async (index) => {
                if(!confirm("Remover este item?")) return;
                const items = App.state.currentComandaItems;
                items.splice(index, 1); 
                await _sb.from('comandas').update({ items: items }).eq('id', App.state.currentComanda);
                App.store.manageComanda(App.state.currentComanda, items, App.state.currentMesaNum, 'aberta');
                App.store.loadComandas();
            },
            filterHistory: async () => {
                const dateStr = document.getElementById('history-date').value;
                if(!dateStr) return alert("Selecione uma data");

                const { data } = await _sb.from('comandas')
                    .select('*')
                    .eq('store_id', App.state.storeId)
                    .eq('status', 'fechada')
                    .gte('created_at', `${dateStr}T00:00:00`)
                    .lte('created_at', `${dateStr}T23:59:59`);

                const container = document.getElementById('history-results');
                
                if(!data || data.length === 0) {
                    container.innerHTML = '<p class="text-sm text-muted">Nenhuma venda encontrada neste dia.</p>';
                    return;
                }

                let totalDay = 0;
                const list = data.map(c => {
                    const val = c.total_pago || 0;
                    totalDay += val;
                    return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:8px 0; font-size:0.9rem;"><span>Mesa ${c.numero}</span><strong>R$ ${val.toFixed(2)}</strong></div>`;
                }).join('');

                container.innerHTML = `<div style="background:var(--success-bg); color:var(--success-dark); padding:10px; border-radius:8px; margin-bottom:10px; font-weight:bold; text-align:center;">Total em ${dateStr.split('-').reverse().join('/')}: R$ ${totalDay.toFixed(2)}</div>${list}`;
            },
            renderOrders: (orders) => {
                    document.getElementById('store-orders-list').innerHTML = orders?.map(o => {
                    let providerHtml = '';
                    if(o.prestador) {
                        providerHtml = `<div style="background:#f0fdf4; border:1px solid #bbf7d0; padding:10px; border-radius:8px; margin-top:10px; font-size:0.85rem;"><strong>Prestador:</strong> ${o.prestador.nome_completo}<br><strong>Chave Pix:</strong> ${o.prestador.chave_pix || 'Não inf.'}</div>`;
                    }
                    
                    let printBtn = '';
                    if(o.products?.categoria === 'Comidas' || o.products?.categoria === 'Bebidas') {
                        const oSafe = JSON.stringify(o).replace(/"/g, '&quot;');
                        printBtn = `<button class="btn btn-sm btn-info" style="margin-top:5px; width:auto; float:right;" onclick='App.store.printOrder(${oSafe})'><i class="ri-printer-line"></i> Imprimir</button>`;
                    }

                    return `
                    <div class="card" style="margin-bottom:1rem; border-left: 4px solid ${o.status==='pendente'?'var(--warning)':'var(--success)'};">
                        <div style="display:flex; justify-content:space-between"><strong>${o.products?.nome}</strong><span class="badge status-${o.status}">${o.status}</span></div>
                        <p class="text-sm">Cliente: ${o.profiles?.nome_completo}</p>
                        ${printBtn}
                        <div style="clear:both;"></div>
                        ${o.status === 'pendente' ? `<button class="btn btn-primary btn-sm btn-full" onclick="App.store.dispatch('${o.id}')">Liberar para Entrega</button>` : ''}
                        ${providerHtml}
                    </div>`;
                }).join('') || '<p class="text-sm">Nenhum pedido.</p>';
            },
            listenMessages: () => {
                const myStoreId = App.state.storeId;
                _sb.channel('store-notifications')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `store_id=eq.${myStoreId}` }, 
                async (payload) => {
                    if(payload.new.sender_id !== App.state.user.id) {
                        const { data: sender } = await _sb.from('profiles').select('nome_completo').eq('id', payload.new.sender_id).single();
                        App.utils.showChatNotification(sender.nome_completo, payload.new.content, payload.new.client_id);
                    }
                })
                .subscribe();
            },
            calcMetrics: async (orders) => {
                const now = new Date();
                let dayTotal = 0, weekTotal = 0, monthTotal = 0;
                
                orders.forEach(o => {
                    if(['aceito', 'concluido', 'em_rota', 'aguardando_prestador'].includes(o.status)) {
                        const val = o.taxa_servico / 0.15; 
                        const orderDate = new Date(o.created_at);
                        if(orderDate.toDateString() === now.toDateString()) dayTotal += val;
                        if(orderDate.getMonth() === now.getMonth() && orderDate.getFullYear() === now.getFullYear()) monthTotal += val;
                        const diffTime = Math.abs(now - orderDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        if(diffDays <= 7) weekTotal += val;
                    }
                });

                const { data: comandas } = await _sb.from('comandas').select('*').eq('store_id', App.state.storeId).eq('status', 'fechada');
                
                if(comandas) {
                    comandas.forEach(c => {
                        const val = c.total_pago || 0;
                        const cDate = new Date(c.created_at);
                        if(cDate.toDateString() === now.toDateString()) dayTotal += val;
                        if(cDate.getMonth() === now.getMonth()) monthTotal += val;
                    });
                }
                
                document.getElementById('metric-day').innerText = `R$ ${dayTotal.toFixed(2)}`;
                document.getElementById('metric-week').innerText = `R$ ${weekTotal.toFixed(2)}`;
                document.getElementById('metric-month').innerText = `R$ ${monthTotal.toFixed(2)}`;
            },
            loadMyProducts: async () => {
                const { data } = await _sb.from('products').select('*').eq('store_id', App.state.storeId);
                document.getElementById('store-products-list').innerHTML = data?.map(p => {
                    const pSafe = JSON.stringify(p).replace(/"/g, '&quot;');
                    return `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div>
                            <div style="font-weight:bold">${p.nome} ${p.promocao ? '<span style="color:red; font-size:0.7rem">(Promo)</span>' : ''}</div>
                            <div class="text-xs text-muted">R$ ${p.preco.toFixed(2)}</div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-sm btn-secondary" style="width:auto" onclick='App.store.openEditProduct(${pSafe})'>Editar</button>
                            <button class="btn btn-sm btn-danger" style="width:auto; padding:5px 8px;" onclick="App.store.deleteProduct('${p.id}')"><i class="ri-delete-bin-line"></i></button>
                        </div>
                    </div>`;
                }).join('');
            },
            deleteProduct: async (id) => {
                if(confirm("Deseja realmente excluir este produto?")) {
                    await _sb.from('products').delete().eq('id', id);
                    App.utils.toast("Produto excluído!", "success");
                    App.store.loadMyProducts();
                    App.catalog.fetchPublic();
                }
            },
            openProductModal: () => {
                document.getElementById('prod-modal-title').innerText = "Adicionar Serviço/Produto";
                document.getElementById('btn-save-prod').innerText = "Publicar Serviço";
                document.getElementById('edit-prod-id').value = "";
                document.getElementById('new-prod-name').value = "";
                document.getElementById('new-prod-price').value = "";
                document.getElementById('new-prod-promo').checked = false;
                document.getElementById('gesso-price-m2').value = "";
                document.getElementById('gesso-labor-val').value = "";
                document.getElementById('delivery-fee-val').value = "";
                document.getElementById('new-prod-file').value = ""; 
                document.getElementById('new-prod-desc').value = "";
                document.getElementById('clothing-sizes').value = "";
                
                document.getElementById('new-prod-cat').value = CONFIG.categories[0];
                App.store.checkCategory(CONFIG.categories[0]);
                document.getElementById('product-modal').style.display = 'flex';
            },
            openEditProduct: (p) => {
                document.getElementById('prod-modal-title').innerText = "Editar Serviço/Produto";
                document.getElementById('btn-save-prod').innerText = "Salvar Alterações";
                document.getElementById('edit-prod-id').value = p.id;
                document.getElementById('new-prod-cat').value = p.categoria;
                document.getElementById('new-prod-name').value = p.nome;
                document.getElementById('new-prod-price').value = p.preco;
                document.getElementById('new-prod-promo').checked = p.promocao;
                document.getElementById('new-prod-desc').value = p.descricao || "";
                document.getElementById('clothing-sizes').value = p.sizes || "";

                if(p.gesso_info) {
                    try {
                        const g = typeof p.gesso_info === 'string' ? JSON.parse(p.gesso_info) : p.gesso_info;
                        document.getElementById('gesso-price-m2').value = g.price_m2 || "";
                        document.getElementById('gesso-labor-val').value = g.labor_val || "";
                        document.getElementById('gesso-labor-type').value = g.labor_type || "fixed";
                    } catch(e) {}
                }

                if(p.delivery_info) {
                    try {
                        const d = typeof p.delivery_info === 'string' ? JSON.parse(p.delivery_info) : p.delivery_info;
                        document.getElementById('delivery-fee-val').value = d.fee_val || "";
                        document.getElementById('delivery-fee-type').value = d.fee_type || "fixed";
                    } catch(e) {}
                }
                
                App.store.checkCategory(p.categoria);
                document.getElementById('product-modal').style.display = 'flex';
            },
            closeProductModal: () => document.getElementById('product-modal').style.display = 'none',
            checkCategory: (cat) => {
                document.getElementById('hotel-dates-area').style.display = 'none';
                document.getElementById('gesso-options-area').style.display = 'none';
                document.getElementById('delivery-options-area').style.display = 'none';
                document.getElementById('clothing-options-area').style.display = 'none';

                if(cat === 'Hoteis/Pousadas') {
                    document.getElementById('hotel-dates-area').style.display = 'block';
                } else if (cat === 'Serviços de Gesso') {
                    document.getElementById('gesso-options-area').style.display = 'block';
                } else if (cat === 'Comidas' || cat === 'Bebidas') {
                    document.getElementById('delivery-options-area').style.display = 'block';
                } else if (cat === 'Roupas') {
                    document.getElementById('clothing-options-area').style.display = 'block';
                }
            },
            submitProduct: async () => {
                if(!App.state.storeId) {
                    alert("Erro crítico: ID da Loja não encontrado.");
                    return;
                }

                const id = document.getElementById('edit-prod-id').value;
                const nome = document.getElementById('new-prod-name').value;
                const preco = document.getElementById('new-prod-price').value;
                const cat = document.getElementById('new-prod-cat').value;
                const promo = document.getElementById('new-prod-promo').checked;
                const descricao = document.getElementById('new-prod-desc').value;
                const sizes = document.getElementById('clothing-sizes').value;

                const fileInput = document.getElementById('new-prod-file');
                const files = fileInput.files;

                if (!nome || !preco) return App.utils.toast("Preencha nome e preço", "error");
                
                let galeriaUrls = [];
                
                if (files.length > 0) {
                    App.utils.toast(`Enviando ${files.length} fotos... aguarde.`, "info");
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const fileName = `${Date.now()}_${i}_${file.name.replace(/\s/g, '_')}`;
                        const { error: upErr } = await _sb.storage.from('produtos').upload(fileName, file);
                        
                        if (!upErr) {
                            const { data } = _sb.storage.from('produtos').getPublicUrl(fileName);
                            galeriaUrls.push(data.publicUrl);
                        }
                    }
                }

                const dateStart = document.getElementById('hotel-start-date').value;
                const dateEnd = document.getElementById('hotel-end-date').value;
                let disp = null;
                if(cat === 'Hoteis/Pousadas' && dateStart && dateEnd) disp = `${dateStart}|${dateEnd}`;

                let gessoInfo = null;
                if(cat === 'Serviços de Gesso') {
                    gessoInfo = JSON.stringify({
                        price_m2: document.getElementById('gesso-price-m2').value,
                        labor_val: document.getElementById('gesso-labor-val').value,
                        labor_type: document.getElementById('gesso-labor-type').value
                    });
                }

                let deliveryInfo = null;
                if(cat === 'Comidas' || cat === 'Bebidas') {
                    deliveryInfo = JSON.stringify({
                        fee_val: document.getElementById('delivery-fee-val').value,
                        fee_type: document.getElementById('delivery-fee-type').value
                    });
                }
                
                const payload = { 
                    store_id: App.state.storeId, 
                    nome, 
                    preco: parseFloat(preco), 
                    categoria: cat, 
                    promocao: promo, 
                    disponibilidade: disp,
                    gesso_info: gessoInfo,
                    delivery_info: deliveryInfo, 
                    descricao: descricao,
                    sizes: sizes
                };

                if (galeriaUrls.length > 0) {
                    payload.imagem_url = galeriaUrls[0]; 
                    payload.galeria = galeriaUrls;       
                }

                let res;
                if(id) {
                    res = await _sb.from('products').update(payload).eq('id', id);
                } else {
                    if(galeriaUrls.length === 0 && !id) payload.imagem_url = 'https://placehold.co/400x300?text=NexLog';
                    res = await _sb.from('products').insert(payload);
                }

                if(res.error) { 
                    alert("Erro ao salvar: " + res.error.message); 
                } else {
                    alert("Produto salvo com sucesso!");
                    App.store.closeProductModal(); 
                    App.catalog.fetchPublic(); 
                    App.store.init();
                }
            },
            saveCredentials: async () => {
                const acc = document.getElementById('store-access-token').value.trim();
                const pub = document.getElementById('store-public-key').value.trim();
                if(!acc || !pub) return App.utils.toast("Preencha ambas as chaves!", "error");
                await _sb.from('stores').update({ mp_access_token: acc, mp_public_key: pub }).eq('id', App.state.storeId);
                App.utils.toast("Chaves salvas e protegidas!", "success");
                App.store.init();
            },
            resetKeys: async () => {
                if(confirm("Isso pausará seus recebimentos. Continuar?")) {
                    await _sb.from('stores').update({ mp_access_token: null, mp_public_key: null }).eq('id', App.state.storeId);
                    App.store.init();
                }
            },
            linkPartner: async () => {
                const email = document.getElementById('partner-email-input').value.trim();
                if(!email) return App.utils.toast("Digite o email do motorista", "error");
                const { data: user } = await _sb.from('profiles').select('id').eq('email', email).single();
                if(!user) return App.utils.toast("Motorista não encontrado no sistema.", "error");
                await _sb.from('stores').update({ parceiro_exclusivo_id: user.id }).eq('id', App.state.storeId);
                App.utils.toast("Parceiro vinculado com sucesso!", "success");
                App.store.init();
            },
            dispatch: async (id) => {
                await _sb.from('orders').update({ status: 'aguardando_prestador', data_agendada: new Date().toISOString() }).eq('id', id);
                App.utils.toast('Despachado!', 'success'); App.store.init();
            },
            setupPrinter: () => {
                window.print();
            },
            printOrder: (order) => {
                const store = App.state.currentStore || {};
                const content = `
                    <div style="font-family: monospace; width: 300px; padding: 10px; text-align: center;">
                        <h3>${store.nome_loja || 'NEXLOG PEDIDOS'}</h3>
                        ${store.cnpj ? `<p style="font-size:0.8rem; margin:0;">CNPJ: ${store.cnpj}</p>` : ''}
                        ${store.whatsapp ? `<p style="font-size:0.8rem; margin:0;">Tel: ${store.whatsapp}</p>` : ''}
                        <p style="margin-top:5px; border-bottom: 1px dashed black; padding-bottom:5px;">${new Date().toLocaleString()}</p>
                        <p><strong>Pedido #${order.id}</strong></p>
                        <p>Cliente: ${order.profiles?.nome_completo}</p>
                        <hr style="border-top: 1px dashed black;">
                        <div style="text-align: left;">
                            <p><strong>Item:</strong> ${order.products?.nome}</p>
                            <p><strong>Valor:</strong> R$ ${(order.taxa_servico/0.15).toFixed(2)}</p>
                        </div>
                        <hr style="border-top: 1px dashed black;">
                        <h3>TOTAL: R$ ${(order.taxa_servico/0.15).toFixed(2)}</h3>
                        <p style="font-size: 0.8rem;">Obrigado pela preferência!</p>
                    </div>
                `;
                const area = document.getElementById('printable-area');
                area.innerHTML = content;
                window.print(); 
            },
            createCoupon: async () => {
                const code = document.getElementById('new-coupon-code').value.toUpperCase().trim();
                const percent = parseInt(document.getElementById('new-coupon-percent').value);
                
                if(!code || !percent) return App.utils.toast("Preencha código e porcentagem", "error");

                const { error } = await _sb.from('coupons').insert({
                    store_id: App.state.storeId,
                    code: code,
                    percent: percent
                });

                if(error) App.utils.toast("Erro ao criar cupom", "error");
                else {
                    App.utils.toast("Cupom criado!", "success");
                    App.store.loadCoupons();
                    document.getElementById('new-coupon-code').value = "";
                }
            },
            loadCoupons: async () => {
                const { data } = await _sb.from('coupons').select('*').eq('store_id', App.state.storeId).eq('active', true);
                const div = document.getElementById('coupon-list-display');
                if(!data || data.length === 0) {
                    div.innerHTML = '<span class="text-xs text-muted">Nenhum cupom ativo.</span>';
                    return;
                }
                div.innerHTML = data.map(c => `
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px; font-size:0.8rem;">
                        <strong>${c.code} (${c.percent}%)</strong>
                        <span style="color:red; cursor:pointer;" onclick="App.store.deleteCoupon('${c.id}')">Excluir</span>
                    </div>
                `).join('');
            },
            deleteCoupon: async (id) => {
                if(confirm("Excluir cupom?")) {
                    await _sb.from('coupons').delete().eq('id', id);
                    App.store.loadCoupons();
                }
            }
        },
            filterHistory: async () => {
    const dateStr = document.getElementById('history-date').value;
    if(!dateStr) return alert("Selecione uma data");

    // Busca comandas fechadas na data selecionada (considerando fuso horário UTC do banco)
    const { data } = await _sb.from('comandas')
        .select('*')
        .eq('store_id', App.state.storeId)
        .eq('status', 'fechada')
        .gte('created_at', `${dateStr}T00:00:00`)
        .lte('created_at', `${dateStr}T23:59:59`);

    const container = document.getElementById('history-results');
    
    if(!data || data.length === 0) {
        container.innerHTML = '<p class="text-sm text-muted">Nenhuma venda encontrada neste dia.</p>';
        return;
    }

    let totalDay = 0;
    const list = data.map(c => {
        const val = c.total_pago || 0;
        totalDay += val;
        return `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:8px 0; font-size:0.9rem;">
                <span>Mesa ${c.numero}</span>
                <strong>R$ ${val.toFixed(2)}</strong>
            </div>
        `;
    }).join('');

    container.innerHTML = `
        <div style="background:var(--success-bg); color:var(--success-dark); padding:10px; border-radius:8px; margin-bottom:10px; font-weight:bold; text-align:center;">
            Total em ${dateStr.split('-').reverse().join('/')}: R$ ${totalDay.toFixed(2)}
        </div>
        ${list}
    `;
},
            admin: {
                 createComandas: async () => {
                     const start = parseInt(document.getElementById('comanda-start').value);
                     const end = parseInt(document.getElementById('comanda-end').value);
                     if (!start || !end || end < start) return alert("Intervalo inválido");
                     const rows = [];
                     for(let i=start; i<=end; i++) rows.push({ store_id: App.state.storeId, numero: i, status: 'livre' });
                     const { error } = await _sb.from('comandas').insert(rows);
                     if(error) alert("Erro ao criar: " + error.message);
                     else { alert(`${rows.length} comandas criadas!`); App.store.loadComandas(); }
                 },
                 registerStaff: async () => {
                     const name = document.getElementById('staff-name').value;
                     const email = document.getElementById('staff-email').value;
                     const pass = document.getElementById('staff-pass').value;
                     const role = document.getElementById('staff-role').value;
                     const rate = document.getElementById('staff-rate').value;
                     if(!name || !email || !pass) return alert("Preencha todos os campos");
                     const { data: newUser, error } = await _sb.from('profiles').insert({
                        nome_completo: name, email: email, password: pass, role: role, is_verified: true
                     }).select().single();
                     if(error) return alert("Erro no perfil: " + error.message);
                     await _sb.from('store_staff').insert({ store_id: App.state.storeId, profile_id: newUser.id, cargo: role, taxa_servico: rate });
                     alert("Funcionário cadastrado!");
                 }
            },
           payment: {
                openSplitModal: (comandaId, items, numeroMesa) => {
                    App.state.currentComanda = comandaId;
                    App.state.paymentSplits = [];
                    App.state.currentComandaItems = items;
                    App.state.currentMesaNum = numeroMesa;
                    
                    let total = 0;
                    if(items && Array.isArray(items)) total = items.reduce((acc, item) => acc + (item.price * item.qtd), 0);
                    App.state.comandaTotal = total;
                    
                    document.getElementById('split-total-due').innerText = `R$ ${total.toFixed(2)}`;
                    document.getElementById('split-remaining').innerText = `R$ ${total.toFixed(2)}`;
                    document.getElementById('split-amount').value = total.toFixed(2); 
                    document.getElementById('split-history').innerHTML = '';
                    
                    // Configura botão de impressão
                    const modalBody = document.querySelector('#split-pay-modal .modal-body');
                    const oldBtn = document.getElementById('btn-print-split-detail');
                    if(oldBtn) oldBtn.remove();
                    
                    const printBtn = document.createElement('button');
                    printBtn.id = 'btn-print-split-detail';
                    printBtn.className = 'btn btn-info btn-sm btn-full';
                    printBtn.style.marginBottom = '10px';
                    printBtn.innerHTML = '<i class="ri-printer-line"></i> Imprimir Conferência';
                    printBtn.onclick = () => App.payment.printCheck();
                    
                    const historyTitle = modalBody.querySelector('h5');
                    modalBody.insertBefore(printBtn, historyTitle);
                    
                    document.getElementById('split-pay-modal').style.display = 'flex';
                },
                printCheck: () => {
                    const items = App.state.currentComandaItems || [];
                    const num = App.state.currentMesaNum || '?';
                    const total = App.state.comandaTotal || 0;
                    let itemsHtml = items.map(i => `<div style="display:flex; justify-content:space-between;"><span>${i.qtd}x ${i.nome}</span><span>R$ ${(i.price * i.qtd).toFixed(2)}</span></div>`).join('');
                    const content = `<div style="font-family: monospace; width: 300px; padding: 10px;"><h3 style="text-align:center;">CONFERÊNCIA</h3><p style="text-align:center; font-size:1.2rem;">MESA ${num}</p><p>${new Date().toLocaleString()}</p><hr>${itemsHtml}<hr><h3 style="text-align:right;">TOTAL: R$ ${total.toFixed(2)}</h3></div>`;
                    const area = document.getElementById('printable-area');
                    area.innerHTML = content;
                    window.print();
                },
                toggleCardFields: () => {
                    const method = document.getElementById('split-method').value;
                    document.getElementById('card-fields').style.display = (method === 'cartao') ? 'flex' : 'none';
                },
                addSplit: () => {
                    const amount = parseFloat(document.getElementById('split-amount').value);
                    const method = document.getElementById('split-method').value;
                    const nsu = document.getElementById('card-nsu').value;
                    
                    if(!amount || amount <= 0) return alert("Valor inválido");
                    
                    App.state.paymentSplits.push({ amount, method, nsu });
                    
                    const hist = document.getElementById('split-history');
                    hist.innerHTML = App.state.paymentSplits.map(s => `<div>- R$ ${s.amount.toFixed(2)} (${s.method.toUpperCase()})</div>`).join('');
                    
                    const paid = App.state.paymentSplits.reduce((acc, s) => acc + s.amount, 0);
                    const remain = App.state.comandaTotal - paid;
                    
                    document.getElementById('split-remaining').innerText = `R$ ${remain > 0 ? remain.toFixed(2) : '0.00'}`;
                    
                    if(remain <= 0.01) {
                        document.getElementById('btn-finish-split').disabled = false;
                        document.getElementById('split-amount').value = 0;
                    } else {
                        document.getElementById('split-amount').value = remain.toFixed(2);
                    }
                },
                finalizeSplit: async () => {
                    // 1. Atualiza no Banco
                    await _sb.from('comandas').update({ 
                        status: 'fechada', 
                        payments_info: App.state.paymentSplits, 
                        total_pago: App.state.comandaTotal 
                    }).eq('id', App.state.currentComanda);
                    
                    App.utils.toast("Conta Fechada!", "success");
                    document.getElementById('split-pay-modal').style.display = 'none';
                    
                    // 2. ATUALIZAÇÃO CRÍTICA: RECARREGA O PAINEL PARA SOMAR O DINHEIRO
                    if(App.state.profile.role === 'loja_admin') {
                        // Se for o dono, recarrega tudo (inclusive métricas financeiras)
                        App.store.init();
                    } else {
                        // Se for garçom, só recarrega as mesas
                        if(App.waiter && App.waiter.loadTables) App.waiter.loadTables();
                    }
                },
                open: async (total, orderPayload) => {
                    App.state.pendingPayment = { total, orderPayload };
                    document.getElementById('pay-total-display').innerText = `R$ ${total.toFixed(2)}`;
                    document.getElementById('payment-modal').style.display = 'flex';
                    document.getElementById('payment-brick_container').innerHTML = '';
                    const oldPix = document.getElementById('pix-display-area'); if(oldPix) oldPix.remove();
                    document.getElementById('payment-brick_container').style.display = 'block';
                    
                    if(total <= 0) {
                         alert("Valor total é zero. Pedido processado.");
                         App.payment.finalizeSuccess();
                         return;
                    }
                    
                    App.payment.renderBrick(total);
                },
                close: () => {
                    document.getElementById('payment-modal').style.display = 'none';
                    if (App.state.brickController) App.state.brickController.unmount();
                    if (App.state.pixInterval) clearInterval(App.state.pixInterval); 
                },
                renderBrick: async (amount) => {
                    const builder = mpInstance.bricks();
                    App.state.brickController = await builder.create("payment", "payment-brick_container", {
                        initialization: { amount: amount, payer: { email: App.state.profile.email || 'guest@nexlog.com' } },
                        customization: { paymentMethods: { ticket: "all", bankTransfer: "all", creditCard: "all", debitCard: "all", maxInstallments: 3 }, visual: { style: { theme: 'default' } } },
                        callbacks: {
                            onReady: () => console.log("Brick Ready"),
                            onError: (e) => console.error(e),
                            onSubmit: async ({ formData }) => {
                                formData.store_id = App.state.pendingPayment.orderPayload.store_id; 
                                return new Promise((resolve, reject) => {
                                    fetch("/api/pix", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(formData) })
                                    .then(async r => {
                                        const data = await r.json();
                                        if(!r.ok) { App.utils.toast(data.message || "Erro", "error"); reject(); return; }
                                        if(data.status === 'approved') { App.utils.toast("Aprovado!", "success"); App.payment.finalizeSuccess(); resolve(); }
                                        else if(data.status === 'pending' && data.payment_method_id === 'pix') { App.payment.showPixScreen(data); resolve(); }
                                        else { App.utils.toast("Recusado.", "error"); reject(); }
                                    }).catch(() => { App.utils.toast("Erro Conexão", "error"); reject(); });
                                });
                            }
                        }
                    });
                },
                showPixScreen: (data) => {
                    document.getElementById('payment-brick_container').style.display = 'none';
                    const qr = data.point_of_interaction.transaction_data;
                    const div = document.createElement('div'); div.id='pix-display-area'; div.style.textAlign='center';
                    div.innerHTML = `<div style="background:#f1f5f9; padding:20px; border-radius:12px; margin-bottom:15px; border:2px dashed #cbd5e1;"><img src="data:image/png;base64,${qr.qr_code_base64}" style="width:200px"></div><p class="text-xs">Copie e Cole: <input value="${qr.qr_code}" readonly style="width:100%"></p><div style="margin-top:20px; color:var(--primary)"><i class="ri-loader-4-line spin" style="font-size:2rem"></i><p>Aguardando pagamento...</p></div>`;
                    document.querySelector('#payment-modal .modal-body').appendChild(div);
                    App.payment.startPolling(data.id, App.state.pendingPayment.orderPayload.store_id);
                },
                startPolling: (paymentId, storeId) => {
                    if(App.state.pixInterval) clearInterval(App.state.pixInterval);
                    App.state.pixInterval = setInterval(async () => {
                        try {
                            const res = await fetch(`/api/pix?id=${paymentId}&store_id=${storeId}`);
                            const data = await res.json();
                            if(data.status === 'approved') { clearInterval(App.state.pixInterval); App.utils.toast("Confirmado!", "success"); App.payment.finalizeSuccess(); }
                        } catch(e) {}
                    }, 3000); 
                },
                finalizeSuccess: async () => {
                    App.payment.close();
                    const { orderPayload } = App.state.pendingPayment;
                    await _sb.from('orders').insert({ cliente_id: App.state.user.id, product_id: orderPayload.product_id, store_id: orderPayload.store_id, endereco_destino: orderPayload.address, requer_montagem: orderPayload.requer_montagem, taxa_servico: orderPayload.taxa, status: 'pendente' });
                    App.utils.toast('Pedido realizado!', 'success'); App.router.go('cliente'); App.client.init();
                    
                    if (orderPayload.address.includes("(Itens:")) {
                        const content = `<div style="font-family: monospace; width: 300px; padding: 10px;"><h3 style="text-align:center;">PEDIDO COZINHA</h3><p>Cliente: ${App.state.profile.nome_completo}</p><p>Endereço: ${orderPayload.address.split('(Itens:')[0]}</p><hr><p><strong>Itens:</strong></p><p>${orderPayload.address.split('(Itens:')[1].replace(')', '')}</p></div>`;
                        const area = document.getElementById('printable-area');
                        area.innerHTML = content;
                        window.print();
                    }
                }
            },
            client: {
                init: async () => {
                    const { data: orders } = await _sb.from('orders').select('*, products(nome)').eq('cliente_id', App.state.user.id).order('created_at', {ascending:false});
                    document.getElementById('client-orders-list').innerHTML = orders?.map(o => `
                        <div class="card" style="margin-bottom:1rem"><div style="display:flex; justify-content:space-between; margin-bottom:0.5rem"><strong>${o.products?.nome}</strong><span class="badge status-${o.status}">${o.status}</span></div><p class="text-sm">${o.endereco_destino}</p>${['em_rota', 'aceito', 'concluido'].includes(o.status) ? `<button class="btn btn-success btn-sm btn-full" onclick="App.map.open('${o.id}', false)">Rastrear Entrega</button>` : ''}</div>`).join('') || '<p>Nenhum pedido.</p>';
                    App.chat.loadHistory('client');
                },
                checkTableBill: async () => {
                     const num = document.getElementById('client-table-check').value;
                     if(!num) return;
                     const { data } = await _sb.from('comandas').select('*, stores(mp_public_key)').eq('numero', num).eq('status', 'aberta').single();
                     if(data && data.items) {
                         const total = data.items.reduce((acc, i) => acc + (i.price * i.qtd), 0);
                         if(confirm(`Mesa ${num}: Total R$ ${total.toFixed(2)}. Pagar agora online?`)) {
                              const pk = data.stores?.mp_public_key || CONFIG.adminPublicKey;
                              mpInstance = new MercadoPago(pk);
                              App.payment.open(total, { store_id: data.store_id, basePrice: total, address: `MESA ${num} (Pagto Online)`, requer_montagem: false, taxa: 0 });
                         }
                     } else { alert("Mesa não encontrada ou fechada."); }
                },
                confirmOrder: async (pid, sid, price, category, deliveryInfoRaw) => { 
                    if(!App.state.user) { App.router.go('auth'); return; }
                    let address = "";
                    if (category === 'Hoteis/Pousadas') {
                        const { data: userProfile } = await _sb.from('profiles').select('*').eq('id', App.state.user.id).single();
                        if(userProfile) {
                            address = `RESERVA: ${userProfile.nome_completo} | CPF: ${userProfile.cpf || 'Não inf.'} | Email: ${userProfile.email}`;
                            alert("Dados capturados para reserva. Prossiga para o pagamento.");
                        } else address = "Dados de reserva pendentes.";
                    } else {
                        address = prompt("Endereço de Entrega Completo:"); 
                        if(!address) return;
                    }
                    if (category === 'Comidas') {
                        if (confirm("Você vai querer beber alguma coisa?")) {
                            App.utils.toast("Filtrando bebidas desta loja...", "info");
                            let query = _sb.from('products').select('*, stores(nome_loja)').eq('store_id', sid).eq('categoria', 'Bebidas');
                            const { data } = await query;
                            let html = `<div style="grid-column:1/-1; margin-bottom:10px;"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="color:var(--success)">🥤 Bebidas da Loja</h3><button class="btn btn-sm btn-primary" style="width:auto;" onclick="App.client.finalizeCart('${pid}', '${sid}', ${price}, '${address}')">Voltar ao Carrinho/Pagar</button></div><p class="text-sm text-muted">Adicione uma bebida ou clique em Voltar para pagar.</p></div>`;
                            if (data && data.length > 0) html += data.map(p => App.catalog.renderCard(p)).join('');
                            else html += `<p style="grid-column:1/-1; text-align:center">Nenhuma bebida cadastrada nesta loja.</p>`;
                            document.getElementById('public-catalog').innerHTML = html;
                            return; 
                        }
                    }
                    let finalPrice = price;
                    let feeVal = 0;
                    if (deliveryInfoRaw) {
                        try {
                            const d = JSON.parse(deliveryInfoRaw);
                            const val = parseFloat(d.fee_val) || 0;
                            if(d.fee_type === 'percent') feeVal = price * (val / 100);
                            else feeVal = val;
                            if(feeVal > 0) alert(`Será adicionada uma taxa de entrega de R$ ${feeVal.toFixed(2)}`);
                        } catch(e) {}
                    }
                   const serviceCats = ['Fretes e Mudanças', 'Serviços de Pedreiros', 'Serviços de Pintores', 'Manutenção Eletrodomésticos', 'Jardinagem', 'Serviços de Manutenção', 'Outros'];
                    if (serviceCats.includes(category)) {
                        // Se for serviço e não tiver taxa definida, mantém zero e avisa
                        if (feeVal === 0) { 
                            feeVal = 0; 
                            alert("Não cobramos taxa de deslocamento para este serviço."); 
                        }
                    }
                    finalPrice += feeVal;
                    const { data: storeData } = await _sb.from('stores').select('mp_public_key').eq('id', sid).single();
                    const publicKeyToUse = (storeData && storeData.mp_public_key) ? storeData.mp_public_key : CONFIG.adminPublicKey;
                    mpInstance = new MercadoPago(publicKeyToUse);
                    const commission = finalPrice * 0.10;
                    App.payment.open(finalPrice, { product_id: pid, store_id: sid, basePrice: finalPrice, address, requer_montagem: false, taxa: commission });
                },
                finalizeCart: async (pid, sid, price, address) => {
                     const { data: storeData } = await _sb.from('stores').select('mp_public_key').eq('id', sid).single();
                     const publicKeyToUse = (storeData && storeData.mp_public_key) ? storeData.mp_public_key : CONFIG.adminPublicKey;
                     mpInstance = new MercadoPago(publicKeyToUse);
                     const commission = price * 0.10;
                     App.payment.open(price, { product_id: pid, store_id: sid, basePrice: price, address, requer_montagem: false, taxa: commission });
                },
                openBudget: (p) => {
                    if(!App.state.user) { App.router.go('auth'); return; }
                    const g = typeof p.gesso_info === 'string' ? JSON.parse(p.gesso_info) : p.gesso_info;
                    document.getElementById('budget-prod-id').value = p.id;
                    document.getElementById('budget-store-id').value = p.store_id;
                    document.getElementById('budget-base-price').value = g.price_m2;
                    document.getElementById('budget-labor-val').value = g.labor_val;
                    document.getElementById('budget-labor-type').value = g.labor_type;
                    document.getElementById('budget-area').value = "";
                    document.getElementById('display-material').innerText = "R$ 0,00";
                    document.getElementById('display-labor').innerText = "R$ 0,00";
                    document.getElementById('display-total').innerText = "R$ 0,00";
                    document.getElementById('budget-modal').style.display = 'flex';
                },
                calculateBudget: () => {
                    const area = parseFloat(document.getElementById('budget-area').value) || 0;
                    const priceM2 = parseFloat(document.getElementById('budget-base-price').value) || 0;
                    const laborVal = parseFloat(document.getElementById('budget-labor-val').value) || 0;
                    const laborType = document.getElementById('budget-labor-type').value;
                    const materialCost = area * priceM2;
                    let laborCost = 0;
                    if(laborType === 'fixed') laborCost = area * laborVal;
                    else laborCost = materialCost * (laborVal / 100);
                    const total = materialCost + laborCost;
                    App.state.currentBudgetTotal = total;
                    document.getElementById('display-material').innerText = `R$ ${materialCost.toFixed(2)}`;
                    document.getElementById('display-labor').innerText = `R$ ${laborCost.toFixed(2)}`;
                    document.getElementById('display-total').innerText = `R$ ${total.toFixed(2)}`;
                },
                finishBudgetOrder: async () => {
                    const total = App.state.currentBudgetTotal;
                    if(total <= 0) return alert("Por favor, calcule a área primeiro.");
                    const pid = document.getElementById('budget-prod-id').value;
                    const sid = document.getElementById('budget-store-id').value;
                    document.getElementById('budget-modal').style.display = 'none';
                    const downPayment = total * 0.5;
                    const { data: storeData } = await _sb.from('stores').select('mp_public_key').eq('id', sid).single();
                    const publicKeyToUse = (storeData && storeData.mp_public_key) ? storeData.mp_public_key : CONFIG.adminPublicKey;
                    mpInstance = new MercadoPago(publicKeyToUse);
                    const address = prompt("Endereço de Entrega/Serviço:"); 
                    if(!address) return;
                    App.payment.open(downPayment, { product_id: pid, store_id: sid, basePrice: total, address, requer_montagem: false, taxa: 0 });
                    alert(`O valor total é R$ ${total.toFixed(2)}. Você pagará 50% (R$ ${downPayment.toFixed(2)}) agora.`);
                }
            },
           waiter: {
                init: async () => {
                    const { data: staffData } = await _sb.from('store_staff').select('store_id').eq('profile_id', App.state.user.id).single();
                    if(!staffData) return alert("Você não está vinculado a nenhuma loja.");
                    App.state.storeId = staffData.store_id; 
                    
                    // CORREÇÃO: Chama a função própria do garçom, não a da loja
                    App.waiter.loadTables(); 
                    
                    // Configura atualização em tempo real para o garçom ver mesas abrindo/fechando
                    _sb.channel('waiter-updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'comandas', filter: `store_id=eq.${App.state.storeId}` }, 
                    () => { App.waiter.loadTables(); })
                    .subscribe();
                },
                // NOVA FUNÇÃO: Carrega mesas com clique configurado para PEDIDOS
                loadTables: async () => {
                    const { data } = await _sb.from('comandas').select('*').eq('store_id', App.state.storeId).order('numero', {ascending: true});
                    const container = document.getElementById('comanda-list-container');
                    
                    if (data) {
                        container.innerHTML = data.map(c => `
                            <div class="comanda-card bg-${c.status}" onclick="App.waiter.openComanda('${c.id}', '${c.numero}')">
                                <div class="comanda-corner"></div>
                                <div class="comanda-dot"></div>
                                <div style="font-size:1.5rem;">${c.numero}</div>
                                <div class="text-xs" style="text-transform:uppercase;">${c.status}</div>
                            </div>
                        `).join('');
                    }
                },
                openComanda: async (id, numero) => {
                    App.state.currentComanda = id;
                    document.getElementById('comanda-title').innerText = `Mesa ${numero}`; 
                    
                    // Limpa o campo de busca
                    document.getElementById('waiter-prod-search').value = "";
                    document.getElementById('waiter-search-results').style.display = 'none';
                    
                    document.getElementById('comanda-modal').style.display = 'flex';
                    App.waiter.loadItems(id);
                },
                loadItems: async (comandaId) => {
                    const { data } = await _sb.from('comandas').select('items').eq('id', comandaId).single();
                    const list = document.getElementById('comanda-items-list');
                    
                    if(data && data.items && data.items.length > 0) {
                        list.innerHTML = data.items.map(item => `
                            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:8px;">
                                <span style="font-weight:bold;">${item.qtd}x ${item.nome}</span>
                                <span>R$ ${(item.price * item.qtd).toFixed(2)}</span>
                            </div>
                        `).join('');
                    } else {
                        list.innerHTML = '<p class="text-sm text-muted text-center" style="padding:10px">Nenhum item lançado.</p>';
                    }
                },
                addItem: async () => {
                    const term = document.getElementById('waiter-prod-search').value;
                    if(!term) return alert("Digite o nome do produto");
                    
                    App.utils.toast("Buscando...", "info");
                    
                    // Busca produto pelo nome (case insensitive)
                    const { data } = await _sb.from('products')
                        .select('*')
                        .eq('store_id', App.state.storeId)
                        .ilike('nome', `%${term}%`)
                        .limit(5); // Traz até 5 resultados
                    
                    const resultBox = document.getElementById('waiter-search-results');
                    
                    if(data && data.length > 0) {
                        // Se tiver só 1 resultado exato, adiciona direto? Não, melhor listar pra evitar erro.
                        resultBox.style.display = 'block';
                        resultBox.innerHTML = data.map(p => `
                            <div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; background:#fff;" 
                                 onclick="App.waiter.confirmAdd('${p.id}', '${p.nome}', ${p.preco})">
                                <strong>${p.nome}</strong> - R$ ${p.preco.toFixed(2)}
                            </div>
                        `).join('');
                    } else {
                        alert("Produto não encontrado");
                        resultBox.style.display = 'none';
                    }
                },
                confirmAdd: async (id, nome, price) => {
                    // Adiciona o item na comanda
                    const { data: current } = await _sb.from('comandas').select('items').eq('id', App.state.currentComanda).single();
                    let currentItems = current.items || [];
                    
                    // Verifica se já tem o item pra somar quantidade
                    const existing = currentItems.find(i => i.id === id);
                    if(existing) {
                        existing.qtd += 1;
                    } else {
                        currentItems.push({ id: id, nome: nome, price: price, qtd: 1 });
                    }
                    
                    await _sb.from('comandas').update({ items: currentItems, status: 'aberta' }).eq('id', App.state.currentComanda);
                    
                    document.getElementById('waiter-search-results').style.display = 'none';
                    document.getElementById('waiter-prod-search').value = '';
                    App.utils.toast(`Adicionado: ${nome}`, 'success');
                    App.waiter.loadItems(App.state.currentComanda);
                    
                    // Atualiza a lista de mesas (para mudar cor pra vermelha/aberta)
                    App.waiter.loadTables();
                },
                printBill: () => {
                     // IMPRESSÃO DE CONFERÊNCIA (NÃO FISCAL)
                     const itemsHtml = document.getElementById('comanda-items-list').innerHTML;
                     const mesa = document.getElementById('comanda-title').innerText;
                     
                     const content = `
                        <div style="font-family: monospace; width: 300px; padding: 0 10px;">
                            <br>
                            <h3 style="text-align:center; margin:0;">CONFERÊNCIA</h3>
                            <p style="text-align:center; margin:5px 0;">${mesa}</p>
                            <p style="text-align:center; font-size:0.8rem;">${new Date().toLocaleString()}</p>
                            <hr style="border-top: 1px dashed black;">
                            ${itemsHtml}
                            <hr style="border-top: 1px dashed black;">
                            <p style="text-align:center; font-size:0.8rem;">* Não vale como documento fiscal *</p>
                            <br><br>
                        </div>
                    `;
                    const area = document.getElementById('printable-area');
                    area.innerHTML = content;
                    window.print();
                },
                sendToKitchen: () => {
                    // IMPRESSÃO PARA COZINHA
                    const itemsHtml = document.getElementById('comanda-items-list').innerHTML;
                    const mesa = document.getElementById('comanda-title').innerText;
                    
                    const content = `
                        <div style="font-family: monospace; width: 300px; padding: 0 10px;">
                            <br>
                            <h3 style="text-align:center; margin:0;">PEDIDO COZINHA</h3>
                            <p style="text-align:center; font-size:1.2rem; font-weight:bold; margin:5px 0;">${mesa}</p>
                            <p style="text-align:center;">${new Date().toLocaleTimeString()}</p>
                            <hr style="border-top: 2px solid black;">
                            <div style="font-size:1.1rem; font-weight:bold;">
                                ${itemsHtml}
                            </div>
                            <hr style="border-top: 2px solid black;">
                            <br>
                        </div>
                    `;
                    const area = document.getElementById('printable-area');
                    area.innerHTML = content;
                    window.print();
                    
                    document.getElementById('comanda-modal').style.display = 'none';
                    App.utils.toast("Enviado para cozinha!", "success");
                }
            },
           cart: {
            activeCoupon: null,
            storeSettings: null,

            // Ao abrir o carrinho
            open: async () => { 
                document.getElementById('cart-modal').style.display = 'flex'; 
                
                // Busca configurações da loja (taxa e endereço) para exibir
                if(App.state.cart.length > 0) {
                    const sid = App.state.cart[0].storeId;
                    const { data } = await _sb.from('stores').select('taxa_entrega_padrao, endereco_retirada').eq('id', sid).single();
                    App.cart.storeSettings = data;
                    
                    // Atualiza textos visuais do modal (Valor da taxa e Endereço de retirada)
                    const fee = data?.taxa_entrega_padrao || 0;
                    const labelFee = document.getElementById('label-delivery-fee');
                    if(labelFee) labelFee.innerText = `R$ ${parseFloat(fee).toFixed(2)}`;
                    
                    const txtPickup = document.getElementById('txt-pickup-addr');
                    if(txtPickup) txtPickup.innerText = data?.endereco_retirada || "Endereço não configurado";
                }

                // Reseta a visualização para o padrão (Entrega selecionada)
                const radioDelivery = document.getElementById('method-delivery');
                if(radioDelivery) radioDelivery.checked = true;
                
                App.cart.toggleAddressField(); // Chama para garantir que o campo de endereço apareça
                App.cart.render(); 
                App.cart.updateFloater(); 
            },

            // NOVA FUNÇÃO: Controla a visibilidade do campo de endereço vs Info de retirada
            toggleAddressField: () => {
                const isDelivery = document.getElementById('method-delivery')?.checked;
                const addrContainer = document.getElementById('delivery-address-container');
                const pickupInfo = document.getElementById('pickup-info-display');
                
                if (isDelivery) {
                    // Se for entrega: Mostra campo de endereço, esconde info da loja
                    if(addrContainer) addrContainer.style.display = 'block';
                    if(pickupInfo) pickupInfo.style.display = 'none';
                } else {
                    // Se for retirada: Esconde campo de endereço, mostra info da loja
                    if(addrContainer) addrContainer.style.display = 'none';
                    if(pickupInfo) pickupInfo.style.display = 'block';
                }
                App.cart.updateFloater(); // Recalcula o total (adiciona ou remove taxa)
            },
            
            add: (product, storeId) => {
                 if (App.state.cart.length > 0 && App.state.cart[0].storeId !== storeId) {
                     if(!confirm("Você tem itens de outra loja. Limpar carrinho?")) return;
                     App.state.cart = [];
                     App.cart.activeCoupon = null;
                 }
                 App.state.cart.push({ ...product, storeId });
                 App.utils.toast("Adicionado!", "success");
                 App.cart.updateFloater();
            },

            remove: (index) => { App.state.cart.splice(index, 1); App.cart.render(); App.cart.updateFloater(); },

            applyCoupon: async () => {
                const code = document.getElementById('cart-coupon-input').value.toUpperCase().trim();
                if(!code || App.state.cart.length === 0) return;
                const storeId = App.state.cart[0].storeId;
                
                const { data, error } = await _sb.from('coupons').select('*').eq('code', code).eq('store_id', storeId).eq('active', true).single();
                const msg = document.getElementById('coupon-msg');
                
                if(error || !data) {
                    msg.innerHTML = '<span style="color:red">Inválido.</span>';
                    App.cart.activeCoupon = null;
                } else {
                    msg.innerHTML = `<span style="color:green">-${data.percent}% OFF em Roupas!</span>`;
                    App.cart.activeCoupon = data;
                    App.cart.updateFloater(); 
                    App.cart.render();
                }
            },

            render: () => {
                 const container = document.getElementById('cart-items-list');
                 if(App.state.cart.length === 0) {
                     container.innerHTML = '<p class="text-center text-muted">Vazio.</p>';
                     document.getElementById('cart-total-modal').innerText = "R$ 0,00";
                     return;
                 }
                 
                 container.innerHTML = App.state.cart.map((item, idx) => {
                     let price = item.preco;
                     let discountHtml = '';
                     if(App.cart.activeCoupon && item.categoria === 'Roupas') {
                         const discount = price * (App.cart.activeCoupon.percent / 100);
                         price -= discount;
                         discountHtml = `<span class="text-xs" style="color:green;">-${App.cart.activeCoupon.percent}%</span>`;
                     }
                     return `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><div><b>${item.nome}</b><br><span class="text-xs">R$ ${item.preco.toFixed(2)} ${discountHtml}</span></div><button class="btn btn-sm btn-danger" onclick="App.cart.remove(${idx})">X</button></div>`;
                 }).join('');
                 
                 App.cart.updateFloater(); 
            },

            calculateTotal: () => {
                let productsTotal = 0;
                App.state.cart.forEach(item => {
                    let p = item.preco;
                    if(App.cart.activeCoupon && item.categoria === 'Roupas') {
                         p = p - (p * (App.cart.activeCoupon.percent / 100));
                    }
                    productsTotal += p;
                });

                const isDelivery = document.getElementById('method-delivery')?.checked;
                let deliveryFee = 0;
                
                if(isDelivery && App.cart.storeSettings) {
                    deliveryFee = parseFloat(App.cart.storeSettings.taxa_entrega_padrao || 0);
                }

                return { productsTotal, deliveryFee, finalTotal: productsTotal + deliveryFee };
            },

            updateFloater: () => {
                 const floater = document.getElementById('cart-floater');
                 if(App.state.cart.length > 0) {
                     floater.style.display = 'flex';
                     const totals = App.cart.calculateTotal();
                     
                     document.getElementById('cart-count').innerText = `${App.state.cart.length} itens`;
                     document.getElementById('cart-total').innerText = `R$ ${totals.finalTotal.toFixed(2)}`;
                     
                     const modalTotal = document.getElementById('cart-total-modal');
                     if(modalTotal) modalTotal.innerText = `R$ ${totals.finalTotal.toFixed(2)}` + (totals.deliveryFee > 0 ? ` (Frete: R$ ${totals.deliveryFee})` : '');
                 } else floater.style.display = 'none';
            },

            checkout: async () => {
                 if(App.state.cart.length === 0) return;
                 
                 const totals = App.cart.calculateTotal();
                 const isDelivery = document.getElementById('method-delivery').checked;
                 const storeId = App.state.cart[0].storeId;
                 
                 let address = "";
                 
                 if(isDelivery) {
                     // LÓGICA NOVA: Pega o valor do input HTML (textarea)
                     const inputAddr = document.getElementById('cart-delivery-address');
                     const val = inputAddr ? inputAddr.value.trim() : "";
                     
                     if(!val) return alert("Por favor, preencha o campo 'Endereço de Entrega' acima.");
                     
                     address = `ENTREGA: ${val}`;
                 } else {
                     const pickupAddr = App.cart.storeSettings?.endereco_retirada || "Loja";
                     address = `RETIRADA NA LOJA (${pickupAddr})`;
                     if(!confirm(`Confirma a RETIRADA em:\n${pickupAddr}\n\nTotal: R$ ${totals.finalTotal.toFixed(2)}`)) return;
                 }

                 document.getElementById('cart-modal').style.display = 'none';
                 App.utils.toast("Iniciando pagamento...", "info");
                 
                 const { data: storeData } = await _sb.from('stores').select('mp_public_key').eq('id', storeId).single();
                 const publicKeyToUse = (storeData && storeData.mp_public_key) ? storeData.mp_public_key : CONFIG.adminPublicKey;
                 mpInstance = new MercadoPago(publicKeyToUse);
                 
                 const itemsDesc = App.state.cart.map(i => i.nome).join(', ');
                 
                 App.payment.open(totals.finalTotal, { 
                     product_id: App.state.cart[0].id, 
                     store_id: storeId, 
                     basePrice: totals.finalTotal, 
                     address: `${address} (Itens: ${itemsDesc})`, 
                     requer_montagem: false, 
                     taxa: totals.finalTotal * 0.15 
                 });
                 
                 App.state.cart = [];
                 App.cart.activeCoupon = null;
                 App.cart.updateFloater();
                 
                 // Limpa o campo de texto para a próxima vez
                 if(document.getElementById('cart-delivery-address')) {
                     document.getElementById('cart-delivery-address').value = "";
                 }
            }
        },
            catalog: {
            currentCat: 'Todos',
            filter: (cat, btn) => {
                document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active'));
                if(btn) btn.classList.add('active');
                App.catalog.currentCat = cat;
                App.catalog.load();
            },
            load: async () => {
                let query = _sb.from('products').select('*, stores(nome_loja)');
                if(App.catalog.currentCat !== 'Todos') query = query.eq('categoria', App.catalog.currentCat);
                const { data } = await query;
                const promos = data?.filter(p => p.promocao);
                const normal = data?.filter(p => !p.promocao);
                let html = '';
                if(promos && promos.length > 0) {
                    html += `<div style="grid-column:1/-1; margin-bottom:10px;"><h3 style="color:var(--danger)">🔥 Ofertas em Destaque</h3></div>`;
                    html += promos.map(p => App.catalog.renderCard(p)).join('');
                    if(normal && normal.length > 0) html += `<div style="grid-column:1/-1; margin:20px 0 10px 0;"><h3 style="color:var(--primary)">Outros Serviços</h3></div>`;
                }
                html += normal?.map(p => App.catalog.renderCard(p)).join('');
                document.getElementById('public-catalog').innerHTML = html || '<p style="grid-column:1/-1; text-align:center">Nenhuma oferta nesta categoria.</p>';
            },
            renderCard: (p) => {
                let dispInfo = '';
                let actionText = "Adicionar ao Carrinho"; 
                
                // CORREÇÃO DO ERRO DE SINTAXE:
                // Tratamento para impedir que aspas ou enter quebrem o site
                const pSafe = JSON.stringify(p)
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, "&#39;") // Corrige erro da aspa simples
                    .replace(/\n/g, " ");   // Remove quebras de linha
                    
                const dSafe = JSON.stringify(p.delivery_info || null)
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, "&#39;");
                
                // LISTA DE O QUE É SERVIÇO (Usa a caixa de diálogo antiga)
                const serviceCats = ['Serviços de Gesso', 'Hoteis/Pousadas', 'Manutenção Eletrodomésticos', 'Serviços de Manutenção', 'Serviços de Pedreiros', 'Serviços de Pintores', 'Fretes e Mudanças', 'Jardinagem'];

                let onclick = '';
                
                if (serviceCats.includes(p.categoria)) {
                    // SE FOR SERVIÇO: Usa a lógica antiga (Prompt)
                    actionText = "Contratar Serviço";
                    onclick = `App.client.confirmOrder("${p.id}", "${p.store_id}", ${p.preco}, "${p.categoria}", '${dSafe}')`;
                } else {
                    // SE FOR PRODUTO (Qualquer outro): Vai pro Carrinho (Novo Campo)
                    actionText = (p.categoria === 'Comidas' || p.categoria === 'Bebidas') ? "Fazer Pedido" : "Comprar";
                    onclick = `App.cart.add(${pSafe}, "${p.store_id}")`;
                }
                
                // LÓGICA ESPECIAL PARA ROUPAS
                let sizeSelectorHtml = '';
                if(p.categoria === 'Roupas' && p.sizes) {
                    const sizesArr = p.sizes.split(',').map(s => s.trim());
                    const options = sizesArr.map(s => `<option value="${s}">${s}</option>`).join('');
                    sizeSelectorHtml = `
                        <div style="margin-top:5px;">
                            <label class="text-xs">Tamanho:</label>
                            <select id="size-select-${p.id}" class="input-field" style="padding:5px; height:auto; font-size:0.9rem;">
                                ${options}
                            </select>
                        </div>
                    `;
                    // Roupas usa função especial
                    onclick = `App.catalog.addToCartClothing('${p.id}', '${p.store_id}', this)`;
                }
                
                // LÓGICA ESPECIAL PARA HOTEIS
                if(p.categoria === 'Hoteis/Pousadas') {
                    if(p.disponibilidade) {
                        const [start, end] = p.disponibilidade.split('|');
                        const fmt = d => d.split('-').reverse().join('/');
                        dispInfo = `<div class="text-xs" style="background:#f0f9ff; padding:5px; border-radius:4px; margin-top:5px; color:#0369a1;">📅 Disp: ${fmt(start)} até ${fmt(end)}</div>`;
                        onclick = `App.client.confirmOrder("${p.id}", "${p.store_id}", ${p.preco}, "${p.categoria}", null)`;
                    }
                } 
                // LÓGICA ESPECIAL PARA GESSO
                else if (p.categoria === 'Serviços de Gesso' && p.gesso_info) {
                    actionText = "Orçamento";
                    onclick = `App.client.openBudget(${pSafe})`;
                    dispInfo = `<div class="text-xs" style="color:#854d0e; margin-top:5px;">Orçamento por m²</div>`;
                }
                
                let actionBtn = `<button class="btn ${serviceCats.includes(p.categoria)?'btn-secondary':'btn-success'} btn-full" style="margin-top:10px" onclick='${onclick}'>${actionText}</button>`;
                let chatBtn = `<button class="btn btn-sm btn-info" style="margin-top:5px; width:100%;" onclick="App.chat.open('${p.store_id}')"><i class="ri-chat-1-line"></i> Dúvidas</button>`;

                let imagesHtml = '';
                if (p.galeria && Array.isArray(p.galeria) && p.galeria.length > 1) {
                    const imgs = p.galeria.map(url => `<img src="${url}" class="gallery-img" loading="lazy">`).join('');
                    imagesHtml = `<div class="product-gallery-wrapper"><div class="product-gallery">${imgs}</div><div class="gallery-badge"><i class="ri-image-line"></i> ${p.galeria.length} fotos</div></div>`;
                } else {
                    const imgUrl = (p.galeria && p.galeria.length > 0) ? p.galeria[0] : (p.imagem_url || 'https://placehold.co/400x300?text=Sem+Foto');
                    imagesHtml = `<div class="product-gallery-wrapper"><div class="product-gallery"><img src="${imgUrl}" class="gallery-img"></div></div>`;
                }

                return `
                    <div class="card">
                        ${p.promocao ? '<div class="badge badge-promo">PROMOÇÃO</div>' : ''}
                        ${imagesHtml}
                        <div class="badge status-aceito" style="margin-bottom:0.5rem">${p.stores?.nome_loja}</div>
                        <h4>${p.nome}</h4>
                        
                        ${p.descricao ? `<p class="text-sm text-muted" style="margin-bottom:5px; line-height:1.2;">${p.descricao}</p>` : ''}
                        
                        <h2 style="color:var(--primary)">R$ ${p.preco.toFixed(2)}</h2>
                        
                        ${sizeSelectorHtml} 
                        
                        ${dispInfo}
                        ${actionBtn}
                        ${chatBtn}
                    </div>`;
            },
            
            fetchPublic: async () => { App.catalog.load(); },

            addToCartClothing: async (pid, sid, btnElement) => {
                const { data: p } = await _sb.from('products').select('*').eq('id', pid).single();
                
                const select = document.getElementById(`size-select-${pid}`);
                if(!select) return; 
                const tamanho = select.value;

                const prodToAdd = { ...p, nome: `${p.nome} (Tam: ${tamanho})` };
                
                App.cart.add(prodToAdd, sid);
            }

        }, // <--- AQUI FECHA O CATALOG
            
            chat: {
                open: async (storeId, clientId = null) => {
                    if(!App.state.user) return App.router.go('auth');
                    App.state.activeChatStore = storeId;
                    App.state.activeChatClient = clientId || App.state.user.id; 
                    document.getElementById('chat-modal').style.display = 'flex';
                    const msgs = document.getElementById('chat-msgs');
                    msgs.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Carregando histórico...</div>';
                    
                    const { data } = await _sb.from('messages').select('*').eq('store_id', storeId).eq('client_id', App.state.activeChatClient).order('created_at', { ascending: true });
                    msgs.innerHTML = '';
                    if(data && data.length > 0) data.forEach(m => App.chat.renderMsg(m));
                    else msgs.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Inicie a conversa...</div>';

                    if(App.state.chatSub) _sb.removeChannel(App.state.chatSub);
                    App.state.chatSub = _sb.channel('public:messages')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'messages', filter: `store_id=eq.${storeId}` }, (payload) => {
                            if(payload.new.client_id === App.state.activeChatClient) {
                                if (payload.eventType === 'INSERT') {
                                    if(msgs.innerText.includes("Inicie a conversa")) msgs.innerHTML = "";
                                    App.chat.renderMsg(payload.new);
                                } else if (payload.eventType === 'UPDATE') {
                                    const msgDiv = document.getElementById(`msg-${payload.new.id}`);
                                    if(msgDiv) {
                                        if (payload.new.is_deleted) msgDiv.innerHTML = `<span class="chat-deleted"><i class="ri-prohibited-line"></i> Mensagem apagada</span>`;
                                        else {
                                            let contentHtml = payload.new.content;
                                            if (payload.new.is_edited) contentHtml += `<span class="chat-edited-label"><i class="ri-pencil-line"></i> Editada</span>`;
                                            if (msgDiv.classList.contains('mine')) {
                                                 const encodedContent = encodeURIComponent(payload.new.content);
                                                 contentHtml += `<button class="chat-options-btn" onclick="App.chat.showOptions(${payload.new.id}, '${encodedContent}', ${payload.new.is_edited})"><i class="ri-more-2-fill"></i></button>`;
                                            }
                                            msgDiv.innerHTML = contentHtml;
                                        }
                                    }
                                }
                            }
                        }).subscribe();
                },
                loadHistory: async (viewType) => {
                    if (!App.state.user) return;
                    const myId = App.state.user.id;
                    let html = '';
                    let query = _sb.from('messages').select('*, profiles:sender_id(nome_completo), stores:store_id(nome_loja)').order('created_at', {ascending:false}).limit(50);
                    if(viewType === 'loja') query = query.eq('store_id', App.state.storeId);
                    else query = query.eq('client_id', myId);
                    const { data } = await query;
                    
                    if(!data || data.length === 0) html = '<p class="text-sm text-muted">Nenhuma conversa.</p>';
                    else {
                        const unique = new Set();
                        data.forEach(msg => {
                            let cid = (viewType === 'loja') ? msg.client_id : msg.store_id;
                            if(!unique.has(cid)) {
                                unique.add(cid);
                                let name = (viewType === 'loja') ? (msg.sender_id !== myId ? msg.profiles?.nome_completo : 'Cliente') : (msg.stores?.nome_loja || 'Loja');
                                html += `<div class="chat-history-item" onclick="App.chat.open('${viewType==='loja'?App.state.storeId:cid}', '${viewType==='loja'?cid:myId}')"><div class="chat-user-info"><div><i class="ri-message-3-line"></i> ${name}</div><div class="text-xs">Abrir conversa</div></div><i class="ri-arrow-right-s-line"></i></div>`;
                            }
                        });
                    }
                    document.getElementById(viewType === 'loja' ? 'store-chat-list' : 'client-chat-list').innerHTML = html;
                },
                send: async (content = null, type = 'text') => {
                    const txtInput = document.getElementById('chat-input');
                    const txt = content || txtInput.value;
                    if(!txt && type === 'text') return;
                    await _sb.from('messages').insert({ store_id: App.state.activeChatStore, client_id: App.state.activeChatClient, sender_id: App.state.user.id, content: txt });
                    if(type === 'text') txtInput.value = '';
                },
                recordAudio: async () => {
                    if (!navigator.mediaDevices) return alert("Navegador sem suporte a áudio.");
                    if (!App.state.mediaRecorder) {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        App.state.mediaRecorder = new MediaRecorder(stream);
                        App.state.mediaRecorder.ondataavailable = e => App.state.audioChunks.push(e.data);
                        App.state.mediaRecorder.onstop = async () => {
                            const blob = new Blob(App.state.audioChunks, { type: 'audio/ogg; codecs=opus' });
                            App.state.audioChunks = [];
                            const fileName = `audio_${Date.now()}.ogg`;
                            const { data, error } = await _sb.storage.from('chat_uploads').upload(fileName, blob);
                            if(!error) {
                                const { data: url } = _sb.storage.from('chat_uploads').getPublicUrl(fileName);
                                App.chat.send(`<audio controls src="${url.publicUrl}"></audio>`, 'audio');
                            } else alert("Erro upload áudio");
                        };
                        App.state.mediaRecorder.start();
                        App.utils.toast("Gravando... Toque de novo para enviar.", "info");
                    } else {
                        if(App.state.mediaRecorder.state === 'recording') { App.state.mediaRecorder.stop(); App.utils.toast("Enviando...", "success"); }
                        else { App.state.mediaRecorder.start(); App.utils.toast("Gravando...", "info"); }
                    }
                },
                showOptions: (msgId, encodedContent, isEdited) => {
                    const currentContent = decodeURIComponent(encodedContent);
                    if (currentContent.includes('<audio')) {
                        if(confirm("Deseja apagar este áudio para todos?")) App.chat.deleteMsg(msgId);
                        return;
                    }
                    const action = prompt("Digite 'apagar' para excluir ou digite o novo texto para editar:", currentContent);
                    if (action === null) return; 
                    if (action.toLowerCase() === 'apagar') App.chat.deleteMsg(msgId);
                    else if (action !== currentContent) {
                        if (isEdited) alert("Esta mensagem já foi editada uma vez e não pode ser alterada novamente.");
                        else App.chat.editMsg(msgId, action);
                    }
                },
                deleteMsg: async (id) => {
                    const { error } = await _sb.from('messages').update({ is_deleted: true, content: '🚫 Mensagem apagada' }).eq('id', id);
                    if(error) alert("Erro ao apagar: " + error.message);
                },
                editMsg: async (id, newContent) => {
                    const { error } = await _sb.from('messages').update({ content: newContent, is_edited: true }).eq('id', id);
                    if(error) alert("Erro ao editar: " + error.message);
                },
                renderMsg: (msg) => {
                    const div = document.createElement('div');
                    const isMine = msg.sender_id === App.state.user.id;
                    div.className = `chat-bubble ${isMine ? 'mine' : 'theirs'}`;
                    div.id = `msg-${msg.id}`;
                    
                    if (msg.is_deleted) div.innerHTML = `<span class="chat-deleted"><i class="ri-prohibited-line"></i> Mensagem apagada</span>`;
                    else {
                        let contentHtml = msg.content;
                        if (msg.is_edited) contentHtml += `<span class="chat-edited-label"><i class="ri-pencil-line"></i> Editada</span>`;
                        if (isMine) {
                             const encodedContent = encodeURIComponent(msg.content);
                             contentHtml += `<button class="chat-options-btn" onclick="App.chat.showOptions(${msg.id}, '${encodedContent}', ${msg.is_edited})"><i class="ri-more-2-fill"></i></button>`;
                        }
                        div.innerHTML = contentHtml;
                    }
                    const status = document.createElement('div');
                    status.className = 'chat-status';
                    status.innerHTML = `<i class="ri-check-double-line" style="color:${isMine ? '#fff' : '#2563eb'}"></i>`;
                    div.appendChild(status);
                    const container = document.getElementById('chat-msgs');
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;
                },
                close: () => {
                    document.getElementById('chat-modal').style.display = 'none';
                    if(App.state.chatSub) _sb.removeChannel(App.state.chatSub);
                }
            },

            map: {
                open: (id, isDriver, addr='') => {
                    App.state.activeOrder = id; document.getElementById('map-modal').style.display='flex';
                    const dest = document.getElementById('map-dest-address'); if(isDriver) { dest.innerHTML=`<strong>Destino:</strong> ${addr}`; dest.style.display='block'; } else dest.style.display='none';
                    document.getElementById('btn-start-gps').style.display = isDriver ? 'block' : 'none'; document.getElementById('btn-end-gps').style.display = 'none';
                    setTimeout(() => {
                        if(!App.state.mapInstance) { App.state.mapInstance = L.map('map').setView([-23.5505, -46.6333], 13); let tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'; if (CONFIG.mapboxToken.includes('pk.')) tileUrl = `https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${CONFIG.mapboxToken}`; L.tileLayer(tileUrl, { attribution: 'Mapbox / OpenStreetMap' }).addTo(App.state.mapInstance); }
                        App.state.mapInstance.invalidateSize(); if(!isDriver) App.map.watchOrder(id);
                    }, 500);
                },
                watchOrder: (id) => { 
                    _sb.channel(`track-${id}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${id}` }, (payload) => { 
                        const { lat_atual, lng_atual, status } = payload.new; 
                        if(status==='em_rota') App.utils.toast('Saiu para entrega!', 'info'); 
                        if(status==='concluido') { App.utils.toast('Entrega Finalizada!', 'success'); document.getElementById('map-status-badge').innerText="Concluído"; } 
                        if(lat_atual && lng_atual) App.map.updatePin(lat_atual, lng_atual); 
                    }).subscribe(); 
                },
                startGPS: () => { 
                    document.getElementById('btn-start-gps').style.display='none'; document.getElementById('btn-end-gps').style.display='block'; 
                    _sb.from('orders').update({ status: 'em_rota' }).eq('id', App.state.activeOrder); 
                    App.state.watchId = navigator.geolocation.watchPosition(async (pos) => { 
                        App.map.updatePin(pos.coords.latitude, pos.coords.longitude); 
                        await _sb.from('orders').update({ lat_atual: pos.coords.latitude, lng_atual: pos.coords.longitude }).eq('id', App.state.activeOrder); 
                    }, null, {enableHighAccuracy:true}); 
                },
                finishDelivery: async () => { if(confirm("Confirmar entrega?")) { navigator.geolocation.clearWatch(App.state.watchId); await _sb.from('orders').update({ status: 'concluido' }).eq('id', App.state.activeOrder); App.utils.toast("Finalizado!", "success"); App.map.close(); App.provider.init(); } },
                updatePin: (lat, lng) => { if(App.state.marker) App.state.marker.setLatLng([lat,lng]); else App.state.marker=L.marker([lat,lng]).addTo(App.state.mapInstance); App.state.mapInstance.setView([lat,lng], 16); },
                close: () => { document.getElementById('map-modal').style.display='none'; if(App.state.watchId) navigator.geolocation.clearWatch(App.state.watchId); _sb.removeAllChannels(); }
            },

            utils: {
                toast: (msg, type='success') => { const c = document.getElementById('toast-container'); const e = document.createElement('div'); e.className=`toast ${type}`; e.innerHTML=`<span>${msg}</span>`; c.appendChild(e); setTimeout(()=>e.remove(), 4000); },
                
                // NOTIFICAÇÃO DO LOJISTA
                showChatNotification: (name, msg, clientId) => {
                    const c = document.getElementById('store-notifications');
                    const e = document.createElement('div');
                    e.className = 'chat-alert-card';
                    e.innerHTML = `
                        <div>
                            <div style="font-weight:bold; color:var(--primary)">Nova mensagem de ${name}</div>
                            <div style="font-size:0.9rem; color:var(--text-muted); margin-top:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">"${msg}"</div>
                        </div>
                        <button class="btn btn-sm btn-info" onclick="App.chat.open('${App.state.storeId}', '${clientId}'); this.parentElement.remove()">Responder</button>
                    `;
                    c.appendChild(e);
                    setTimeout(() => e.remove(), 10000);
                },

                setupPWA: () => { const manifest = { "name": "NexLog", "short_name": "NexLog", "start_url": window.location.href, "display": "standalone", "background_color": "#ffffff", "theme_color": "#2563eb", "icons": [{ "src": "https://raw.githubusercontent.com/PazChurchParaipaba/projetoentrega/refs/heads/main/logo.png", "sizes": "192x192", "type": "image/png" }] }; const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'}); document.querySelector('#dynamic-manifest').setAttribute('href', URL.createObjectURL(blob)); window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); App.state.deferredPrompt = e; document.getElementById('pwa-banner').style.display = 'flex'; }); },
                setupCategories: () => {
                    const catList = document.getElementById('category-list');
                    const catSelect = document.getElementById('new-prod-cat');
                    CONFIG.categories.forEach(c => {
                        catList.innerHTML += `<button class="cat-pill" onclick="App.catalog.filter('${c}', this)">${c}</button>`;
                        catSelect.innerHTML += `<option value="${c}">${c}</option>`;
                    });
                }
            }
        };
        window.addEventListener('load', App.init);
    </script>
</body>
</html>
