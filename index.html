<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="NexLog - Log√≠stica inteligente para qualquer tipo de servi√ßo e entrega.">
    <title>NexLog | Sistema Integrado</title>
    
    <link rel="manifest" id="dynamic-manifest">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/2563eb/white?text=NX">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #eff6ff;
            --secondary: #64748b;
            --surface: #ffffff;
            --background: #f8fafc;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --success: #10b981;
            --success-bg: #dcfce7;
            --warning: #f59e0b;
            --warning-bg: #fef3c7;
            --danger: #ef4444;
            --danger-bg: #fee2e2;
            --info: #0ea5e9;
            --info-bg: #e0f2fe;
            --radius-sm: 8px;
            --radius-md: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --nav-height: 70px;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 80px; 
            overflow-x: hidden;
        }

        /* --- UI COMPONENTS --- */
        h1, h2, h3, h4 { 
            font-weight: 700; 
            letter-spacing: -0.025em; 
            line-height: 1.2; 
            margin-bottom: 0.5rem; 
        }

        p { 
            color: var(--text-muted); 
            line-height: 1.6; 
            margin-bottom: 1rem; 
        }

        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }

        .btn {
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem;
            padding: 0.75rem 1.5rem; 
            border-radius: var(--radius-sm); 
            font-weight: 600; 
            font-size: 0.95rem;
            cursor: pointer; 
            transition: var(--transition); 
            border: none; 
            outline: none; 
            position: relative; 
            overflow: hidden;
        }
        
        .btn:active { transform: scale(0.98); }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); 
        }
        
        .btn-primary:hover { 
            background: var(--primary-dark); 
        }
        
        .btn-secondary { 
            background: white; 
            border: 1px solid var(--border); 
            color: var(--text-main); 
        }
        
        .btn-secondary:hover { 
            border-color: var(--primary); 
            color: var(--primary); 
            background: var(--primary-light); 
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-full { width: 100%; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }

        .input-wrapper { 
            margin-bottom: 1.25rem; 
            text-align: left; 
        }
        
        .input-wrapper label { 
            display: block; 
            margin-bottom: 0.5rem; 
            font-size: 0.9rem; 
            font-weight: 600; 
            color: var(--text-main); 
        }
        
        .input-field {
            width: 100%; 
            padding: 0.875rem 1rem; 
            border: 1px solid var(--border); 
            border-radius: var(--radius-sm);
            background: white; 
            font-size: 1rem; 
            transition: var(--transition); 
            font-family: inherit;
        }
        
        .input-field:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
            outline: none; 
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 2rem 1.5rem; 
        }
        
        .card {
            background: var(--surface); 
            border-radius: var(--radius-md); 
            padding: 1.5rem;
            border: 1px solid var(--border); 
            box-shadow: var(--shadow-sm); 
            transition: var(--transition);
            position: relative; 
            overflow: hidden;
        }
        
        .card:hover { 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-md); 
            border-color: #cbd5e1; 
        }
        
        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        
        .badge {
            display: inline-flex; 
            align-items: center; 
            padding: 0.25rem 0.75rem; 
            border-radius: 99px;
            font-size: 0.75rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
        }
        
        .status-pendente { background: var(--warning-bg); color: #b45309; }
        .status-aceito { background: var(--info-bg); color: #0369a1; }
        .status-em_rota { background: #dbeafe; color: #1e40af; animation: pulse 2s infinite; }
        .status-concluido { background: var(--success-bg); color: #15803d; }
        
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); } 
            70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } 
        }

        /* HEADER */
        header {
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); 
            padding: 0 5%; 
            height: var(--nav-height);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            position: sticky; 
            top: 0; 
            z-index: 100;
        }
        
        .brand { 
            font-size: 1.5rem; 
            font-weight: 800; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        
        .brand i { font-size: 1.75rem; }

        /* MOBILE NAV */
        .bottom-nav {
            display: none; 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: white;
            border-top: 1px solid var(--border); 
            padding: 0.5rem 0; 
            z-index: 90;
            justify-content: space-around; 
            align-items: center;
        }
        
        .nav-item {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 2px;
            font-size: 0.7rem; 
            color: var(--text-muted); 
            padding: 0.5rem; 
            cursor: pointer;
        }
        
        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        
        @media (max-width: 768px) {
            .bottom-nav { display: flex; }
            .desktop-only { display: none !important; }
        }

        /* SPA VIEWS */
        .view-section { 
            display: none; 
            animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        
        .view-section.active { display: block; }
        
        @keyframes fadeUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* AUTH & SPECIALS */
        .auth-card { 
            max-width: 420px; 
            margin: 3rem auto; 
            text-align: center; 
            padding: 2.5rem; 
        }
        
        .role-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
            margin-top: 2rem; 
        }
        
        .role-card {
            border: 2px solid var(--border); 
            border-radius: var(--radius-md); 
            padding: 1.5rem;
            cursor: pointer; 
            transition: var(--transition); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 0.5rem;
        }
        
        .role-card:hover { 
            border-color: var(--primary); 
            background: var(--primary-light); 
        }
        
        .role-card.selected { 
            border-color: var(--primary); 
            background: #dbeafe; 
            ring: 2px solid var(--primary); 
        }
        
        .role-card i { font-size: 2rem; color: var(--primary); }

        .camera-container {
            background: #000; 
            border-radius: var(--radius-md); 
            overflow: hidden; 
            position: relative;
            aspect-ratio: 4/3; 
            margin-bottom: 1rem; 
            display: none;
        }
        
        .camera-container video { width: 100%; height: 100%; object-fit: cover; }
        
        .camera-overlay {
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            padding: 1rem;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); 
            color: white; 
            text-align: center;
        }
        
        .modal-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 2000;
            display: none; 
            align-items: center; 
            justify-content: center;
        }
        
        .modal-content {
            background: white; 
            width: 90%; 
            max-width: 500px; 
            border-radius: var(--radius-md); 
            overflow: hidden;
            display: flex; 
            flex-direction: column; 
            max-height: 90vh;
        }
        
        .modal-header { 
            padding: 1rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
        }
        
        .modal-body { padding: 1rem; overflow-y: auto; }
        
        .modal-footer { 
            padding: 1rem; 
            border-top: 1px solid var(--border); 
            background: white; 
        }

        /* Map Specific */
        #map-modal .modal-content { height: 90%; }
        #map { flex: 1; width: 100%; background: #e2e8f0; min-height: 300px; }

        .toast-container { 
            position: fixed; 
            bottom: 90px; 
            right: 20px; 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            pointer-events: none; 
        }
        
        .toast {
            background: white; 
            padding: 1rem 1.5rem; 
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-md); 
            display: flex; 
            align-items: center; 
            gap: 12px;
            animation: slideInRight 0.3s forwards; 
            pointer-events: auto; 
            min-width: 300px;
            border-left: 4px solid var(--primary);
        }
        
        .toast.error { border-left-color: var(--danger); }
        .toast.success { border-left-color: var(--success); }
        .toast.info { border-left-color: var(--info); }
        
        @keyframes slideInRight { 
            from { transform: translateX(100%); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }

        .pwa-banner {
            position: fixed; 
            top: 80px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 90%; 
            max-width: 400px;
            background: var(--text-main); 
            color: white; 
            padding: 1rem; 
            border-radius: var(--radius-md);
            z-index: 999; 
            display: none; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: var(--shadow-md);
        }
        
        @keyframes spin { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>
    
    <div id="pwa-banner" class="pwa-banner">
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="ri-download-cloud-2-line" style="font-size:1.5rem"></i>
            <div>
                <div style="font-weight:bold">Instalar App</div>
                <div style="font-size:0.8rem; opacity:0.8">Acesso r√°pido na tela inicial</div>
            </div>
        </div>
        <button class="btn btn-sm btn-primary" onclick="App.pwa.install()">Instalar</button>
    </div>

    <header>
        <div class="brand">
            <i class="ri-truck-fill"></i> NexLog
        </div>
        <div id="header-actions" class="desktop-only"></div>
    </header>

    <main>
        <section id="view-home" class="view-section active">
            <div style="background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); padding: 4rem 1.5rem; text-align: center; margin-bottom: 2rem;">
                <div class="container">
                    <h1 style="font-size: 2.5rem; margin-bottom: 1rem; color: var(--text-main);">Log√≠stica Inteligente <br><span style="color:var(--primary)">Para Todos os Servi√ßos</span></h1>
                    <p style="max-width: 600px; margin: 0 auto 2rem auto; font-size: 1.1rem;">
                        Conectando grandes lojas a motoristas parceiros e prestadores de servi√ßo em todo o Brasil.
                        A solu√ß√£o completa para qualquer tipo de entrega.
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button class="btn btn-primary" onclick="App.router.go('auth')">Acessar Plataforma</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('catalog-anchor').scrollIntoView({behavior:'smooth'})">Ver Servi√ßos</button>
                    </div>
                </div>
            </div>
            <div class="container" id="catalog-anchor">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                    <h3>Destaques das Lojas</h3>
                    <span class="badge status-aceito">Ofertas Atualizadas</span>
                </div>
                <div id="public-catalog" class="grid grid-3">
                    <div class="card" style="text-align:center; padding:3rem;">
                        <i class="ri-loader-4-line" style="font-size:2rem; animation:spin 1s linear infinite"></i>
                        <p>Carregando cat√°logo...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-auth" class="view-section container">
            <div class="card auth-card">
                <div id="auth-state-login">
                    <h2 style="color:var(--primary); margin-bottom:0.5rem;">Bem-vindo</h2>
                    <p>Entre para gerenciar seus pedidos</p>
                    <div class="input-wrapper">
                        <label>Email</label>
                        <input type="email" id="login-email" class="input-field" placeholder="seu@email.com">
                    </div>
                    <div class="input-wrapper">
                        <label>Senha</label>
                        <input type="password" id="login-pass" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn btn-primary btn-full" onclick="App.auth.login()">Entrar no Sistema</button>
                    <div style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid var(--border);">
                        <p class="text-xs">N√£o possui conta?</p>
                        <button class="btn btn-secondary btn-full" onclick="App.auth.switchView('roles')">Criar Nova Conta</button>
                    </div>
                </div>
                <div id="auth-state-roles" style="display:none;">
                    <h3>Qual o seu perfil?</h3>
                    <p>Selecione como deseja usar a plataforma</p>
                    <div class="role-grid">
                        <div class="role-card" onclick="App.auth.startReg('cliente')">
                            <i class="ri-user-smile-line"></i>
                            <span class="font-bold">Cliente</span>
                        </div>
                        <div class="role-card" onclick="App.auth.startReg('loja_admin')">
                            <i class="ri-store-2-line"></i>
                            <span class="font-bold">Lojista</span>
                        </div>
                        <div class="role-card" onclick="App.auth.startReg('motorista')">
                            <i class="ri-truck-line"></i>
                            <span class="font-bold">Motorista</span>
                        </div>
                        <div class="role-card" onclick="App.auth.startReg('montador')">
                            <i class="ri-tools-line"></i>
                            <span class="font-bold">Prestador</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-full" style="margin-top:1.5rem" onclick="App.auth.switchView('login')">Voltar</button>
                </div>
                <div id="auth-state-register" style="display:none;">
                    <h3 id="reg-title">Cadastro</h3>
                    <p>Preencha seus dados para continuar</p>
                    <div class="input-wrapper"><label>Nome Completo</label><input type="text" id="reg-name" class="input-field"></div>
                    <div class="input-wrapper"><label>Email</label><input type="email" id="reg-email" class="input-field"></div>
                    <div class="input-wrapper"><label>Senha</label><input type="password" id="reg-pass" class="input-field"></div>
                    <div id="reg-dynamic-fields"></div>
                    <button class="btn btn-primary btn-full" onclick="App.auth.register()" id="btn-final-reg">Finalizar Cadastro</button>
                    <button class="btn btn-secondary btn-full" style="margin-top:0.5rem" onclick="App.auth.switchView('roles')">Voltar</button>
                </div>
            </div>
        </section>

        <section id="view-loja" class="view-section container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <div>
                    <h2>Gest√£o da Loja</h2>
                    <p>Controle de produtos e despachos</p>
                </div>
                <button class="btn btn-primary" onclick="App.store.openAddModal()">
                    <i class="ri-add-line"></i> Novo Servi√ßo/Produto
                </button>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <h4 style="margin-bottom:1rem; color:var(--primary)">Pedidos Pendentes</h4>
                    <div id="store-orders-list">
                        <p class="text-sm">Carregando pedidos...</p>
                    </div>
                </div>
                <div class="card">
                    <h4 style="margin-bottom:1rem; color:var(--text-muted)">Hist√≥rico de Vendas</h4>
                    <div id="store-history-list">
                        <p class="text-sm">Carregando hist√≥rico...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-cliente" class="view-section container">
            <div style="margin-bottom:2rem;">
                <h2>Meus Pedidos</h2>
                <p>Acompanhe suas compras e servi√ßos contratados</p>
            </div>
            <div id="client-orders-list" class="grid grid-2"></div>
            <div style="margin-top:2rem; text-align:center;">
                <button class="btn btn-secondary" onclick="App.router.go('home')">Ir para o Cat√°logo de Servi√ßos</button>
            </div>
        </section>

        <section id="view-provider" class="view-section container">
            <div class="card" style="background:var(--text-main); color:white; margin-bottom:2rem;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="color:white; margin-bottom:0.2rem;">Painel de Servi√ßos</h3>
                        <p style="color:rgba(255,255,255,0.7); margin:0;" id="provider-role-label">Parceiro</p>
                    </div>
                    <div class="badge status-aceito">Online</div>
                </div>
            </div>
            <h3>Oportunidades Dispon√≠veis</h3>
            <p>Servi√ßos pr√≥ximos aguardando aceite.</p>
            <div id="provider-jobs-list" class="grid grid-2"></div>
        </section>
    </main>

    <nav class="bottom-nav" id="mobile-nav"></nav>

    <div id="map-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3>Navega√ß√£o GPS</h3>
                    <p id="map-dest-address" class="text-xs text-muted" style="margin:0;"></p>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="App.map.close()">Fechar</button>
            </div>
            <div id="map"></div>
            <div class="modal-footer" id="map-footer">
                <div style="display:flex; gap:1rem; align-items:center;">
                    <div class="badge status-aceito" id="map-status-badge">Conectado</div>
                    <p style="margin:0; font-size:0.9rem;" id="map-status-text">Aguardando dados...</p>
                </div>
                <button id="btn-start-gps" class="btn btn-success btn-full" style="margin-top:1rem; display:none;" onclick="App.map.startGPS()">
                    <i class="ri-navigation-line"></i> Iniciar Rota
                </button>
                 <button id="btn-end-gps" class="btn btn-danger btn-full" style="margin-top:1rem; display:none;" onclick="App.map.finishDelivery()">
                    <i class="ri-flag-line"></i> Finalizar Entrega
                </button>
            </div>
        </div>
    </div>

    <div id="product-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar Servi√ßo/Produto</h3>
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('product-modal').style.display='none'">Fechar</button>
            </div>
            <div class="modal-body">
                <div class="input-wrapper">
                    <label>Nome do Item</label>
                    <input type="text" id="new-prod-name" class="input-field" placeholder="Ex: Transporte de Sof√°">
                </div>
                <div class="input-wrapper">
                    <label>Pre√ßo (R$)</label>
                    <input type="number" id="new-prod-price" class="input-field" placeholder="0.00">
                </div>
                <div class="input-wrapper">
                    <label>Foto do Item</label>
                    <input type="file" id="new-prod-file" class="input-field" accept="image/jpeg, image/png">
                    <p class="text-xs text-muted" style="margin-top:5px">Formatos: JPG ou PNG</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-full" onclick="App.store.submitProduct()">Salvar Servi√ßo</button>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Finalizar Compra</h3>
                <button class="btn btn-secondary btn-sm" onclick="App.payment.close()">Cancelar</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:1rem;">
                    <p>Total a pagar:</p>
                    <h2 id="pay-total-display" style="color:var(--primary); font-size:2rem;">R$ 0,00</h2>
                    <p class="text-xs text-muted" id="pay-detail-display"></p>
                </div>
                <div id="payment-brick_container"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO ---
        const CONFIG = {
            sbUrl: 'https://groezaseypdbpgymgpvo.supabase.co',
            sbKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdyb2V6YXNleXBkYnBneW1ncHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNjkxNjYsImV4cCI6MjA4MTY0NTE2Nn0.5U5QeoGmZn_i9Y8POoUCkatBUAdSW-cjHRyfxpm_pyM',
            
            // CHAVE DE PRODU√á√ÉO (Conforme sua imagem)
            mpPublicKey: 'APP_USR-834374cc-7e6d-494f-9842-49a7e3e57357',
            
            // Token Mapbox (Substitua pelo seu)
            mapboxToken: 'pk.eyJ1IjoiZXhhbXBsZXVzZXIiLCJhIjoiY2p5Y3Z6eG9jMDFlazNnbzQ4a3R4bWk4ZyJ9.ExampleTokenPlaceholder' 
        };
        
        const _sb = supabase.createClient(CONFIG.sbUrl, CONFIG.sbKey);
        const mp = new MercadoPago(CONFIG.mpPublicKey);

        const App = {
            state: {
                user: null,
                profile: null,
                tempRole: null,
                deferredPrompt: null,
                mapInstance: null,
                marker: null,
                watchId: null,
                activeOrder: null,
                storeId: null,
                pendingPayment: null,
                brickController: null
            },
            
            init: async () => {
                App.utils.setupPWA();
                const savedUser = localStorage.getItem('logimoveis_session');
                if(savedUser) {
                    const profile = JSON.parse(savedUser);
                    App.state.user = { id: profile.id };
                    App.state.profile = profile;
                    App.router.renderNav();
                    App.router.goDashboard();
                } else {
                    App.router.renderNav();
                    App.catalog.fetchPublic();
                }
            },

            pwa: {
                install: () => {
                    if (App.state.deferredPrompt) {
                        App.state.deferredPrompt.prompt();
                        App.state.deferredPrompt.userChoice.then(() => {
                            App.state.deferredPrompt = null;
                            document.getElementById('pwa-banner').style.display = 'none';
                        });
                    }
                }
            },

            router: {
                go: (viewId) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                    document.getElementById(`view-${viewId}`).classList.add('active');
                    window.scrollTo(0,0);
                    App.router.renderNav();
                    if(viewId === 'home') App.catalog.fetchPublic();
                },
                renderNav: () => {
                    const header = document.getElementById('header-actions');
                    const mobile = document.getElementById('mobile-nav');
                    if(App.state.user && App.state.profile) {
                        header.innerHTML = `<div style="display:flex; align-items:center; gap:1rem;"><div class="text-xs text-muted desktop-only">${App.state.profile.nome_completo}</div><button class="btn btn-secondary btn-sm" onclick="App.router.goDashboard()">Painel</button><button class="btn btn-danger btn-sm" onclick="App.auth.logout()">Sair</button></div>`;
                        mobile.innerHTML = `<div class="nav-item" onclick="App.router.go('home')"><i class="ri-store-line"></i><span>Loja</span></div><div class="nav-item active" onclick="App.router.goDashboard()"><i class="ri-dashboard-line"></i><span>Painel</span></div><div class="nav-item" onclick="App.auth.logout()"><i class="ri-logout-box-line"></i><span>Sair</span></div>`;
                    } else {
                        header.innerHTML = `<button class="btn btn-primary btn-sm" onclick="App.router.go('auth')">Entrar / Cadastrar</button>`;
                        mobile.innerHTML = `<div class="nav-item active" onclick="App.router.go('home')"><i class="ri-store-line"></i><span>In√≠cio</span></div><div class="nav-item" onclick="App.router.go('auth')"><i class="ri-user-line"></i><span>Conta</span></div>`;
                    }
                },
                goDashboard: () => {
                    const role = App.state.profile?.role;
                    if(role === 'loja_admin') { App.store.init(); App.router.go('loja'); }
                    else if(role === 'cliente') { App.client.init(); App.router.go('cliente'); }
                    else if(role === 'motorista' || role === 'montador') { App.provider.init(); App.router.go('provider'); }
                    else App.router.go('home');
                }
            },

            auth: {
                switchView: (view) => {
                    ['login', 'roles', 'register'].forEach(v => document.getElementById(`auth-state-${v}`).style.display = 'none');
                    document.getElementById(`auth-state-${view}`).style.display = 'block';
                },
                startReg: (role) => {
                    App.state.tempRole = role;
                    document.getElementById('reg-title').innerText = `Cadastro - ${role === 'loja_admin' ? 'Lojista' : role.toUpperCase()}`;
                    App.auth.switchView('register');
                    
                    const container = document.getElementById('reg-dynamic-fields');
                    let html = '';
                    
                    if(role === 'loja_admin') {
                        // Seguran√ßa de Token mantida (Banco de dados)
                        html = `
                            <div class="input-wrapper"><label>Nome da Loja</label><input id="reg-store-name" class="input-field" placeholder="Ex: NexLog Center"></div>
                            <div class="input-wrapper"><label>CNPJ</label><input id="reg-cnpj" class="input-field" placeholder="00.000.000/0000-00"></div>
                            <div class="input-wrapper" style="border: 2px dashed var(--primary); padding: 10px; border-radius: 8px; background: var(--primary-light);">
                                <label style="color:var(--primary)">üîë Token de Autoriza√ß√£o</label>
                                <input id="reg-token" class="input-field" placeholder="C√≥digo fornecido pelo Admin">
                                <p class="text-xs text-muted">Cadastro restrito. Insira sua matr√≠cula/token.</p>
                            </div>
                        `;
                    } else if (role === 'motorista') {
                        html = `
                            <div class="input-wrapper"><label>CPF</label><input id="reg-cpf" class="input-field" placeholder="000.000.000-00"></div>
                            <div class="camera-container" id="cam-box"><video id="cam-video" autoplay playsinline></video><div class="camera-overlay">Selfie com capacete (valida√ß√£o facial)</div></div>
                            <div id="verified-msg" style="display:none; color:var(--success); font-weight:bold; margin-bottom:1rem;">‚úÖ Identidade Confirmada</div>
                            <button class="btn btn-secondary btn-full" id="btn-cam" onclick="App.auth.runCamera()">Validar Identidade (Obrigat√≥rio)</button>
                        `;
                    } else if (role === 'cliente') {
                         html = `<div class="input-wrapper"><label>CPF</label><input id="reg-cpf" class="input-field" placeholder="000.000.000-00"></div>`;
                    }
                    container.innerHTML = html;
                },
                runCamera: async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                        const video = document.getElementById('cam-video');
                        document.getElementById('cam-box').style.display = 'block';
                        video.srcObject = stream;
                        
                        const btn = document.getElementById('btn-cam');
                        btn.innerText = "Analisando rosto...";
                        btn.disabled = true;
                        setTimeout(() => {
                            stream.getTracks().forEach(t => t.stop());
                            document.getElementById('cam-box').style.display = 'none';
                            document.getElementById('verified-msg').style.display = 'block';
                            btn.style.display = 'none';
                            App.utils.toast('Verifica√ß√£o facial conclu√≠da!', 'success');
                        }, 4000);
                    } catch(e) { App.utils.toast('Erro: Permita acesso √† c√¢mera', 'error'); }
                },
                register: async () => {
                    const email = document.getElementById('reg-email').value.trim();
                    const pass = document.getElementById('reg-pass').value;
                    const name = document.getElementById('reg-name').value.trim();
                    const role = App.state.tempRole;
                    const btn = document.getElementById('btn-final-reg');

                    if(!email || !pass || !name) return App.utils.toast('Preencha os campos corretamente', 'error');
                    
                    // AQUI REMOVI A VALIDA√á√ÉO DO BRASILAPI QUE ESTAVA DANDO 404
                    // A valida√ß√£o do token da loja continua porque √© interna do Supabase

                    try {
                        if (role === 'loja_admin') {
                            const token = document.getElementById('reg-token').value.trim();
                            if (!token) throw new Error("Token de autoriza√ß√£o √© obrigat√≥rio");
                            const { error: tokenError } = await _sb.rpc('validate_store_token', { token_input: token });
                            if (tokenError) throw new Error(tokenError.message);
                        }

                        const { data: newUser, error } = await _sb.from('profiles').insert({
                            nome_completo: name, email: email, password: pass, role: role,
                            cpf: document.getElementById('reg-cpf')?.value || null,
                            cnpj: document.getElementById('reg-cnpj')?.value || null,
                            is_verified: document.getElementById('verified-msg')?.style.display === 'block'
                        }).select().single();

                        if(error) throw error;
                        
                        if(role === 'loja_admin') {
                            await _sb.from('stores').insert({ 
                                admin_id: newUser.id, 
                                nome_loja: document.getElementById('reg-store-name').value, 
                                cnpj: document.getElementById('reg-cnpj').value 
                            });
                        }

                        App.utils.toast('Cadastro realizado com sucesso!', 'success');
                        App.auth.switchView('login');
                    } catch(e) { 
                        App.utils.toast('Erro: ' + e.message, 'error'); 
                    }
                },
                login: async () => {
                    const email = document.getElementById('login-email').value.trim();
                    const pass = document.getElementById('login-pass').value;
                    const { data, error } = await _sb.from('profiles').select('*').eq('email', email).eq('password', pass).maybeSingle();
                    if(error || !data) { App.utils.toast('Dados incorretos', 'error'); } 
                    else { App.state.user = { id: data.id }; App.state.profile = data; localStorage.setItem('logimoveis_session', JSON.stringify(data)); App.utils.toast('Bem-vindo!', 'success'); App.router.renderNav(); App.router.goDashboard(); }
                },
                logout: () => { localStorage.removeItem('logimoveis_session'); location.reload(); }
            },

            store: {
                init: async () => {
                    if (!App.state.user) return;
                    let { data: store } = await _sb.from('stores').select('id').eq('admin_id', App.state.user.id).maybeSingle();
                    if (!store) {
                        const { data: newStore } = await _sb.from('stores').insert({ admin_id: App.state.user.id, nome_loja: 'Minha Loja' }).select().single();
                        store = newStore;
                    }
                    App.state.storeId = store.id;
                    const { data: orders } = await _sb.from('orders').select('*, products(nome), profiles!orders_cliente_id_fkey(nome_completo)').eq('store_id', store.id).order('created_at', { ascending: false });
                    const pending = orders?.filter(o => o.status === 'pendente') || [];
                    const history = orders?.filter(o => o.status !== 'pendente') || [];
                    document.getElementById('store-orders-list').innerHTML = pending.map(o => `
                        <div class="card" style="margin-bottom:1rem; border-left: 4px solid var(--warning);">
                            <div class="badge status-pendente">Aguardando Coleta</div>
                            <h4 style="margin-top:0.5rem">${o.products?.nome}</h4>
                            <p class="text-sm">Cliente: ${o.profiles?.nome_completo}</p>
                            <p class="text-xs text-muted">Destino: ${o.endereco_destino}</p>
                            <button class="btn btn-primary btn-sm btn-full" onclick="App.store.dispatch('${o.id}')">Confirmar e Notificar</button>
                        </div>`).join('') || '<p class="text-sm">Nenhum pedido pendente.</p>';
                    document.getElementById('store-history-list').innerHTML = history.map(o => `<div class="card" style="margin-bottom:0.5rem; padding:10px;"><span class="text-sm font-bold">${o.products?.nome}</span> <span class="badge status-${o.status}">${o.status}</span></div>`).join('') || '<p class="text-xs">Vazio.</p>';
                },
                openAddModal: () => document.getElementById('product-modal').style.display = 'flex',
                submitProduct: async () => {
                    const nome = document.getElementById('new-prod-name').value;
                    const preco = document.getElementById('new-prod-price').value;
                    const file = document.getElementById('new-prod-file').files[0];
                    if (!nome || !preco) return App.utils.toast("Preencha nome e pre√ßo", "error");
                    let imageUrl = 'https://placehold.co/400x300?text=NexLog';
                    if (file) {
                        App.utils.toast("Enviando imagem...", "info");
                        const fileName = `${Date.now()}-${file.name.replace(/\s/g, '_')}`;
                        const { error: upErr } = await _sb.storage.from('produtos').upload(fileName, file);
                        if (!upErr) imageUrl = _sb.storage.from('produtos').getPublicUrl(fileName).data.publicUrl;
                    }
                    const { error } = await _sb.from('products').insert({ store_id: App.state.storeId, nome, preco: parseFloat(preco), imagem_url: imageUrl });
                    if(!error) { App.utils.toast('Produto cadastrado!', 'success'); document.getElementById('product-modal').style.display = 'none'; App.catalog.fetchPublic(); App.store.init(); }
                },
                dispatch: async (id) => {
                    await _sb.from('orders').update({ status: 'aguardando_prestador', data_agendada: new Date().toISOString() }).eq('id', id);
                    App.utils.toast('Despachado!', 'success'); App.store.init();
                }
            },

            payment: {
                open: async (total, orderPayload) => {
                    App.state.pendingPayment = { total, orderPayload };
                    document.getElementById('pay-total-display').innerText = `R$ ${total.toFixed(2)}`;
                    document.getElementById('payment-modal').style.display = 'flex';
                    document.getElementById('payment-brick_container').innerHTML = '';
                    document.getElementById('payment-brick_container').style.display = 'block';
                    const oldPix = document.getElementById('pix-display-area'); if(oldPix) oldPix.remove();
                    App.payment.renderBrick(total);
                },
                close: () => {
                    document.getElementById('payment-modal').style.display = 'none';
                    if (App.state.brickController) App.state.brickController.unmount();
                },
                renderBrick: async (amount) => {
                    // Prote√ß√£o: Valor m√≠nimo de R$ 1,00 para evitar erros no MP
                    if (amount < 1) amount = 1;

                    const builder = mp.bricks();
                    App.state.brickController = await builder.create("payment", "payment-brick_container", {
                        initialization: { 
                            amount: amount, 
                            payer: { 
                                email: App.state.profile.email || 'guest@nexlog.com',
                                // REMOVIDO "entityType" PARA ACEITAR CPF E CNPJ
                            } 
                        },
                        customization: { 
                            paymentMethods: { 
                                ticket: "all", 
                                bankTransfer: "all", 
                                creditCard: "all", 
                                debitCard: "all", 
                                maxInstallments: 3 
                            },
                            visual: {
                                style: {
                                    theme: 'default' // Tema padr√£o √© mais est√°vel
                                }
                            }
                        },
                        callbacks: {
                            onReady: () => { console.log("Brick pronto"); },
                            onError: (error) => {
                                console.error("Erro no Brick:", error);
                                App.utils.toast("Erro no formul√°rio de pagamento.", "error");
                            },
                            onSubmit: async ({ formData }) => {
                                return new Promise((resolve, reject) => {
                                    fetch("/api/pix", { 
                                        method: "POST", 
                                        headers: { "Content-Type": "application/json" }, 
                                        body: JSON.stringify(formData) 
                                    })
                                    .then(async (response) => {
                                        const data = await response.json();
                                        if (!response.ok) {
                                            // Se o backend der erro (500 ou 400), mostramos aqui
                                            console.error("Erro Backend:", data);
                                            App.utils.toast(data.message || "Erro ao processar pagamento", "error");
                                            reject();
                                            return;
                                        }
                                        
                                        if (data.status === 'approved') { 
                                            App.utils.toast("Pagamento Aprovado!", "success"); 
                                            App.payment.finalizeSuccess(); 
                                            resolve(); 
                                        } 
                                        else if (data.status === 'pending' && data.payment_method_id === 'pix') { 
                                            App.payment.showPixScreen(data); 
                                            resolve(); 
                                        }
                                        else { 
                                            App.utils.toast("Pagamento recusado ou em an√°lise.", "warning"); 
                                            reject(); 
                                        }
                                    })
                                    .catch((err) => { 
                                        console.error(err);
                                        App.utils.toast("Erro de conex√£o com o servidor.", "error"); 
                                        reject(); 
                                    });
                                });
                            }
                        }
                    });
                },
                showPixScreen: (data) => {
                    document.getElementById('payment-brick_container').style.display = 'none';
                    const qr = data.point_of_interaction.transaction_data;
                    const div = document.createElement('div'); div.id = 'pix-display-area'; div.style.textAlign='center';
                    div.innerHTML = `
                        <div style="background:#f1f5f9; padding:20px; border-radius:12px; margin-bottom:15px;">
                            <img src="data:image/png;base64,${qr.qr_code_base64}" style="width:200px; height:200px;">
                        </div>
                        <p class="text-xs">Copie e Cole: ${qr.qr_code}</p>
                        <button class="btn btn-success btn-full" onclick="App.payment.finalizeSuccess()">J√° paguei</button>
                    `;
                    document.querySelector('#payment-modal .modal-body').appendChild(div);
                },
                finalizeSuccess: async () => {
                    App.payment.close();
                    const { orderPayload } = App.state.pendingPayment;
                    await _sb.from('orders').insert({ cliente_id: App.state.user.id, product_id: orderPayload.product_id, store_id: orderPayload.store_id, endereco_destino: orderPayload.address, requer_montagem: orderPayload.requer_montagem, taxa_servico: orderPayload.taxa, status: 'pendente' });
                    App.utils.toast('Pedido realizado!', 'success'); App.router.go('cliente'); App.client.init();
                }
            },

            client: {
                init: async () => {
                    const { data: orders } = await _sb.from('orders').select('*, products(nome)').eq('cliente_id', App.state.user.id).order('created_at', {ascending:false});
                    document.getElementById('client-orders-list').innerHTML = orders?.map(o => `
                        <div class="card"><div style="display:flex; justify-content:space-between;"><strong>${o.products?.nome}</strong><span class="badge status-${o.status}">${o.status}</span></div>
                        <p class="text-sm">${o.endereco_destino}</p>
                        ${['em_rota', 'aceito', 'concluido'].includes(o.status) ? `<button class="btn btn-success btn-sm btn-full" onclick="App.map.open('${o.id}', false)">Rastrear</button>` : ''}</div>
                    `).join('') || '<p>Sem pedidos.</p>';
                },
                confirmOrder: async (pid, sid, price) => {
                    if(!App.state.user) { App.router.go('auth'); return; }
                    const address = prompt("Endere√ßo de Entrega Completo:"); // Revertido para Prompt simples
                    if(!address) return;
                    const total = price * 1.15; 
                    App.payment.open(total, { product_id: pid, store_id: sid, basePrice: price, address, requer_montagem: false, taxa: price*0.15 });
                }
            },

            provider: {
                init: async () => {
                    const role = App.state.profile.role;
                    document.getElementById('provider-role-label').innerText = role.toUpperCase();
                    const { data: jobs } = await _sb.from('orders').select('*, products(nome), stores(nome_loja)').or(`status.eq.aguardando_prestador,prestador_id.eq.${App.state.user.id}`);
                    const filtered = (jobs || []).filter(j => j.prestador_id === App.state.user.id || (j.status === 'aguardando_prestador' && (role!=='montador' || j.requer_montagem)));
                    document.getElementById('provider-jobs-list').innerHTML = filtered.map(j => {
                        const isMine = j.prestador_id === App.state.user.id;
                        return `<div class="card" style="${isMine?'border-color:var(--success)':''}"><div style="display:flex; justify-content:space-between;"><span class="badge ${isMine?'status-aceito':'status-pendente'}">${isMine?'ACEITO':'DISPON√çVEL'}</span><strong>R$ ${j.taxa_servico.toFixed(2)}</strong></div><h4>${j.products?.nome}</h4><p class="text-sm">${j.stores?.nome_loja} -> ${j.endereco_destino}</p><hr style="margin:10px 0; border:0; border-top:1px solid #eee;">${!isMine ? `<button class="btn btn-primary btn-full" onclick="App.provider.accept('${j.id}')">Aceitar</button>` : `<button class="btn btn-success btn-full" onclick="App.map.open('${j.id}', true, '${j.endereco_destino}')">Navegar</button>`}</div>`;
                    }).join('') || '<p>Sem servi√ßos.</p>';
                },
                accept: async (id) => { await _sb.from('orders').update({ prestador_id: App.state.user.id, status: 'aceito' }).eq('id', id); App.utils.toast('Aceito!', 'success'); App.provider.init(); }
            },

            map: {
                open: (id, isDriver, addr='') => {
                    App.state.activeOrder = id; document.getElementById('map-modal').style.display='flex';
                    const dest = document.getElementById('map-dest-address'); if(isDriver) { dest.innerHTML=`Destino: ${addr}`; dest.style.display='block'; } else dest.style.display='none';
                    document.getElementById('btn-start-gps').style.display = isDriver ? 'block' : 'none';
                    document.getElementById('btn-end-gps').style.display = 'none';
                    setTimeout(() => {
                        if(!App.state.mapInstance) { 
                            App.state.mapInstance = L.map('map').setView([-23.55, -46.63], 13); 
                            
                            // INTEGRA√á√ÉO MAPBOX (MANTIDA CONFORME PEDIDO)
                            // Se voc√™ n√£o tiver a chave ainda, ele vai usar o OpenStreetMap padr√£o para n√£o quebrar.
                            let tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                            if (CONFIG.mapboxToken.includes('pk.')) {
                                tileUrl = `https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${CONFIG.mapboxToken}`;
                            }
                            L.tileLayer(tileUrl, { attribution: 'Mapbox / OpenStreetMap' }).addTo(App.state.mapInstance); 
                        }
                        App.state.mapInstance.invalidateSize();
                        if(!isDriver) App.map.watchOrder(id);
                    }, 500);
                },
                watchOrder: (id) => {
                    _sb.channel(`track-${id}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${id}` }, (payload) => {
                        const { lat_atual, lng_atual, status } = payload.new;
                        if(status==='em_rota') App.utils.toast('Saiu para entrega!', 'info');
                        if(status==='concluido') { App.utils.toast('Entregue!', 'success'); document.getElementById('map-status-badge').innerText="Conclu√≠do"; }
                        if(lat_atual) App.map.updatePin(lat_atual, lng_atual);
                    }).subscribe();
                },
                startGPS: () => {
                    document.getElementById('btn-start-gps').style.display='none'; document.getElementById('btn-end-gps').style.display='block';
                    _sb.from('orders').update({ status: 'em_rota' }).eq('id', App.state.activeOrder);
                    App.state.watchId = navigator.geolocation.watchPosition(async (pos) => {
                        const { latitude, longitude } = pos.coords; App.map.updatePin(latitude, longitude);
                        await _sb.from('orders').update({ lat_atual: latitude, lng_atual: longitude }).eq('id', App.state.activeOrder);
                    }, e=>console.log(e), {enableHighAccuracy:true});
                },
                finishDelivery: async () => {
                    if(confirm("Finalizar?")) {
                        navigator.geolocation.clearWatch(App.state.watchId);
                        await _sb.from('orders').update({ status: 'concluido' }).eq('id', App.state.activeOrder);
                        App.utils.toast("Finalizado!", "success"); App.map.close(); App.provider.init();
                    }
                },
                updatePin: (lat, lng) => { if(App.state.marker) App.state.marker.setLatLng([lat,lng]); else App.state.marker=L.marker([lat,lng]).addTo(App.state.mapInstance); App.state.mapInstance.setView([lat,lng], 16); },
                close: () => { document.getElementById('map-modal').style.display='none'; if(App.state.watchId) navigator.geolocation.clearWatch(App.state.watchId); _sb.removeAllChannels(); }
            },

            catalog: { fetchPublic: async () => {
                const { data } = await _sb.from('products').select('*, stores(nome_loja)');
                document.getElementById('public-catalog').innerHTML = data?.map(p => `
                    <div class="card">
                        <div style="height:180px; background:#f1f5f9; margin:-1.5rem -1.5rem 1rem -1.5rem; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                            <img src="${p.imagem_url || 'https://placehold.co/400x300?text=Sem+Foto'}" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div class="badge status-aceito" style="margin-bottom:0.5rem">${p.stores?.nome_loja}</div>
                        <h4>${p.nome}</h4><h2>R$ ${p.preco.toFixed(2)}</h2>
                        <button class="btn btn-secondary btn-full" style="margin-top:10px" onclick="App.client.confirmOrder('${p.id}', '${p.store_id}', ${p.preco})">Contratar</button>
                    </div>`).join('') || '<p>Sem ofertas.</p>';
            }},

            utils: {
                toast: (msg, type='success') => { const c = document.getElementById('toast-container'); const e = document.createElement('div'); e.className=`toast ${type}`; e.innerHTML=`<span>${msg}</span>`; c.appendChild(e); setTimeout(()=>e.remove(), 4000); },
                setupPWA: () => { /* ... */ }
            }
        };
        window.addEventListener('load', App.init);
    </script>
</body>
</html>
