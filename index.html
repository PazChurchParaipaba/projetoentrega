<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="NexLog - A revolu√ß√£o na log√≠stica de servi√ßos e entregas r√°pidas.">
    <title>NexLog | Solu√ß√µes Log√≠sticas</title>
    
    <link rel="manifest" id="dynamic-manifest">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/0f172a/white?text=NX">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            /* Paleta NexLog - Mais escura e profissional */
            --primary: #0f172a;       /* Slate 900 */
            --primary-light: #334155; /* Slate 700 */
            --accent: #3b82f6;        /* Blue 500 (Destaques) */
            --secondary: #64748b;     /* Slate 500 */
            
            --surface: #ffffff;
            --background: #f1f5f9;    /* Slate 100 */
            --border: #e2e8f0;
            
            --text-main: #0f172a;
            --text-muted: #64748b;
            
            --success: #10b981;       /* Emerald 500 */
            --success-bg: #d1fae5;
            --warning: #f59e0b;       /* Amber 500 */
            --warning-bg: #fef3c7;
            --danger: #ef4444;        /* Red 500 */
            --danger-bg: #fee2e2;
            --info: #0ea5e9;          /* Sky 500 */
            --info-bg: #e0f2fe;
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --nav-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 90px; /* Espa√ßo para nav mobile */
            overflow-x: hidden;
        }

        /* --- TIPOGRAFIA --- */
        h1, h2, h3, h4 { font-weight: 800; letter-spacing: -0.03em; line-height: 1.1; margin-bottom: 0.5rem; }
        h1 { font-size: 2.2rem; }
        h2 { font-size: 1.8rem; }
        p { color: var(--text-muted); line-height: 1.6; margin-bottom: 1rem; font-size: 0.95rem; }
        
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }
        .text-accent { color: var(--accent); }

        /* --- BOT√ïES --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.875rem 1.5rem; border-radius: var(--radius-sm); 
            font-weight: 600; font-size: 0.95rem; text-decoration: none;
            cursor: pointer; transition: var(--transition); border: none; outline: none; 
            position: relative; overflow: hidden;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-1px); }
        
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: #2563eb; }

        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); background: #f8fafc; }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        /* Bot√£o Social Google */
        .btn-google {
            background: white; color: #333; border: 1px solid #ddd; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-google:hover { background: #f1f5f9; }
        
        .btn-full { width: 100%; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }

        /* --- FORMUL√ÅRIOS --- */
        .input-wrapper { margin-bottom: 1.25rem; text-align: left; }
        .input-wrapper label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        
        .input-field {
            width: 100%; padding: 0.875rem 1rem; border: 2px solid var(--border); border-radius: var(--radius-sm);
            background: white; font-size: 1rem; transition: var(--transition); font-family: inherit; color: var(--text-main);
        }
        .input-field:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); outline: none; }
        
        .input-group { display: flex; gap: 10px; }
        .input-group .input-field { flex: 1; }

        /* --- LAYOUT & CARDS --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
        
        .card {
            background: var(--surface); border-radius: var(--radius-md); padding: 1.5rem;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm); transition: var(--transition);
            position: relative; overflow: hidden; display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--accent); }
        
        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        
        /* --- BADGES & STATUS --- */
        .badge {
            display: inline-flex; align-items: center; padding: 0.35rem 0.85rem; border-radius: 99px;
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .status-pendente { background: var(--warning-bg); color: #b45309; }
        .status-aceito { background: var(--info-bg); color: #0369a1; }
        .status-em_rota { background: #dbeafe; color: #1e40af; animation: pulse 2s infinite; }
        .status-concluido { background: var(--success-bg); color: #15803d; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }

        /* --- HEADER & NAV --- */
        header {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border); padding: 0 5%; height: var(--nav-height);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }
        .brand { font-size: 1.6rem; font-weight: 900; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; letter-spacing: -0.05em; }
        .brand i { font-size: 1.8rem; color: var(--accent); }

        .bottom-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            border-top: 1px solid var(--border); padding: 0.75rem 0; z-index: 900;
            justify-content: space-around; align-items: center; box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 0.7rem; color: var(--text-muted); padding: 0.5rem; cursor: pointer; transition: 0.2s;
        }
        .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--accent); font-weight: 700; transform: translateY(-2px); }
        
        @media (max-width: 768px) {
            .bottom-nav { display: flex; }
            .desktop-only { display: none !important; }
        }

        /* --- SPA VIEW SYSTEM --- */
        .view-section { display: none; animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- AUTH & ROLES --- */
        .auth-card { max-width: 450px; margin: 4rem auto; text-align: center; padding: 3rem; }
        .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem; }
        .role-card {
            border: 2px solid var(--border); border-radius: var(--radius-md); padding: 1.5rem;
            cursor: pointer; transition: var(--transition); display: flex; flex-direction: column; align-items: center; gap: 0.5rem;
            background: white;
        }
        .role-card:hover { border-color: var(--accent); background: var(--info-bg); }
        .role-card i { font-size: 2.5rem; color: var(--primary); }

        /* --- CAMERA & VERIFICATION --- */
        .camera-container {
            background: #000; border-radius: var(--radius-md); overflow: hidden; position: relative;
            aspect-ratio: 4/3; margin-bottom: 1rem; display: none; border: 2px solid var(--accent);
        }
        .camera-container video { width: 100%; height: 100%; object-fit: cover; }
        .camera-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 1rem;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); color: white; text-align: center; font-weight: 600;
        }
        
        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(4px); z-index: 2000;
            display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay[style*="display: flex"] { opacity: 1; }
        
        .modal-content {
            background: white; width: 90%; max-width: 550px; border-radius: var(--radius-lg); overflow: hidden;
            display: flex; flex-direction: column; max-height: 90vh; box-shadow: var(--shadow-lg);
            animation: scaleUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-header { padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: #f8fafc; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); background: #f8fafc; }

        /* Map Specific */
        #map-modal .modal-content { height: 90%; }
        #map { flex: 1; width: 100%; background: #e2e8f0; min-height: 300px; z-index: 1; }

        /* --- TOAST NOTIFICATIONS --- */
        .toast-container { position: fixed; bottom: 100px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast {
            background: white; padding: 1rem 1.5rem; border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px;
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: auto; min-width: 300px;
            border-left: 5px solid var(--primary); font-weight: 500;
        }
        .toast.error { border-left-color: var(--danger); }
        .toast.success { border-left-color: var(--success); }
        .toast.info { border-left-color: var(--info); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- PWA BANNER --- */
        .pwa-banner {
            position: fixed; top: 90px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px;
            background: var(--primary); color: white; padding: 1rem; border-radius: var(--radius-md);
            z-index: 999; display: none; align-items: center; justify-content: space-between; box-shadow: var(--shadow-lg);
        }
        
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>
    
    <div id="pwa-banner" class="pwa-banner">
        <div style="display:flex; align-items:center; gap:12px;">
            <i class="ri-download-cloud-2-line" style="font-size:1.5rem; color:var(--accent)"></i>
            <div>
                <div style="font-weight:bold">Instalar NexLog</div>
                <div style="font-size:0.8rem; opacity:0.8">App mais r√°pido e seguro</div>
            </div>
        </div>
        <button class="btn btn-sm btn-secondary" onclick="App.pwa.install()">Baixar</button>
    </div>

    <header>
        <div class="brand">
            <i class="ri-box-3-fill"></i> NexLog
        </div>
        <div id="header-actions" class="desktop-only"></div>
    </header>

    <main>
        <section id="view-home" class="view-section active">
            <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 5rem 1.5rem; text-align: center; margin-bottom: 3rem; border-radius: 0 0 30px 30px;">
                <div class="container">
                    <span class="badge" style="background:rgba(255,255,255,0.1); color:var(--accent); margin-bottom:1rem;">üöÄ Log√≠stica 4.0</span>
                    <h1 style="font-size: 3rem; margin-bottom: 1.5rem;">Qualquer Servi√ßo.<br><span style="color:var(--accent)">Qualquer Lugar.</span></h1>
                    <p style="max-width: 600px; margin: 0 auto 2.5rem auto; font-size: 1.2rem; color: #94a3b8;">
                        Conecte-se √† maior rede de transporte e servi√ßos especializados do Brasil.
                        Motoristas, montadores e lojas integrados em uma √∫nica plataforma.
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-accent btn-lg" onclick="App.router.go('auth')">Come√ßar Agora</button>
                        <button class="btn btn-secondary btn-lg" style="background:rgba(255,255,255,0.1); border:none; color:white;" onclick="document.getElementById('catalog-anchor').scrollIntoView({behavior:'smooth'})">Explorar Servi√ßos</button>
                    </div>
                </div>
            </div>
            
            <div class="container" id="catalog-anchor">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <div>
                        <h3>Servi√ßos em Destaque</h3>
                        <p class="text-sm">Ofertas verificadas na sua regi√£o</p>
                    </div>
                    <span class="badge status-aceito"><i class="ri-check-double-line"></i> Tempo Real</span>
                </div>
                <div id="public-catalog" class="grid grid-3">
                    <div class="card" style="text-align:center; padding:4rem;">
                        <i class="ri-loader-4-line spin" style="font-size:2.5rem; color:var(--accent)"></i>
                        <p style="margin-top:1rem">Carregando oportunidades...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-auth" class="view-section container">
            <div class="card auth-card">
                <div id="auth-state-login">
                    <div style="margin-bottom:2rem">
                        <i class="ri-user-star-line" style="font-size:3rem; color:var(--primary)"></i>
                        <h2 style="color:var(--primary);">Acesso NexLog</h2>
                        <p>Gerencie entregas e pedidos com seguran√ßa</p>
                    </div>
                    
                    <button class="btn btn-google btn-full" style="margin-bottom:1.5rem;" onclick="App.auth.socialLogin('google')">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                        Entrar com Google
                    </button>
                    
                    <div style="display:flex; align-items:center; margin-bottom:1.5rem;">
                        <div style="flex:1; height:1px; background:var(--border);"></div>
                        <span style="padding:0 10px; font-size:0.8rem; color:var(--text-muted); font-weight:600;">OU EMAIL</span>
                        <div style="flex:1; height:1px; background:var(--border);"></div>
                    </div>

                    <div class="input-wrapper">
                        <label>Endere√ßo de Email</label>
                        <input type="email" id="login-email" class="input-field" placeholder="exemplo@nexlog.com">
                    </div>
                    <div class="input-wrapper">
                        <label>Sua Senha</label>
                        <input type="password" id="login-pass" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn btn-primary btn-full" onclick="App.auth.login()">Acessar Conta</button>
                    
                    <div style="margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border);">
                        <p class="text-xs">Ainda n√£o faz parte?</p>
                        <button class="btn btn-secondary btn-full" onclick="App.auth.switchView('roles')">Criar Conta Gratuita</button>
                    </div>
                </div>
                
                <div id="auth-state-roles" style="display:none;">
                    <h3>Como voc√™ deseja atuar?</h3>
                    <p>Escolha o perfil que melhor se adapta a voc√™</p>
                    <div class="role-grid">
                        <div class="role-card" onclick="App.auth.startReg('cliente')">
                            <i class="ri-user-smile-line"></i><span class="font-bold">Sou Cliente</span>
                            <span class="text-xs text-muted">Quero contratar servi√ßos</span>
                        </div>
                        <div class="role-card" onclick="App.auth.startReg('loja_admin')">
                            <i class="ri-store-2-line"></i><span class="font-bold">Sou Lojista</span>
                            <span class="text-xs text-muted">Quero vender e despachar</span>
                        </div>
                        <div class="role-card" onclick="App.auth.startReg('motorista')">
                            <i class="ri-truck-line"></i><span class="font-bold">Sou Motorista</span>
                            <span class="text-xs text-muted">Tenho ve√≠culo pr√≥prio</span>
                        </div>
                        <div class="role-card" onclick="App.auth.startReg('montador')">
                            <i class="ri-tools-line"></i><span class="font-bold">Sou Prestador</span>
                            <span class="text-xs text-muted">Montagem e servi√ßos</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-full" style="margin-top:2rem" onclick="App.auth.switchView('login')">Voltar ao Login</button>
                </div>

                <div id="auth-state-register" style="display:none;">
                    <h3 id="reg-title">Cadastro</h3>
                    <p>Preencha os dados abaixo para validar seu acesso.</p>
                    <div class="input-wrapper"><label>Nome Completo</label><input type="text" id="reg-name" class="input-field"></div>
                    <div class="input-wrapper"><label>Email</label><input type="email" id="reg-email" class="input-field"></div>
                    <div class="input-wrapper"><label>Senha Segura</label><input type="password" id="reg-pass" class="input-field"></div>
                    
                    <div id="reg-dynamic-fields"></div>
                    
                    <button class="btn btn-primary btn-full" onclick="App.auth.register()" id="btn-final-reg" style="margin-top:1rem;">Finalizar Cadastro</button>
                    <button class="btn btn-secondary btn-full" style="margin-top:0.5rem" onclick="App.auth.switchView('roles')">Voltar</button>
                </div>
            </div>
        </section>

        <section id="view-loja" class="view-section container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <div>
                    <h2>Painel do Lojista</h2>
                    <p>Gerencie estoque e despachos log√≠sticos</p>
                </div>
                <button class="btn btn-primary" onclick="App.store.openAddModal()">
                    <i class="ri-add-box-line"></i> Adicionar Item
                </button>
            </div>
            <div class="grid grid-2">
                <div class="card" style="border-top: 4px solid var(--warning);">
                    <h4 style="margin-bottom:1.5rem; color:var(--primary)">
                        <i class="ri-time-line"></i> Pedidos Pendentes
                    </h4>
                    <div id="store-orders-list">
                        <p class="text-sm">Carregando pedidos...</p>
                    </div>
                </div>
                <div class="card" style="border-top: 4px solid var(--secondary);">
                    <h4 style="margin-bottom:1.5rem; color:var(--text-muted)">
                        <i class="ri-history-line"></i> Hist√≥rico Recente
                    </h4>
                    <div id="store-history-list">
                        <p class="text-sm">Carregando hist√≥rico...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-cliente" class="view-section container">
            <div style="margin-bottom:2rem;">
                <h2>Meus Pedidos</h2>
                <p>Acompanhe em tempo real suas solicita√ß√µes</p>
            </div>
            <div id="client-orders-list" class="grid grid-2"></div>
            <div style="margin-top:3rem; text-align:center;">
                <button class="btn btn-secondary" onclick="App.router.go('home')">
                    <i class="ri-search-line"></i> Buscar Novos Servi√ßos
                </button>
            </div>
        </section>

        <section id="view-provider" class="view-section container">
            <div class="card" style="background:var(--primary); color:white; margin-bottom:2rem; border:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="color:white; margin-bottom:0.2rem;">Central do Parceiro</h3>
                        <p style="color:rgba(255,255,255,0.7); margin:0;" id="provider-role-label">Parceiro</p>
                    </div>
                    <div class="badge status-aceito"><i class="ri-wifi-line"></i> Online</div>
                </div>
            </div>
            <h3>Oportunidades Pr√≥ximas</h3>
            <p>Aceite servi√ßos e inicie a navega√ß√£o.</p>
            <div id="provider-jobs-list" class="grid grid-2"></div>
        </section>
    </main>

    <nav class="bottom-nav" id="mobile-nav"></nav>

    <div id="map-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3>Navega√ß√£o GPS</h3>
                    <p id="map-dest-address" class="text-xs text-muted" style="margin:0; font-family:monospace;"></p>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="App.map.close()">Fechar</button>
            </div>
            <div id="map"></div>
            <div class="modal-footer" id="map-footer">
                <div style="display:flex; gap:1rem; align-items:center; margin-bottom:10px;">
                    <div class="badge status-aceito" id="map-status-badge">Conectado</div>
                    <p style="margin:0; font-size:0.9rem;" id="map-status-text">Sinal GPS ativo...</p>
                </div>
                <button id="btn-start-gps" class="btn btn-success btn-full" style="display:none;" onclick="App.map.startGPS()">
                    <i class="ri-navigation-fill"></i> INICIAR ROTA
                </button>
                <button id="btn-end-gps" class="btn btn-danger btn-full" style="display:none;" onclick="App.map.finishDelivery()">
                    <i class="ri-flag-2-fill"></i> FINALIZAR ENTREGA
                </button>
            </div>
        </div>
    </div>

    <div id="product-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Novo Servi√ßo/Produto</h3>
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('product-modal').style.display='none'">Fechar</button>
            </div>
            <div class="modal-body">
                <div class="input-wrapper">
                    <label>Nome do Item</label>
                    <input type="text" id="new-prod-name" class="input-field" placeholder="Ex: Transporte de Sof√° 3 Lugares">
                </div>
                <div class="input-wrapper">
                    <label>Valor (R$)</label>
                    <input type="number" id="new-prod-price" class="input-field" placeholder="0.00">
                </div>
                <div class="input-wrapper">
                    <label>Foto Ilustrativa</label>
                    <input type="file" id="new-prod-file" class="input-field" accept="image/jpeg, image/png">
                    <p class="text-xs text-muted" style="margin-top:5px">Formatos: JPG ou PNG</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-full" onclick="App.store.submitProduct()">Salvar e Publicar</button>
            </div>
        </div>
    </div>

    <div id="address-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Onde ser√° o servi√ßo?</h3>
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('address-modal').style.display='none'">Cancelar</button>
            </div>
            <div class="modal-body">
                <p>Informe o CEP para buscarmos o endere√ßo.</p>
                <div class="input-wrapper">
                    <label>CEP</label>
                    <div class="input-group">
                        <input type="text" id="addr-cep" class="input-field" placeholder="00000-000" maxlength="9">
                        <button class="btn btn-secondary" onclick="App.utils.fetchAddress()">
                            <i class="ri-search-line"></i> Buscar
                        </button>
                    </div>
                </div>
                <div class="input-wrapper">
                    <label>Rua / Logradouro</label>
                    <input type="text" id="addr-street" class="input-field" readonly style="background:#f8fafc;">
                </div>
                <div class="input-wrapper" style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>N√∫mero</label>
                        <input type="text" id="addr-num" class="input-field" placeholder="N¬∫">
                    </div>
                    <div style="flex:2">
                        <label>Bairro</label>
                        <input type="text" id="addr-neighbor" class="input-field" readonly style="background:#f8fafc;">
                    </div>
                </div>
                <div class="input-wrapper">
                    <label>Cidade/UF</label>
                    <input type="text" id="addr-city" class="input-field" readonly style="background:#f8fafc;">
                </div>
                
                <div id="addr-loading" style="display:none; color:var(--accent); text-align:center; margin-top:10px;">
                    <i class="ri-loader-4-line spin"></i> Consultando BrasilAPI...
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-full" onclick="App.client.finalizeAddress()">Confirmar Endere√ßo</button>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pagamento Seguro</h3>
                <button class="btn btn-secondary btn-sm" onclick="App.payment.close()">Cancelar</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:1.5rem; padding: 1rem; background: var(--info-bg); border-radius: var(--radius-sm);">
                    <p style="margin-bottom:0.5rem; color:var(--primary);">Total do Pedido</p>
                    <h2 id="pay-total-display" style="color:var(--primary); font-size:2.5rem; margin-bottom:0;">R$ 0,00</h2>
                    <p class="text-xs text-muted" id="pay-detail-display" style="margin-top:0.5rem;">Inclui taxas de servi√ßo</p>
                </div>
                
                <div id="payment-brick_container"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO GERAL ---
        const CONFIG = {
            // Backend Supabase
            sbUrl: 'https://groezaseypdbpgymgpvo.supabase.co',
            sbKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdyb2V6YXNleXBkYnBneW1ncHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNjkxNjYsImV4cCI6MjA4MTY0NTE2Nn0.5U5QeoGmZn_i9Y8POoUCkatBUAdSW-cjHRyfxpm_pyM',
            
            // Mercado Pago (Teste - Trocar para Produ√ß√£o ao lan√ßar)
            mpPublicKey: 'TEST-ab3c1f5e-2e9c-4489-93d4-3ec6fc1599b3',
            
            // Mapbox Token (Substitua pelo seu token real da Mapbox)
            // Se vazio, usar√° OpenStreetMap padr√£o.
            mapboxToken: 'pk.eyJ1IjoiZXhhbXBsZXVzZXIiLCJhIjoiY2p5Y3Z6eG9jMDFlazNnbzQ4a3R4bWk4ZyJ9.ExampleTokenPlaceholder' 
        };
        
        // Inicializa√ß√£o de Bibliotecas
        const _sb = supabase.createClient(CONFIG.sbUrl, CONFIG.sbKey);
        const mp = new MercadoPago(CONFIG.mpPublicKey);

        // --- APLICA√á√ÉO PRINCIPAL ---
        const App = {
            state: {
                user: null, 
                profile: null, 
                tempRole: null, 
                deferredPrompt: null,
                mapInstance: null, 
                marker: null, 
                watchId: null, 
                activeOrder: null, 
                storeId: null,
                pendingPayment: null, 
                brickController: null,
                tempOrderData: null // Armazena dados do pedido enquanto preenche endere√ßo
            },
            
            // Inicializa√ß√£o do App
            init: async () => {
                App.utils.setupPWA();
                
                // Verifica sess√£o local e Supabase
                const savedUser = localStorage.getItem('logimoveis_session');
                const { data: { session } } = await _sb.auth.getSession();
                
                if (session || savedUser) {
                    // L√≥gica para recuperar perfil completo se logado via Social
                    if(session && !savedUser) {
                        const { data: profile } = await _sb.from('profiles').select('*').eq('id', session.user.id).maybeSingle();
                        if(profile) {
                            App.state.user = { id: profile.id };
                            App.state.profile = profile;
                            localStorage.setItem('logimoveis_session', JSON.stringify(profile));
                        } else {
                            // Usu√°rio novo via Google -> precisa definir Role
                            App.utils.toast("Bem-vindo! Por favor, finalize seu cadastro escolhendo um perfil.", "info");
                            App.router.go('auth');
                            App.auth.switchView('roles');
                            return;
                        }
                    } else {
                        const profile = JSON.parse(savedUser);
                        App.state.user = { id: profile.id };
                        App.state.profile = profile;
                    }
                    App.router.renderNav();
                    App.router.goDashboard();
                } else {
                    App.router.renderNav();
                    App.catalog.fetchPublic();
                }
            },

            // PWA Install Logic
            pwa: {
                install: () => {
                    if (App.state.deferredPrompt) {
                        App.state.deferredPrompt.prompt();
                        App.state.deferredPrompt.userChoice.then(() => {
                            App.state.deferredPrompt = null;
                            document.getElementById('pwa-banner').style.display = 'none';
                        });
                    }
                }
            },

            // Sistema de Rotas (SPA)
            router: {
                go: (viewId) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                    document.getElementById(`view-${viewId}`).classList.add('active');
                    window.scrollTo(0,0);
                    App.router.renderNav();
                    
                    if(viewId === 'home') App.catalog.fetchPublic();
                },
                renderNav: () => {
                    const header = document.getElementById('header-actions');
                    const mobile = document.getElementById('mobile-nav');
                    
                    if(App.state.user && App.state.profile) {
                        header.innerHTML = `
                            <div style="display:flex; align-items:center; gap:1rem;">
                                <div class="text-xs text-muted desktop-only">Ol√°, ${App.state.profile.nome_completo.split(' ')[0]}</div>
                                <button class="btn btn-secondary btn-sm" onclick="App.router.goDashboard()">Painel</button>
                                <button class="btn btn-danger btn-sm" onclick="App.auth.logout()">Sair</button>
                            </div>
                        `;
                        mobile.innerHTML = `
                            <div class="nav-item" onclick="App.router.go('home')"><i class="ri-store-2-line"></i><span>In√≠cio</span></div>
                            <div class="nav-item active" onclick="App.router.goDashboard()"><i class="ri-dashboard-line"></i><span>Painel</span></div>
                            <div class="nav-item" onclick="App.auth.logout()"><i class="ri-logout-box-r-line"></i><span>Sair</span></div>
                        `;
                    } else {
                        header.innerHTML = `<button class="btn btn-primary btn-sm" onclick="App.router.go('auth')">Entrar / Criar Conta</button>`;
                        mobile.innerHTML = `
                            <div class="nav-item active" onclick="App.router.go('home')"><i class="ri-home-line"></i><span>Home</span></div>
                            <div class="nav-item" onclick="App.router.go('auth')"><i class="ri-user-line"></i><span>Entrar</span></div>
                        `;
                    }
                },
                goDashboard: () => {
                    const role = App.state.profile?.role;
                    if(role === 'loja_admin') { App.store.init(); App.router.go('loja'); }
                    else if(role === 'cliente') { App.client.init(); App.router.go('cliente'); }
                    else if(role === 'motorista' || role === 'montador') { App.provider.init(); App.router.go('provider'); }
                    else App.router.go('home');
                }
            },

            // Sistema de Autentica√ß√£o
            auth: {
                switchView: (view) => {
                    ['login', 'roles', 'register'].forEach(v => document.getElementById(`auth-state-${v}`).style.display = 'none');
                    document.getElementById(`auth-state-${view}`).style.display = 'block';
                },
                
                // Login com Google
                socialLogin: async (provider) => {
                    const { data, error } = await _sb.auth.signInWithOAuth({
                        provider: provider,
                        options: { redirectTo: window.location.href }
                    });
                    if(error) App.utils.toast("Erro ao conectar com provedor social", "error");
                },

                startReg: (role) => {
                    App.state.tempRole = role;
                    document.getElementById('reg-title').innerText = `Cadastro - ${role === 'loja_admin' ? 'Lojista' : role.toUpperCase()}`;
                    App.auth.switchView('register');
                    
                    const container = document.getElementById('reg-dynamic-fields');
                    let html = '';
                    
                    if(role === 'loja_admin') {
                        // Campo de Token de Seguran√ßa da Loja
                        html = `
                            <div class="input-wrapper"><label>Nome da Loja</label><input id="reg-store-name" class="input-field" placeholder="Ex: NexLog Center"></div>
                            <div class="input-wrapper"><label>CNPJ</label><input id="reg-cnpj" class="input-field" placeholder="00.000.000/0000-00"></div>
                            <div class="input-wrapper" style="border: 2px dashed var(--primary); padding: 10px; border-radius: 8px; background: var(--info-bg);">
                                <label style="color:var(--primary)">üîë Token de Autoriza√ß√£o</label>
                                <input id="reg-token" class="input-field" placeholder="C√≥digo fornecido pelo Admin">
                                <p class="text-xs text-muted">Cadastro de lojista √© restrito.</p>
                            </div>
                        `;
                    } else if (role === 'motorista') {
                        // Valida√ß√£o Facial
                        html = `
                            <div class="input-wrapper"><label>CPF (Valida√ß√£o na Receita)</label><input id="reg-cpf" class="input-field" placeholder="000.000.000-00"></div>
                            <div class="camera-container" id="cam-box"><video id="cam-video" autoplay playsinline></video><div class="camera-overlay">Posicione seu rosto</div></div>
                            <div id="verified-msg" style="display:none; color:var(--success); font-weight:bold; margin-bottom:1rem; text-align:center;">‚úÖ Identidade Confirmada</div>
                            <button class="btn btn-secondary btn-full" id="btn-cam" onclick="App.auth.runCamera()">Validar Identidade (Biometria)</button>
                        `;
                    } else if (role === 'cliente') {
                         html = `<div class="input-wrapper"><label>CPF</label><input id="reg-cpf" class="input-field" placeholder="000.000.000-00"></div>`;
                    }
                    container.innerHTML = html;
                },

                runCamera: async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                        const video = document.getElementById('cam-video');
                        document.getElementById('cam-box').style.display = 'block';
                        video.srcObject = stream;
                        
                        const btn = document.getElementById('btn-cam');
                        btn.innerText = "Analisando rosto...";
                        btn.disabled = true;
                        
                        // Simula√ß√£o de IA analisando rosto
                        setTimeout(() => {
                            stream.getTracks().forEach(t => t.stop());
                            document.getElementById('cam-box').style.display = 'none';
                            document.getElementById('verified-msg').style.display = 'block';
                            btn.style.display = 'none';
                            App.utils.toast('Biometria facial conclu√≠da!', 'success');
                        }, 3000);
                    } catch(e) { App.utils.toast('Erro: Permita acesso √† c√¢mera', 'error'); }
                },

                register: async () => {
                    const email = document.getElementById('reg-email').value.trim();
                    const pass = document.getElementById('reg-pass').value;
                    const name = document.getElementById('reg-name').value.trim();
                    const role = App.state.tempRole;
                    const btn = document.getElementById('btn-final-reg');

                    if(!email || !pass || !name) return App.utils.toast('Preencha todos os campos obrigat√≥rios', 'error');
                    
                    btn.disabled = true;
                    btn.innerText = "Validando dados...";

                    try {
                        // 1. Valida√ß√£o de Token (Loja)
                        if (role === 'loja_admin') {
                            const token = document.getElementById('reg-token').value.trim();
                            if (!token) throw new Error("Token de autoriza√ß√£o √© obrigat√≥rio");
                            
                            // Chama fun√ß√£o RPC segura no Supabase
                            const { error: tokenError } = await _sb.rpc('validate_store_token', { token_input: token });
                            if (tokenError) throw new Error("Token inv√°lido ou j√° utilizado.");
                        }

                        // 2. Valida√ß√£o de CPF (BrasilAPI)
                        const cpfInput = document.getElementById('reg-cpf');
                        if (cpfInput) {
                            const cpf = cpfInput.value.replace(/\D/g, '');
                            if (cpf.length !== 11) throw new Error("CPF deve ter 11 d√≠gitos");

                            // Consulta API externa
                            const res = await fetch(`https://brasilapi.com.br/api/v1/cpf/${cpf}`);
                            if (res.status === 404) throw new Error("CPF n√£o encontrado na base oficial.");
                            // Nota: A BrasilAPI gratuita tem limites, use com sabedoria.
                        }

                        // 3. Cria√ß√£o de Usu√°rio
                        const { data: authData, error: authErr } = await _sb.auth.signUp({ email, password: pass });
                        if(authErr) throw authErr;

                        // 4. Cria√ß√£o do Perfil
                        const { error } = await _sb.from('profiles').insert({
                            id: authData.user.id, // Vincula com ID de Auth
                            nome_completo: name, email, role,
                            cpf: document.getElementById('reg-cpf')?.value || null,
                            cnpj: document.getElementById('reg-cnpj')?.value || null,
                            is_verified: true // Simplifica√ß√£o para o demo
                        });
                        if(error) throw error;

                        if(role === 'loja_admin') {
                            await _sb.from('stores').insert({ 
                                admin_id: authData.user.id, 
                                nome_loja: document.getElementById('reg-store-name').value,
                                cnpj: document.getElementById('reg-cnpj').value
                            });
                        }

                        App.utils.toast('Cadastro realizado! Fa√ßa login.', 'success');
                        App.auth.switchView('login');
                    } catch(e) { 
                        App.utils.toast('Erro: ' + e.message, 'error'); 
                    } finally {
                        btn.disabled = false;
                        btn.innerText = "Finalizar Cadastro";
                    }
                },

                login: async () => {
                    const email = document.getElementById('login-email').value;
                    const pass = document.getElementById('login-pass').value;
                    
                    const { data, error } = await _sb.auth.signInWithPassword({ email, password: pass });
                    if(error) return App.utils.toast('Email ou senha incorretos', 'error');
                    
                    // Busca perfil adicional
                    const { data: profile } = await _sb.from('profiles').select('*').eq('id', data.user.id).single();
                    
                    if(profile) {
                        App.state.user = { id: profile.id };
                        App.state.profile = profile;
                        localStorage.setItem('logimoveis_session', JSON.stringify(profile));
                        App.utils.toast('Bem-vindo de volta!', 'success');
                        App.router.renderNav();
                        App.router.goDashboard();
                    } else {
                        App.utils.toast('Erro ao carregar perfil.', 'error');
                    }
                },

                logout: async () => {
                    await _sb.auth.signOut();
                    localStorage.removeItem('logimoveis_session');
                    location.reload();
                }
            },

            // Gest√£o da Loja
            store: {
                init: async () => {
                    if (!App.state.user) return;
                    // Garante que a loja existe
                    let { data: store } = await _sb.from('stores').select('id').eq('admin_id', App.state.user.id).maybeSingle();
                    if (!store) {
                        const { data: ns } = await _sb.from('stores').insert({ admin_id: App.state.user.id, nome_loja: 'Minha Loja' }).select().single();
                        store = ns;
                    }
                    App.state.storeId = store.id;
                    
                    // Busca Pedidos
                    const { data: orders } = await _sb.from('orders').select('*, products(nome), profiles!orders_cliente_id_fkey(nome_completo)').eq('store_id', store.id).order('created_at', { ascending: false });
                    
                    const pending = orders?.filter(o => o.status === 'pendente') || [];
                    const history = orders?.filter(o => o.status !== 'pendente') || [];
                    
                    document.getElementById('store-orders-list').innerHTML = pending.map(o => `
                        <div class="card" style="margin-bottom:1rem; border-left: 4px solid var(--warning);">
                            <div class="badge status-pendente">Aguardando Despacho</div>
                            <h4 style="margin-top:0.5rem">${o.products?.nome}</h4>
                            <p class="text-sm">Cliente: ${o.profiles?.nome_completo}</p>
                            <p class="text-xs text-muted"><i class="ri-map-pin-line"></i> ${o.endereco_destino}</p>
                            <button class="btn btn-primary btn-sm btn-full" onclick="App.store.dispatch('${o.id}')">Liberar para Motoristas</button>
                        </div>`).join('') || '<p class="text-sm">Nenhum pedido pendente.</p>';

                    document.getElementById('store-history-list').innerHTML = history.map(o => `
                        <div class="card" style="margin-bottom:0.5rem; padding:10px; opacity:0.8;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span class="text-sm font-bold">${o.products?.nome}</span>
                                <span class="badge status-${o.status}">${o.status}</span>
                            </div>
                        </div>`).join('') || '<p class="text-xs">Hist√≥rico vazio.</p>';
                },
                openAddModal: () => document.getElementById('product-modal').style.display='flex',
                submitProduct: async () => {
                    const nome = document.getElementById('new-prod-name').value;
                    const preco = document.getElementById('new-prod-price').value;
                    const file = document.getElementById('new-prod-file').files[0];
                    
                    if (!nome || !preco) return App.utils.toast("Preencha nome e pre√ßo", "error");
                    
                    let imageUrl = 'https://placehold.co/400x300?text=NexLog+Item';
                    
                    if (file) {
                        App.utils.toast("Enviando imagem...", "info");
                        const fileName = `${Date.now()}-${file.name.replace(/\s/g, '_')}`;
                        const { error: upErr } = await _sb.storage.from('produtos').upload(fileName, file);
                        if (!upErr) {
                            imageUrl = _sb.storage.from('produtos').getPublicUrl(fileName).data.publicUrl;
                        }
                    }
                    
                    await _sb.from('products').insert({ store_id: App.state.storeId, nome, preco: parseFloat(preco), imagem_url: imageUrl });
                    App.utils.toast('Produto publicado!', 'success');
                    document.getElementById('product-modal').style.display = 'none';
                    App.store.init();
                },
                dispatch: async (id) => {
                    await _sb.from('orders').update({ status: 'aguardando_prestador', data_agendada: new Date().toISOString() }).eq('id', id);
                    App.utils.toast('Pedido liberado para rede de parceiros!', 'success');
                    App.store.init();
                }
            },

            // Fluxo do Cliente
            client: {
                init: async () => {
                    const { data: orders } = await _sb.from('orders').select('*, products(nome)').eq('cliente_id', App.state.user.id).order('created_at', {ascending:false});
                    document.getElementById('client-orders-list').innerHTML = orders?.map(o => `
                        <div class="card">
                            <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                                <strong>${o.products?.nome}</strong>
                                <span class="badge status-${o.status}">${o.status}</span>
                            </div>
                            <p class="text-sm"><i class="ri-map-pin-line"></i> ${o.endereco_destino}</p>
                            ${['em_rota', 'aceito', 'concluido'].includes(o.status) ? 
                                `<button class="btn btn-success btn-full btn-sm" onclick="App.map.open('${o.id}', false)">üìç Rastrear em Tempo Real</button>` : ''}
                        </div>
                    `).join('') || '<p>Voc√™ ainda n√£o fez pedidos.</p>';
                },
                
                // Passo 1: Iniciar Pedido e Pedir Endere√ßo
                confirmOrder: async (pid, sid, price) => {
                    if(!App.state.user) { App.router.go('auth'); return; }
                    
                    App.state.tempOrderData = { pid, sid, price };
                    
                    // Abre Modal de Endere√ßo (BrasilAPI)
                    document.getElementById('address-modal').style.display = 'flex';
                },
                
                // Passo 2: Finalizar endere√ßo e abrir pagamento
                finalizeAddress: () => {
                    const street = document.getElementById('addr-street').value;
                    const num = document.getElementById('addr-num').value;
                    const neighbor = document.getElementById('addr-neighbor').value;
                    const city = document.getElementById('addr-city').value;
                    
                    if(!street || !num || !city) return App.utils.toast("Endere√ßo incompleto", "error");
                    
                    const fullAddress = `${street}, ${num} - ${neighbor}, ${city}`;
                    document.getElementById('address-modal').style.display = 'none';
                    
                    const { pid, sid, price } = App.state.tempOrderData;
                    
                    // C√°lculo de taxas
                    const total = price * 1.15; // 15% taxa plataforma
                    
                    App.payment.open(total, { 
                        product_id: pid, store_id: sid, basePrice: price, 
                        address: fullAddress, requer_montagem: false, taxa: price*0.15 
                    });
                }
            },

            // Fluxo do Motorista/Prestador
            provider: {
                init: async () => {
                    const { data: jobs } = await _sb.from('orders').select('*, products(nome), stores(nome_loja)').or(`status.eq.aguardando_prestador,prestador_id.eq.${App.state.user.id}`);
                    const filtered = (jobs || []).filter(j => j.prestador_id === App.state.user.id || j.status === 'aguardando_prestador');
                    
                    document.getElementById('provider-jobs-list').innerHTML = filtered.map(j => {
                        const isMine = j.prestador_id === App.state.user.id;
                        return `
                            <div class="card" style="${isMine ? 'border-color:var(--success); border-left:5px solid var(--success);' : ''}">
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                    <span class="badge ${isMine ? 'status-aceito' : 'status-pendente'}">${isMine ? 'ACEITO' : 'NOVA OFERTA'}</span>
                                    <strong style="color:var(--success)">R$ ${j.taxa_servico.toFixed(2)}</strong>
                                </div>
                                <h4>${j.products?.nome}</h4>
                                <p class="text-sm"><i class="ri-store-line"></i> ${j.stores?.nome_loja} <br> <i class="ri-arrow-down-line"></i> <br> <i class="ri-map-pin-line"></i> ${j.endereco_destino}</p>
                                <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
                                ${!isMine ? 
                                    `<button class="btn btn-primary btn-full" onclick="App.provider.accept('${j.id}')">Aceitar Corrida</button>` 
                                    : 
                                    `<button class="btn btn-success btn-full" onclick="App.map.open('${j.id}', true, '${j.endereco_destino}')">
                                        <i class="ri-navigation-line"></i> Navegar
                                     </button>`}
                            </div>`;
                    }).join('') || '<p>Nenhuma oportunidade no momento.</p>';
                },
                accept: async (id) => {
                    await _sb.from('orders').update({ prestador_id: App.state.user.id, status: 'aceito' }).eq('id', id);
                    
                    // --- SIMULA√á√ÉO DE NOTIFICA√á√ÉO POR EMAIL (RESEND) ---
                    console.log(`[NexLog] Disparando email via Resend para cliente do pedido ${id}...`);
                    App.utils.toast('Servi√ßo aceito! Cliente notificado por e-mail.', 'success');
                    
                    App.provider.init();
                }
            },

            // Mapa e GPS
            map: {
                open: (id, isDriver, addr='') => {
                    App.state.activeOrder = id;
                    document.getElementById('map-modal').style.display='flex';
                    const dest = document.getElementById('map-dest-address');
                    if(isDriver) { dest.innerHTML=`Destino: ${addr}`; dest.style.display='block'; } else dest.style.display='none';
                    
                    document.getElementById('btn-start-gps').style.display = isDriver ? 'block' : 'none';
                    document.getElementById('btn-end-gps').style.display = 'none';

                    setTimeout(() => {
                        if(!App.state.mapInstance) {
                            App.state.mapInstance = L.map('map').setView([-23.5505, -46.6333], 13);
                            
                            // --- INTEGRA√á√ÉO MAPBOX ---
                            // Se tiver token, usa Mapbox. Se n√£o, usa OpenStreetMap
                            let tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                            if (CONFIG.mapboxToken && !CONFIG.mapboxToken.includes('Placeholder')) {
                                tileUrl = `https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${CONFIG.mapboxToken}`;
                            }
                            
                            L.tileLayer(tileUrl, {
                                attribution: '¬© Mapbox ¬© OpenStreetMap',
                                tileSize: 512, zoomOffset: -1
                            }).addTo(App.state.mapInstance);
                        }
                        App.state.mapInstance.invalidateSize();
                        if(!isDriver) App.map.watchOrder(id);
                    }, 500);
                },
                watchOrder: (id) => {
                    _sb.channel(`track-${id}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${id}` }, (payload) => {
                        const { lat_atual, lng_atual, status } = payload.new;
                        if(status==='em_rota') App.utils.toast('Motorista saiu para entrega!', 'info');
                        if(status==='concluido') { App.utils.toast('Entregue com sucesso!', 'success'); document.getElementById('map-status-badge').innerText="Finalizado"; }
                        if(lat_atual) App.map.updatePin(lat_atual, lng_atual);
                    }).subscribe();
                },
                startGPS: () => {
                    document.getElementById('btn-start-gps').style.display='none'; document.getElementById('btn-end-gps').style.display='block';
                    _sb.from('orders').update({ status: 'em_rota' }).eq('id', App.state.activeOrder);
                    App.state.watchId = navigator.geolocation.watchPosition(async (pos) => {
                        const { latitude, longitude } = pos.coords;
                        App.map.updatePin(latitude, longitude);
                        await _sb.from('orders').update({ lat_atual: latitude, lng_atual: longitude }).eq('id', App.state.activeOrder);
                    }, e=>console.log(e), {enableHighAccuracy:true});
                },
                finishDelivery: async () => {
                    if(confirm("Confirmar entrega no destino?")) {
                        navigator.geolocation.clearWatch(App.state.watchId);
                        await _sb.from('orders').update({ status: 'concluido' }).eq('id', App.state.activeOrder);
                        App.utils.toast("Servi√ßo finalizado!", "success"); App.map.close(); App.provider.init();
                    }
                },
                updatePin: (lat, lng) => { 
                    if(App.state.marker) App.state.marker.setLatLng([lat,lng]); 
                    else App.state.marker=L.marker([lat,lng]).addTo(App.state.mapInstance); 
                    App.state.mapInstance.setView([lat,lng], 16); 
                },
                close: () => { document.getElementById('map-modal').style.display='none'; if(App.state.watchId) navigator.geolocation.clearWatch(App.state.watchId); _sb.removeAllChannels(); }
            },

            // Cat√°logo P√∫blico
            catalog: { 
                fetchPublic: async () => {
                    const { data } = await _sb.from('products').select('*, stores(nome_loja)');
                    document.getElementById('public-catalog').innerHTML = data?.map(p => `
                        <div class="card">
                            <div style="height:180px; background:#f1f5f9; margin:-1.5rem -1.5rem 1rem -1.5rem; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                <img src="${p.imagem_url}" style="width:100%; height:100%; object-fit:cover;">
                            </div>
                            <div class="badge status-aceito" style="margin-bottom:0.5rem">${p.stores?.nome_loja}</div>
                            <h4>${p.nome}</h4>
                            <h2 style="color:var(--primary)">R$ ${p.preco.toFixed(2)}</h2>
                            <button class="btn btn-secondary btn-full" style="margin-top:1rem" onclick="App.client.confirmOrder('${p.id}', '${p.store_id}', ${p.preco})">Solicitar Servi√ßo</button>
                        </div>`).join('') || '<p>Nenhum servi√ßo dispon√≠vel.</p>';
                }
            },

            // Pagamento
            payment: {
                open: async (total, orderPayload) => {
                    App.state.pendingPayment = { total, orderPayload };
                    document.getElementById('pay-total-display').innerText = `R$ ${total.toFixed(2)}`;
                    document.getElementById('payment-modal').style.display = 'flex';
                    document.getElementById('payment-brick_container').innerHTML = '';
                    document.getElementById('payment-brick_container').style.display = 'block';
                    const oldPix = document.getElementById('pix-display-area'); if(oldPix) oldPix.remove();
                    App.payment.renderBrick(total);
                },
                close: () => {
                    document.getElementById('payment-modal').style.display = 'none';
                    if (App.state.brickController) App.state.brickController.unmount();
                },
                renderBrick: async (amount) => {
                    const builder = mp.bricks();
                    App.state.brickController = await builder.create("payment", "payment-brick_container", {
                        initialization: { amount: amount, payer: { email: App.state.profile.email } },
                        customization: { paymentMethods: { ticket: "all", bankTransfer: "all", creditCard: "all", debitCard: "all", maxInstallments: 3 } },
                        callbacks: {
                            onSubmit: async ({ formData }) => {
                                return new Promise((resolve, reject) => {
                                    fetch("/api/pix", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(formData) })
                                    .then(r => r.json())
                                    .then(data => {
                                        if(data.status === 'approved') { App.utils.toast("Pagamento Aprovado!", "success"); App.payment.finalizeSuccess(); resolve(); }
                                        else if (data.status === 'pending' && data.payment_method_id === 'pix') { App.payment.showPix(data); resolve(); }
                                        else { App.utils.toast("Erro no pagamento", "error"); reject(); }
                                    }).catch(() => { App.utils.toast("Erro de conex√£o", "error"); reject(); });
                                });
                            }
                        }
                    });
                },
                showPix: (data) => {
                    document.getElementById('payment-brick_container').style.display = 'none';
                    const qr = data.point_of_interaction.transaction_data;
                    const div = document.createElement('div'); div.id = 'pix-display-area'; div.style.textAlign='center';
                    div.innerHTML = `
                        <div style="background:#f1f5f9; padding:20px; border-radius:12px; margin-bottom:15px;">
                            <img src="data:image/png;base64,${qr.qr_code_base64}" style="width:200px; height:200px; border:2px solid #e2e8f0; border-radius:8px;">
                        </div>
                        <p class="text-xs text-muted">Copie o c√≥digo abaixo:</p>
                        <textarea class="input-field" style="font-size:0.8rem; height:60px; margin-bottom:10px;" readonly>${qr.qr_code}</textarea>
                        <button class="btn btn-success btn-full" onclick="App.payment.finalizeSuccess()"><i class="ri-check-double-line"></i> J√° realizei o pagamento</button>
                    `;
                    document.querySelector('#payment-modal .modal-body').appendChild(div);
                },
                finalizeSuccess: async () => {
                    App.payment.close();
                    const { orderPayload } = App.state.pendingPayment;
                    await _sb.from('orders').insert({ cliente_id: App.state.user.id, product_id: orderPayload.product_id, store_id: orderPayload.store_id, endereco_destino: orderPayload.address, requer_montagem: orderPayload.requer_montagem, taxa_servico: orderPayload.taxa, status: 'pendente' });
                    App.utils.toast('Pedido realizado com sucesso!', 'success'); App.router.go('cliente'); App.client.init();
                }
            },

            utils: {
                toast: (msg, type='success') => { const c = document.getElementById('toast-container'); const e = document.createElement('div'); e.className=`toast ${type}`; e.innerHTML=`<i class="ri-${type==='success'?'checkbox-circle':type==='error'?'error-warning':'notification'}-line"></i> <span>${msg}</span>`; c.appendChild(e); setTimeout(()=>e.remove(), 4000); },
                
                // Integra√ß√£o BrasilAPI
                fetchAddress: async () => {
                    const cep = document.getElementById('addr-cep').value.replace(/\D/g, '');
                    if(cep.length !== 8) return App.utils.toast("CEP inv√°lido", "error");
                    
                    document.getElementById('addr-loading').style.display = 'block';
                    try {
                        const res = await fetch(`https://brasilapi.com.br/api/cep/v2/${cep}`);
                        if(!res.ok) throw new Error("CEP n√£o encontrado");
                        const data = await res.json();
                        
                        document.getElementById('addr-street').value = data.street;
                        document.getElementById('addr-neighbor').value = data.neighborhood;
                        document.getElementById('addr-city').value = `${data.city}/${data.state}`;
                        document.getElementById('addr-num').focus();
                    } catch(e) {
                        App.utils.toast("Erro ao buscar endere√ßo", "error");
                    } finally {
                        document.getElementById('addr-loading').style.display = 'none';
                    }
                },
                
                setupPWA: () => { /* ... */ }
            }
        };
        window.addEventListener('load', App.init);
    </script>
</body>
</html>
